"use strict";app.controller("groupCommunityCtrl",function($scope,$timeout,utils,$http,$modal,toaster,$location,$state){function getSideCircle(){$http.post(app.url.community.getByGroupCircle,{access_token:app.url.access_token,groupId:app.url.groupId}).success(function(data,status,headers,config){1==data.resultCode?$scope.circleSideList=data.data:toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")})}var dataPostTable;$scope.groupName=localStorage.getItem("curGroupName"),$scope.searchKeyword="",$scope.isPostList=!0;var postListApi=app.url.community.findPcTopicList,postSearchApi=app.url.community.findTopicKeyWord;getSideCircle(),$scope.initPostListTable=function(circle,type){var postListParam={access_token:app.url.access_token,groupId:app.url.groupId,circleId:"",pageIndex:0,pageSize:20};$scope.isPostList=!0,circle?($scope.carActiveId=circle.id,postListParam.circleId=circle.id,$scope.searchKeyword=""):type||($scope.carActiveId="allCarg",postListParam.circleId="",$scope.searchKeyword=""),"search"==type&&(postListParam.keyWord=$scope.searchKeyword,$scope.carActiveId&&"allCarg"!=$scope.carActiveId&&(postListParam.circleId=$scope.carActiveId)),"search"!=type&&delete postListParam.keyWord;var index=0,length=20,start=0,size=10,setTable=function(){dataPostTable=$("#postListTable").DataTable({language:app.lang.datatables.translation,searching:!1,sScrollX:"100%",sScrollXInner:"110%",destroy:!0,lengthChange:!0,ordering:!1,draw:index,pageLength:length,lengthMenu:[10,20,50,100],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:"search"==type?postSearchApi:postListApi,fnServerData:function(sSource,aoData,fnCallback){$.ajax({type:"post",url:sSource,dataType:"json",data:postListParam,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else toaster.pop("error","",resp.resultMsg)}})},columns:[{data:"title",render:function(set,status,dt){return""==dt.title?'<i id="goDetail"><无标题></i>':'<span id="goDetail">'+dt.title+"</span>"}},{data:"createName",className:"text-center td-text-ellipsis",render:function(set,status,dt){return void 0==dt.createName?"--":dt.createName}},{data:"likeCount",className:"text-center",render:function(set,status,dt){return void 0==dt.likeCount?0:dt.likeCount}},{data:"replies",className:"text-center",render:function(set,status,dt){var replies=dt.replies||0;return replies}},{data:"createTime",className:"text-center",render:function(set,status,dt){var createTime=dt.createTime||0;return createTime}},{data:"top",className:"text-center",render:function(set,status,dt,position){return 1==dt.top?'<button id="topPost" class="btn btn-xs btn-success">置顶</button>':0==dt.top&&0==position.row?'<button id="unTopPost" class="btn btn-xs btn-success">取消置顶</button>':'<span>                                        <button id="movePost" class="btn btn-xs btn-success">上移</button>                                        <button id="unTopPost" class="btn btn-xs btn-success m-l-xs">取消置顶</button>                                    </span>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#topPost",function(event){$http.post(app.url.community.topTopic,{access_token:app.url.access_token,groupId:app.url.groupId,id:aData.id}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success","","置顶成功！"),setTable()):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")})}),$(nRow).on("click","#unTopPost",function(event){$http.post(app.url.community.undoTopTopic,{access_token:app.url.access_token,groupId:app.url.groupId,id:aData.id}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success","","取消置顶成功！"),setTable()):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")})}),$(nRow).on("click","#movePost",function(event){$http.post(app.url.community.moveTopic,{access_token:app.url.access_token,groupId:app.url.groupId,id:aData.id}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success","","上移成功！"),setTable()):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")})}),$(nRow).on("click","#goDetail",function(event){var modalInstance=$modal.open({templateUrl:"src/tpl/community/group/post_detail.html",controller:"groupPostDetailCtrl",size:"lg",backdrop:"static",resolve:{postDetailId:function(){return aData.id}}});modalInstance.result.then(function(status){"ok"==status&&setTable()})})}}),dataPostTable.off("page.dt").on("page.dt",function(e,settings){index=dataPostTable.page.info().page,start=length*index,postListParam.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=0,start=0,postListParam.pageIndex=0,postListParam.pageSize=len})};setTable()},$scope.initPostListTable(),$scope.initCircleTable=function(){$scope.isPostList=!1,$http.post(app.url.community.getByGroupCircle,{access_token:app.url.access_token,groupId:app.url.groupId}).success(function(data,status,headers,config){1==data.resultCode?$scope.circleList=data.data:toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")})},$scope.addCircle=function(){var modalInstance=$modal.open({templateUrl:"addCircle.html",controller:"addCircleModalCtrl",size:"md"});modalInstance.result.then(function(addObj){"ok"==addObj.status&&$http.post(app.url.community.addCircle,{access_token:app.url.access_token,groupId:app.url.groupId,name:addObj.circleName}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success","","新增栏目成功！"),$scope.initCircleTable(),getSideCircle()):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")})})},$scope.deleteCircle=function(ciecleId){var modalInstance=$modal.open({templateUrl:"deleteCircle.html",controller:"deleteCircleModalCtrl",size:"sm"});modalInstance.result.then(function(status){"ok"==status&&$http.post(app.url.community.deleteCircle,{access_token:app.url.access_token,id:ciecleId}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success","","删除栏目成功！"),$scope.initCircleTable(),getSideCircle()):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")})})},$scope.editCircle=function(ciecle){var modalInstance=$modal.open({templateUrl:"editCircle.html",controller:"editCircleModalCtrl",size:"md",resolve:{editCircle:function(){return ciecle}}});modalInstance.result.then(function(editObj){"ok"==editObj.status&&$http.post(app.url.community.updateCircle,{access_token:app.url.access_token,id:ciecle.id,name:editObj.newName}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success","","编辑栏目成功！"),$scope.initCircleTable(),getSideCircle()):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")})})},$scope.topCircle=function(ciecleId){$http.post(app.url.community.topCircle,{access_token:app.url.access_token,groupId:app.url.groupId,id:ciecleId}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success","","上移栏目成功！"),$scope.initCircleTable()):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")})},window.reflashData=function(){initPostListTable()}}),app.controller("addCircleModalCtrl",function($scope,$modalInstance,toaster,$http,utils){$scope.titleLength=0,$scope.funGetLength=function(){$scope.circleName?$scope.titleLength=$scope.circleName.length:$scope.titleLength=0},$scope.ok=function(){var addObj={circleName:$scope.circleName,status:"ok"};$modalInstance.close(addObj)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),app.controller("editCircleModalCtrl",function($scope,$modalInstance,toaster,$http,utils,editCircle){$scope.circle=editCircle,$scope.titleLength=0,$scope.funGetLength=function(){$scope.circle.newName?$scope.titleLength=$scope.circle.newName.length:$scope.titleLength=0},$scope.ok=function(){var editObj={newName:$scope.circle.newName,status:"ok"};$modalInstance.close(editObj)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),app.controller("deleteCircleModalCtrl",function($scope,$modalInstance,toaster,$http,utils){$scope.ok=function(){$modalInstance.close("ok")},$scope.cancel=function(){$modalInstance.dismiss("cancel")}});