app.controller("creatVideoCtrl",function($scope,$timeout,utils,$http,$modal,Upload,toaster,$state,$stateParams,Group,AppFactory,$sce,MyFileSelectBoxFactory){localStorage.getItem("user_name"),localStorage.getItem("access_token");$scope.formData={},$scope.formData.video={},$scope.accessoryList=[],$scope.chooseCircleIndex=0,$scope.titleLength=0,$scope.isSaved=!1,$scope.currentOrgInfo=Group.getCurrentOrgInfo(),$scope.funGetLength=function(){$scope.formData.title?$scope.titleLength=$scope.formData.title.length:$scope.titleLength=0},$http.post(app.url.community.getByGroupCircle,{access_token:app.url.access_token,groupId:app.url.groupId}).success(function(data,status,headers,config){1==data.resultCode?($scope.circleSideList=data.data,$scope.formData.circle=data.data[0].id):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")}),$scope.config={file:{urlParams:"?imageView2/3/w/800/h/800"}},$scope.qiniuFilters={mime_types:[{title:"Image files",extensions:"jpg,gif,png"}]},$scope.selectFile=function(){$scope.upload()},$scope.token=app.url.access_token,$scope.uploaderAdded=function(up,files){$scope.uploadPercent=0},$scope.uploaderSuccess=function(up,file,info){$scope.fontImgUrl=file.url,$scope.copy_small=file.url+"?imageView2/3/w/200/h/200",$scope.uploadPercent=100,toaster.pop("success",null,"展示图修改成功！")},$scope.uploaderError=function(up,err,errTip){$timeout(err.code==-600?function(){toaster.pop("error",null,"文件大小超过2M，无法上传")}:function(){toaster.pop("error",null,errTip)})},$scope.fileUploadProcess=function(up,file){$scope.uploadPercent=100==file.percent?99:file.percent},$scope.addVideo=function(){MyFileSelectBoxFactory.open({type:["video"],onlyIf:!0},function(files){files.length>0&&($scope.formData.video={play_first:files[0].url+"?vframe/jpg/offset/1/w/474/h/268",play_url:files[0].url,size:files[0].sizeStr,suffix:files[0].suffix})})},$scope.addAccessory=function(){MyFileSelectBoxFactory.open({type:[""]},function(files){for(var i=0;i<files.length;i++)$scope.accessoryList.push({file_url:files[i].url,size:files[i].size,sizeStr:files[i].sizeStr,file_name:files[i].name,type:files[i].type,file_id:files[i].fileId,suffix:files[i].suffix})})},$scope.removeAcce=function(fileId){$scope.accessoryList=$scope.accessoryList.filter(function(acce){return acce.file_id!=fileId})},$scope.chooseCircle=function(index){$scope.chooseCircleIndex=index},$scope.saveDoc=function(){return $scope.formData.title?($scope.isSaved=!0,void $http.post($scope.formData.video.play_url+"?avinfo",{}).success(function(data){data.format&&void 0!==data.format.duration?($scope.formData.video.play_time=data.format.duration,$http.post(app.url.community.publish,{access_token:app.url.access_token,groupId:app.url.groupId,title:$scope.formData.title,type:2,text:$scope.formData.videoDesc,circleId:$scope.circleSideList[$scope.chooseCircleIndex].id,filesJson:JSON.stringify($scope.accessoryList),videoJson:JSON.stringify([$scope.formData.video])}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success","","发帖成功,3秒钟后返回帖子列表"),setTimeout(function(){$state.go("app.doctorCommunity.post_list",{},{reload:!0})},3e3)):($scope.isSaved=!1,toaster.pop("error","",data.resultMsg))}).error(function(data,status,headers,config){$scope.isSaved=!1,toaster.pop("error","","服务器繁忙，请稍后再试！")})):($scope.isSaved=!1,toaster.pop("error","","获取视频信息失败，请重新选择！"))}).error(function(data,status,headers,config){$scope.isSaved=!1,toaster.pop("error","","获取视频信息失败，请重新选择！")})):void toaster.pop("warn","","请填写标题")},$scope.umerrorcallback=function(value){$timeout(function(){console.log(toaster),toaster.pop("error","",value)},0)}});