"use strict";app.controller("doctorCommunityCtrl",function($scope,$timeout,utils,$http,$modal,toaster,$location,$state){var dataPostTable,hasCircle=!1;$scope.groupName=localStorage.getItem("curGroupName");var postListApi=app.url.community.getPubListTopic;$scope.initPostListTable=function(){var postListParam={access_token:app.url.access_token,groupId:app.url.groupId,pageIndex:0,pageSize:20},index=0,length=20,start=0,size=10,setTable=function(){dataPostTable=$("#postListTable").DataTable({language:app.lang.datatables.translation,searching:!1,sScrollX:"100%",sScrollXInner:"110%",destroy:!0,lengthChange:!0,ordering:!1,draw:index,pageLength:length,lengthMenu:[10,20,50,100],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:postListApi,fnServerData:function(sSource,aoData,fnCallback){$.ajax({type:"post",url:sSource,dataType:"json",data:postListParam,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else toaster.pop("error","",resp.resultMsg)}})},columns:[{data:"title",render:function(set,status,dt){return""==dt.title?'<i id="goDetail"><无标题></i>':'<span id="goDetail">'+dt.title+"</span>"}},{data:"createName",className:"text-center",render:function(set,status,dt){return void 0==dt.createName?"--":dt.createName}},{data:"likeCount",className:"text-center",render:function(set,status,dt){return void 0==dt.likeCount?0:dt.likeCount}},{data:"replies",className:"text-center",render:function(set,status,dt){var replies=dt.replies||0;return replies}},{data:"createTime",className:"text-center",render:function(set,status,dt){var createTime=dt.createTime||0;return createTime}},{data:"delete",className:"text-center",render:function(set,status,dt){return'<button id="deletePost" class="btn btn-xs btn-success">删除</button>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#goDetail",function(event){var modalInstance=$modal.open({templateUrl:"src/tpl/community/doctor/post_detail.html",controller:"doctorPostDetailCtrl",size:"lg",backdrop:"static",resolve:{postDetailId:function(){return aData.id}}});modalInstance.result.then(function(status){"ok"==status&&setTable()})}),$(nRow).on("click","#deletePost",function(event){var modalInstance=$modal.open({templateUrl:"delPostInListModal.html",controller:"delPostInListModalCtrl",size:"sm"});modalInstance.result.then(function(status){"ok"==status&&$http.post(app.url.community.deleteTopic,{access_token:app.url.access_token,id:aData.id}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success",null,"删除帖子成功！"),setTable()):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")})})})}}),dataPostTable.off("page.dt").on("page.dt",function(e,settings){index=dataPostTable.page.info().page,start=length*index,postListParam.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=0,start=0,postListParam.pageIndex=0,postListParam.pageSize=len})};setTable()},$scope.initPostListTable(),$http.post(app.url.community.getByGroupCircle,{access_token:app.url.access_token,groupId:app.url.groupId}).success(function(data,status,headers,config){1==data.resultCode?data.data.length>0&&(hasCircle=!0):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","","服务器繁忙，请稍后再试！")}),$scope.funPostType=function(){if(!hasCircle)return void toaster.pop("error","","集团尚无栏目，管理员新增栏目后方可发帖！");var modalInstance=$modal.open({templateUrl:"postTypeModal.html",controller:"postTypeModalCtrl",size:"sm"});modalInstance.result.then(function(status){"imgText"==status&&$state.go("app.doctorCommunity.create_post_imgt"),"video"==status&&$state.go("app.doctorCommunity.create_post_video")})},window.reflashData=function(){initPostListTable()}}),app.controller("postTypeModalCtrl",function($scope,$modalInstance,toaster,$http,utils){$scope.imgText=function(){$modalInstance.close("imgText")},$scope.video=function(){$modalInstance.close("video")},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),app.controller("delPostInListModalCtrl",function($scope,$modalInstance,toaster,$http,utils){$scope.ok=function(){$modalInstance.close("ok")},$scope.cancel=function(){$modalInstance.dismiss("cancel")}});