app.controller("ConsultDetailCtrl",function($scope,utils,$http,$modal,toaster,$location,$state,$rootScope,$stateParams){function getOpenStatus(){$http.post(app.url.consult.getOpenConsultation,{access_token:app.url.access_token,groupId:curGroupId}).success(function(data,status,headers,config){1==data.resultCode?1!=data.data&&$state.go("app.consultation.introduce"):console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})}function getData(){$http.post(app.url.consult.getPackDetail,{access_token:app.url.access_token,consultationPackId:$stateParams.id}).success(function(data,status,headers,config){1==data.resultCode?($scope.description=data.data.consultationPackDesc,$scope.docPriceMax=data.data.maxFee/100,$scope.docPriceMin=data.data.minFee/100,$scope.groupRatio=data.data.groupPercent,$scope.docRatio=data.data.consultationDoctorPercent,$scope.orgDocRatio=data.data.unionDoctorPercent,data.data.doctorInfoList&&data.data.doctorInfoList.length>0&&data.data.doctorInfoList.forEach(function(item,index,array){$scope.doctors.push({id:item.userId,name:item.name})})):console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})}function pickData(){new DataBox("data_res",{hasCheck:!0,allCheck:!0,leafCheck:!1,multiple:!0,allHaveArr:!0,self:!1,cover:!1,selectView:!0,arrType:[1,0],search:{url:app.url.yiliao.searchDoctorByKeyWord,param:{access_token:app.url.access_token,groupId:curGroupId,consultationPackId:consultationPackId,keyword:"name",pageSize:1e4,pageIndex:0},dataKey:{name:"doctor.name",id:"doctorId",union:"departmentId",dataSet:"data.pageData"},keyName:"keyword",unwind:!1},data:{url:app.url.yiliao.getAllData,param:{access_token:app.url.access_token,groupId:curGroupId}},async:{url:app.url.yiliao.getDepartmentDoctor,dataKey:{departmentId:"id"},data:{access_token:app.url.access_token,groupId:curGroupId,consultationPackId:consultationPackId,status:"C",type:1},dataName:"",target:{data:"",dataKey:{id:"userId",name:"name"}}},titles:{main:"选择会诊医生",searchKey:"医生姓名",label:"已选择医生"},icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check/fa fa-square",root:"fa fa-hospital-o cfblue",branch:"fa fa-h-square cfblue",leaf:"fa fa-user-md dcolor",head:"headPicFileName"},root:{selectable:!1,name:utils.localData("curGroupName"),id:0},extra:[{name:"未分配",id:"idx_0",parentId:0,subList:[],url:app.url.yiliao.getUndistributed,dataName:"pageData",target:{data:"doctor",dataKey:{id:"doctorId",name:"name"}},param:{access_token:app.url.access_token,groupId:curGroupId,consultationPackId:consultationPackId,pageIndex:0,pageSize:1e4},icon:"fa fa-bookmark"}],fixdata:$scope.doctors,response:makeList,datakey:{id:"id",name:"name",sub:"subList"},info:{name:"name",id:"id",pid:"parentId",dpt:"departments",description:"description",param:"param",icon:"icon",url:"url",isExtra:"isExtra",target:"target"},callback:function(){}})}function makeList(dt){console.log(dt),$scope.doctors=dt,$scope.$apply($scope.doctors)}var curGroupId=utils.localData("curGroupId");$scope.doctors=[],$scope.hiddenData=[],$scope.saved=!0;var consultationPackId=$stateParams.id?$stateParams.id:curGroupId;getOpenStatus(),$stateParams.id&&getData(),$scope.addData=function(){pickData()},$scope.removeItem=function(item){var index=$scope.doctors.indexOf(item);$scope.doctors.splice(index,1),console.log($scope.doctors)},$scope.$watch("docRatio",function(newValue,oldValue){newValue!=oldValue&&($scope.orgDocRatio=100-newValue)}),$scope.$watch("orgDocRatio",function(newValue,oldValue){newValue!=oldValue&&($scope.docRatio=100-newValue)}),$scope.save=function(){$scope.saved=!1;var doctorIds=[];if($scope.doctors.forEach(function(item,index,array){doctorIds.push(item.id)}),$stateParams.id){var doctorsStr="";doctorIds.forEach(function(item,index,array){doctorsStr+="&doctorIds="+item});var url=app.url.consult.updatePack+"?access_token="+app.url.access_token+"&id="+$stateParams.id+"&consultationPackDesc="+$scope.description+"&maxFee="+100*$scope.docPriceMax+"&minFee="+100*$scope.docPriceMin+"&groupPercent="+$scope.groupRatio+"&consultationDoctorPercent="+$scope.docRatio+"&unionDoctorPercent="+$scope.orgDocRatio+doctorsStr;$http.get(encodeURI(url),{}).success(function(data,status,headers,config){1==data.resultCode?$state.go("app.consultation.list",null,{reload:!0}):(toaster.pop("error",null,data.resultMsg),$scope.saved=!0)}).error(function(data,status,headers,config){toaster.pop("error",null,data.resultMsg),$scope.saved=!0})}else $http.post(app.url.consult.addPack,{access_token:app.url.access_token,groupId:curGroupId,consultationPackDesc:$scope.description,maxFee:100*$scope.docPriceMax,minFee:100*$scope.docPriceMin,groupPercent:$scope.groupRatio,consultationDoctorPercent:$scope.docRatio,unionDoctorPercent:$scope.orgDocRatio,doctorIds:doctorIds}).success(function(data,status,headers,config){1==data.resultCode?$state.go("app.consultation.list",null,{reload:!0}):(toaster.pop("error",null,data.resultMsg),$scope.saved=!0)}).error(function(data,status,headers,config){toaster.pop("error",null,data.resultMsg),$scope.saved=!0})}});