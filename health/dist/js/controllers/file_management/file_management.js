"use strict";app.controller("fileManagementCtrl",function($rootScope,$scope,$http,toaster,$modal,editableThemes,editableOptions,$window,$state,MyFileSelectBoxFactory){function saveFileInfo(name,mimeType,size,key,hash){return $http({url:app.yiliao+"vpanfile/saveFileInfo",method:"post",data:{access_token:localStorage.getItem("access_token"),name:name,mimeType:mimeType,size:size,key:key,hash:hash}})}function getMyFile(pageIndex,pageSize,mode,type,sortAttr,sortType,fileNameKey){$scope.isCheckAll=!1,$scope.mgFilesIsLoading=!0,$http({url:app.yiliao+"vpanfile/queryFile",method:"post",data:{access_token:localStorage.getItem("access_token"),pageIndex:pageIndex-1,pageSize:pageSize,mode:mode||$scope.mode||null,type:type||$scope.type||null,fileNameKey:fileNameKey||$scope.fileNameKey||null,sortAttr:sortAttr||$scope.sortAttr||"date",sortType:sortType||$scope.sortType||-1}}).then(function(response){var rep=response.data;rep&&1==rep.resultCode?($scope.page_count=rep.data.total,$scope.page_size=rep.data.pageSize,$scope.myFiles=rep.data.pageData):console.warn(rep),$scope.mgFilesIsLoading=!1})}function deleteFile(ids,mode){var url=app.yiliao+"vpanfile/deleteUploadFile";"upload"==mode?url=app.yiliao+"vpanfile/deleteUploadFile":"receive"==mode?url=app.yiliao+"vpanfile/deleteSendFile":toaster.pop("error",null,"删除出错：mode不能为空"),$http({url:url,method:"post",data:{access_token:localStorage.getItem("access_token"),ids:ids}}).then(function(response){var rep=response.data;if(rep&&1==rep.resultCode){toaster.pop("success",null,"删除成功"),getMyFile($scope.page,$scope.page_size);for(var i=0;i<$scope.fileList.length;i++)if($scope.fileList[i].id==ids[0]){$scope.fileList[i].status="ok",$scope.fileList[i].percent=100;break}$scope.fileList=$scope.fileList.filter(function(item){return item.fileId!=ids})}else rep.resultMsg?toaster.pop("error",null,rep.resultMsg):console.warn(rep)})}editableThemes.bs3.inputClass="input-xs",editableThemes.bs3.buttonsClass="btn-xs",editableOptions.theme="bs3",$scope.token=app.url.access_token,$scope["byte"]=function(bytes,precision){if(isNaN(parseFloat(bytes))||!isFinite(bytes))return"-";"undefined"==typeof precision&&(precision=1);var units=["bytes","kB","MB","GB","TB","PB"],number=Math.floor(Math.log(bytes)/Math.log(1024));return(bytes/Math.pow(1024,Math.floor(number))).toFixed(precision)+" "+units[number]},$scope.upLoadingFilesNbr=function(files){var acount=0;return angular.forEach(files,function(file){"ok"==file.status&&acount++}),acount},$scope.waitingFilesNbr=function(files){var acount=0;return angular.forEach(files,function(file){file.status==-1&&acount++}),files&&files.length&&(acount=files.length-acount),acount},$scope.uploaderAdded=function(up,files){$scope.uploadBoxOpen=!0},$scope.uploaderSuccess=function(up,file,info){var res=JSON.parse(info);saveFileInfo(file.name,file.type,file.size,res.key,res.hash).then(function(response){var rep=response.data;if(rep&&1===rep.resultCode){$scope.fileList.forEach(function(item,index,array){item.id==res.key&&(item.fileId=rep.data.id)});for(var i=0;i<$scope.fileList.length;i++)if($scope.fileList[i].id==file.id){$scope.fileList[i].status="ok",$scope.fileList[i].percent=100;break}getMyFile($scope.page,$scope.page_size)}else rep.resultMsg&&toaster.pop("error",null,rep.resultMsg)})},$scope.uploaderError=function(up,err,errTip){toaster.pop("error",null,errTip)},$scope.myFiles=[],$scope.page=1,$scope.page_size=10,$scope.mode="upload",$scope.type="",$scope.sortAttr="date",$scope.sortType=-1,$scope.fileNameKey="",$scope.pageChanged=function(){$scope.getMyFile($scope.page,$scope.page_size)},$scope.fileFormatIdentify=function(item){var suffix=item.suffix.toLowerCase(),fileTypeUrl="./src/img/fileFormat/";return"ppt"==suffix||"pptx"==suffix?fileTypeUrl+"ppt.png":"pdf"==suffix?fileTypeUrl+"pdf.png":"rtf"==suffix?fileTypeUrl+"rtf.png":"txt"==suffix?fileTypeUrl+"txt.png":"xml"==suffix?fileTypeUrl+"xml.png":"xls"==suffix||"xlsx"==suffix?fileTypeUrl+"excle.png":"doc"==suffix||"docx"==suffix?fileTypeUrl+"word.png":"xps"==suffix?fileTypeUrl+"doc.png":"jpg"==suffix||"jpeg"==suffix||"png"==suffix||"gif"==suffix||"bmp"==suffix?item.url+"?imageView2/3/w/50/h/50"||fileTypeUrl+"image.png":"mp4"==suffix||"avi"==suffix||"rmvb"==suffix||"rm"==suffix||"asf"==suffix||"divx"==suffix||"mpg"==suffix||"mpeg"==suffix||"mpe"==suffix||"wmv"==suffix||"mkv"==suffix||"vob"==suffix||"mov"==suffix?fileTypeUrl+"video.png":"mp3"==suffix||"wma"==suffix||"aac"==suffix||"mid"==suffix||"wav"==suffix||"vqf"==suffix||"cda"==suffix?fileTypeUrl+"audio.png":fileTypeUrl+"unknow.png"},getMyFile($scope.page,$scope.page_size),$scope.getMyFile=getMyFile,$scope.fileReName=function(id,newName){console.log(newName),$http({url:app.yiliao+"vpanfile/updateFileName",method:"post",data:{access_token:localStorage.getItem("access_token"),newName:newName,id:id}}).then(function(response){var rep=response.data;rep&&1==rep.resultCode?toaster.pop("success",null,"修改成功"):rep.resultMsg?toaster.pop("error",null,rep.resultMsg):console.warn(rep)})},$scope.checkList=function(files,property){var chacks=[];return angular.forEach(files,function(file){file.isCheck&&chacks.push(file[property])}),chacks},$scope.openDeleteConfirmDialog=function(fileIds,mode){var ids=[];!Array.isArray(fileIds)||fileIds.length<1?ids.push(fileIds):ids=fileIds;var modalInstance=$modal.open({templateUrl:"DeleteConfirmDialog.html",controller:"DeleteConfirmDialogCtrl",size:"sm"});modalInstance.result.then(function(isDelete){isDelete&&deleteFile(ids,mode)})},$scope.checkAll=function(){var isCheck=!1;isCheck=!!$scope.isCheckAll,angular.forEach($scope.myFiles,function(file){file.isCheck=isCheck})},$scope.checkOne=function(){for(var i=0;i<$scope.myFiles.length;i++){if(1==$scope.myFiles.length){$scope.myFiles[i].isCheck?$scope.isCheckAll=!0:$scope.isCheckAll=!1;break}if(!$scope.myFiles[i].isCheck){$scope.isCheckAll=!1;break}if(i==$scope.myFiles.length-1){$scope.myFiles[i].isCheck&&($scope.isCheckAll=!0);break}}},$scope.openVideoModal=function(item){if("avi"==item.suffix)return void toaster.pop("error",null,"不支持此格式地播放");var modalInstance=$modal.open({templateUrl:"videoModalContent.html",controller:"videoModalCtrl",windowClass:"videoModal",backdrop:"static",resolve:{item:function(){return item}}});modalInstance.result.then(function(selectedItem){},function(){})};var LeaveTimes=0;$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams,options){if(0==LeaveTimes){event.preventDefault();var isUploading=$scope.fileList.some(function(item,index,array){return 2==item.status||1==item.status});if(isUploading){var modalInstance=$modal.open({templateUrl:"LeaveConfirmDialog.html",controller:"LeaveConfirmDialogCtrl",size:"sm"});modalInstance.result.then(function(isLeave){LeaveTimes++,$state.go(toState.name,null,{reload:!0})},function(){event.preventDefault()})}else LeaveTimes++,$state.go(toState.name,null,{reload:!0})}}),window.onbeforeunload=function($event){var isUploadind=$scope.fileList.some(function(item,index,array){return 2==item.status||1==item.status});if(isUploadind)return"离开此页面文件将会中断上传"}}),app.controller("DeleteConfirmDialogCtrl",function($scope,$modalInstance){$scope.ok=function(){$modalInstance.close(!0)},$scope.close=function(){$modalInstance.dismiss("cancel")}}),app.controller("videoModalCtrl",function($scope,$modalInstance,item,$sce,toaster){$scope.item=item,$scope.videoUrl=$sce.trustAsResourceUrl(item.url),$scope.audioBgUrl="mp3"==item.suffix?"src/img/audio.png":"",$scope.close=function(){$modalInstance.dismiss("cancel")}}),app.controller("LeaveConfirmDialogCtrl",function($scope,$modalInstance){$scope.ok=function(){$modalInstance.close(!0)},$scope.close=function(){$modalInstance.dismiss("cancel")}});