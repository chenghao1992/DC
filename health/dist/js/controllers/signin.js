"use strict";app.controller("SigninFormController",["$scope","$http","$state","$cookieStore","utils","$rootScope","modal",function($scope,$http,$state,$cookieStore,utils,$rootScope,modal){function setLocalGroupList(dt){for(var len=dt.length,listStr="[",i=0;i<len;i++)listStr+='{name:"'+dt[i].name+'",id:"'+dt[i].id+'",orgType:"'+(dt[i].orgType||"")+'"',listStr+=dt[i].id===$scope.curGroupId?",isCurGroup:true}":",isCurGroup:false}",i<dt.length-1&&(listStr+=",");listStr+="]",utils.localData("groupList",listStr)}function initChosen(dt){for(var select=$("#group_select").html(""),len=dt.length,i=0;i<len;i++){var opt=$('<option value="'+dt[i].id+'">'+dt[i].name+"</option>");select.append(opt),0===i&&(dt[i].groupId?$scope.curGroupId=dt[i].groupId:$scope.curGroupId=dt[i].id)}setLocalGroupList(dt),select.on("change",function(e){dt[$(this)[0].selectedIndex].groupId?$scope.curGroupId=dt[$(this)[0].selectedIndex].groupId:$scope.curGroupId=dt[$(this)[0].selectedIndex].id,setLocalGroupList(dt)})}function isGroupAdmin(funA,funB){$http({method:"post",url:app.url.yiliao.isAdminOfGroup,data:{access_token:app.url.access_token}}).then(function(resp){1==resp.data.data?funA():funB()})}var width_pswd,width_code,_remember,smsid="",_isRemembered=utils.localData("user_remember"),_telephone=utils.localData("user_telephone"),_password=utils.localData("user_password");!function(){setTimeout(function(){width_pswd=$("#login_with_pswd"),width_code=$("#login_with_code"),_remember=$("#rememberInfo"),_isRemembered&&(_remember.attr("checked",!0),_isRemembered&&_telephone&&_password&&($scope.user.telephone=_telephone,$scope.user.password=_password,$scope.$apply($scope.user),$scope.$apply($scope.password)))},200)}(),$scope.login_with_pswd=!0,$scope.withPSWD=function(){$scope.authError="",$scope.login_with_pswd=!0,width_pswd.addClass("animating fade-in-right")},$scope.withCODE=function(){$scope.authError="",$scope.login_with_pswd=!1,width_code.addClass("animating fade-in-right")},$scope.getCode=function(){if(!$scope.user.telephone)return void modal.toast.warn("请填写手机号码！");var timer=0,num=119,btn=$("#login_with_code .get-code"),disabled=document.createAttribute("disabled");$scope.authError="",btn[0].setAttributeNode(disabled),btn.html('再次获取 (<span id="code_timer" class="text-warning">'+num+"</span>)");var codeTimer=$("#code_timer");timer=setInterval(function(){0===num?(clearInterval(timer),btn[0].removeAttribute("disabled"),btn.html("再次获取"),utils.localData("smsid",null)):num<=100?codeTimer.html("0"+--num):num<=10?codeTimer.html("00"+--num):codeTimer.html(--num)},1e3),$http({url:app.url.sendRanCode,method:"post",data:{phone:$scope.user.telephone,userType:3}}).then(function(response){1===response.data.resultCode?(smsid=response.data.data.smsid,utils.localData("smsid",smsid)):($scope.authError=response.data.resultMsg,num=0)},function(x){$scope.authError="服务器错误"})},$scope.user={},$scope.authError=null,$scope.login=function(){$scope.authError=null;var param={userType:3};if($scope.login_with_pswd){var url=app.url.login;param.telephone=$scope.user.telephone,param.password=$scope.user.password}else{var url=app.url.loginByCode;param.telephone=$scope.user.telephone,param.smsid=smsid||utils.localData("smsid"),param.verifyCode=$scope.user.ranCode}$http({url:url,method:"post",data:param}).then(function(response){if(1===response.data.resultCode){utils.setCookie("a",response.data.data.access_token),app.url.access_token=response.data.data.access_token,utils.localData("access_token",app.url.access_token);var accessGroup=function(){$rootScope.curDepartmentId=null,utils.localData("groupPicFile",null),utils.localData("company",null),utils.localData("curGroupId",null),utils.localData("curGroupName",null),utils.localData("curGroupEnterpriseName",null),$rootScope.rootGroup.id=null,$scope.datas.groupPicFile=null,$rootScope.rootGroup.name=null,$rootScope.rootGroup.enterpriseName=null,$rootScope.rootEnterprise=null,$rootScope.enterprise_userName=null,$rootScope.isCompany=!1,utils.localData("isCompany","false"),$rootScope.logFromCompany=!1,utils.localData("logFromCompany","false"),utils.localData("userStatus",response.data.data.user.status);var _name=response.data.data.user.name,_id=response.data.data.userId,_type=$scope.userType["type_"+response.data.data.user.userType];$scope.datas.user_id=_id,$scope.datas.user_name=_name,$scope.datas.user_type=_type,utils.localData("user_name",_name||"0"==_name?_name:null),utils.localData("user_type",_type),utils.localData("user_id",_id),_remember.prop("checked")?(utils.localData("user_remember",!0),utils.localData("user_telephone",$scope.user.telephone),utils.localData("user_password",$scope.user.password)):(utils.localData("user_remember",null),utils.localData("user_telephone",null),utils.localData("user_password",null)),response.data.data.user.headPicFileName?(utils.localData("headPicFile",response.data.data.user.headPicFileName),$scope.datas.user_headPicFile=response.data.data.user.headPicFileName+"?"+(new Date).getTime()):$scope.datas.user_headPicFile=null;var _groupList=response.data.data.user.groupList,_hospitalList=response.data.data.user.hospitalList,_hospitalList_index=_hospitalList.length;if(_hospitalList_index>0)for(;_hospitalList_index--;)_hospitalList[_hospitalList_index].orgType=1;_groupList=_hospitalList.concat(_groupList),$rootScope.groupList=_groupList||[];var len=$rootScope.groupList.length;$rootScope.loginError=!1,len>1?($scope.has_more_group=!0,utils.localData("has_more_group",!0),setTimeout(function(){initChosen($rootScope.groupList)},300)):(utils.localData("has_more_group",!1),$scope.curGroupId=response.data.data.user.loginGroupId,response.data.data.user.hospitalList[0]&&response.data.data.user.hospitalList[0].groupId&&($scope.curGroupId=response.data.data.user.hospitalList[0].groupId),setLocalGroupList($rootScope.groupList),0===len&&utils.localData("applyStatus","NR"),$scope.verifyByGuser($scope.curGroupId,_id))};7===response.data.data.user.status&&1!=response.data.data.user.hospitalStatus?isGroupAdmin(accessGroup,function(){$scope.authError="此账号还未认证！"}):2===response.data.data.user.status&&1!=response.data.data.user.hospitalStatus?isGroupAdmin(accessGroup,function(){$scope.authError="此账号还未审核！"}):accessGroup()}else 1040103===response.data.resultCode?modal.confirm(null,"您还未设置密码！",function(){$rootScope.phone=$scope.user.telephone,$state.go("access.resetPassword")},{OK:"设置密码"}):$scope.authError=response.data.resultMsg},function(x){$scope.authError="服务器错误"})},$scope.login_for_sure=function(){$scope.curGroupId&&$scope.datas.user_id&&$scope.verifyByGuser($scope.curGroupId,$scope.datas.user_id)}}]);