"use strict";app.controller("BankAccount",["$rootScope","$scope","$state","$timeout","$http","utils","modal","$modal",function($rootScope,$scope,$state,$timeout,$http,utils,modal,$modal){var groupId=utils.localData("curGroupId");$scope.bankAccount=[],$rootScope.canAddMore=!0,$http({url:app.url.finance.getGroupBanks,method:"post",data:{access_token:app.url.access_token,groupId:groupId}}).then(function(resp){"1"==resp.data.resultCode&&($scope.bankAccount=resp.data.data,0!==$scope.bankAccount.length?$rootScope.canAddMore=!1:$rootScope.canAddMore=!0)}),$scope.seeDetails=function(id){id&&($("#doctor_details").removeClass("hide"),$rootScope.winVisable=!0)},$scope.setDefault=function(idx,flg){$http({url:app.url.finance.setBankStatus,method:"post",data:{access_token:app.url.access_token,id:$scope.bankAccount[idx].id,isDefault:!0}}).then(function(resp){if("1"==resp.data.resultCode){flg||modal.toast.success("设置成功！");for(var i=0;i<$scope.bankAccount.length;i++)i!==idx&&($scope.bankAccount[i].isDefault=!1);$scope.bankAccount[idx].isDefault=!0}})},$scope.remove=function(idx){1===$scope.bankAccount.length,modal.confirm("删除银行卡","您确定删除该银行卡吗？",function(){$http({url:app.url.finance.deleteBankCard,method:"post",data:{access_token:app.url.access_token,id:$scope.bankAccount[idx].id}}).then(function(resp){"1"==resp.data.resultCode&&(modal.toast.success("删除成功！"),(idx||0===idx)&&$scope.bankAccount.splice(idx,1),0!==$scope.bankAccount.length?$rootScope.canAddMore=!1:$rootScope.canAddMore=!0)})})};var modalInstance;$scope.addAccount=function(){modalInstance=$modal.open({animation:!0,templateUrl:"addBackAccount.html",controller:"AddBankAccount",size:"md",resolve:{item:function(){return $scope.curGroupId}}})}}]),app.controller("AddBankAccount",function($scope,$rootScope,$modalInstance,$http,item,modal){function initChosen(dt){var select=$("#bank_list"),len=dt.length,tmp=$("<select></select>");tmp.append("<option>请选择</option>");for(var i=0;i<len;i++){var opt=$('<option data-id="'+dt[i].id+'">'+dt[i].bankName+"</option>");tmp.append(opt)}select.html(tmp.html()),select.on("change",function(e){$scope.account.bankId=dt[$(this)[0].selectedIndex].id,$scope.account.bankName=$(this).val()})}$scope.account={};var groupId=localStorage.getItem("curGroupId");$http({url:app.url.finance.getBanks,method:"post",data:{access_token:app.url.access_token}}).then(function(resp){"1"==resp.data.resultCode&&initChosen(resp.data.data)}),$scope.confirm=function(){$http({url:app.url.finance.addGroupBankCard,method:"post",data:{access_token:app.url.access_token,groupId:groupId,bankNo:$scope.account.bankNo,bankName:$scope.account.bankName,isDefault:$scope.account.isDefault}}).then(function(resp){"1"==resp.data.resultCode?(modal.toast.success("添加成功！"),resp.data.data?item.push(resp.data.data):item.push($scope.account),$scope.account.isDefault&&$scope.setDefault(item.length-1),$rootScope.canAddMore=!1,$modalInstance.dismiss("cancel")):modal.toast.warn(resp.data.resultMsg)})},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.setDefault=function(idx){for(var i=0;i<item.length;i++)i!==idx&&(item[i].isDefault=!1);item[idx].isDefault=!0}});