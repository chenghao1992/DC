"use strict";app.controller("ReportsOfFinance",["$rootScope","$scope","$state","$timeout","$http","utils","$stateParams","JQ_CONFIG","uiLoad","modal","AppFactory","Group",function($rootScope,$scope,$state,$timeout,$http,utils,$stateParams,JQ_CONFIG,uiLoad,modal,AppFactory,Group){function monitorOfFormData(){watch_form=$scope.$watchGroup(formData,function(newValue,oldValue){for(var len=newValue.length,i=0;i<len;i++)newValue[i]!=oldValue[i]&&(param={});for(var i=0;i<len;i++)newValue[i]&&/\S/g.test(newValue[i])&&(param[formData[i]]=newValue[i])})}function initTable(){var start=0;index=1,length=1*utils.localData("page_length")||10;var setTable=function(){function setSearchBar(){if($scope.isGroup&&flg&&"0"!=flg){orderForm.appendTo($("#table_of_group_wrapper").children(".row:nth-child(1)").children(".col-sm-6:nth-child(1)").attr("class","col-md-2").next().attr("class","col-md-10"));uiLoad.load(JQ_CONFIG.dateTimePicker).then(function(){var start_time=(new Date,flg.replace(/\D/g,"/")+"01",$("#start_time").datetimepicker({format:"yyyy-mm-dd",initialDate:new Date,startView:2,minView:2,autoclose:!0,keyboardNavigation:!0,todayBtn:!1,language:"zh-CN"}).on("show",function(e){start_time.datetimepicker("setStartDate",selectStartTime),start_time.datetimepicker("setEndDate",selectEndTime)}).on("changeDate",function(){end_time.datetimepicker("setStartDate",$(this).val()),$scope.startTime=$(this).val(),$scope.endTime="",$scope.$apply()})),end_time=$("#end_time").datetimepicker({format:"yyyy-mm-dd",initialDate:new Date,startView:2,minView:2,autoclose:!0,keyboardNavigation:!0,todayBtn:!1,language:"zh-CN"}).on("show",function(e){end_time.datetimepicker("setEndDate",selectEndTime)}).on("changeDate",function(){start_time.datetimepicker("setEndDate",$(this).val()),$scope.endTime=$(this).val(),$scope.$apply()})})}}function submit(){$scope.searching=!0,param={upGroup:groupId},/\D/g.test(keyWord)||11!==keyWord.length?param.name=keyWord:param.telephone=keyWord,url=app.url.finance.gdIncomeList,dTable.fnDestroy(),initTable()}if(table=$scope.isGroup?$("#table_of_group"):$("#table_of_doctor"),dTable=table.dataTable({draw:index,displayStart:start,lengthMenu:[5,10,15,20,30,40,50,100],pageLength:length,bServerSide:!0,sAjaxSource:url,fnServerData:function(sSource,aoData,fnCallback){param.startTime&&"number"!=typeof param.startTime&&(param.startTime=Date.parse(param.startTime)),param.endTime&&"number"!=typeof param.endTime&&(param.endTime=Date.parse(param.endTime)+864e5-1e3),param.pageIndex=index-1,param.pageSize=aoData[4].value,param.month=flg,param.groupId=groupId,param.access_token=app.url.access_token,$http({method:"post",url:sSource,data:param}).then(function(resp){if("1"!=resp.data.resultCode)return modal.toast.warn(resp.data.resultMsg),void setSearchBar();resp=resp.data.data;for(var i=0;i<resp.pageData.length;i++)utils.extendHash(resp.pageData[i],["doctorName","telephone","orderType","orderTypeName","money","orderNo","shareMoney"]);resp.start=resp.start,resp.recordsTotal=resp.total,resp.recordsFiltered=resp.total,resp.length=resp.pageSize,resp.data=resp.pageData,fnCallback(resp),$scope.loading=!1,$rootScope.loaded=!0,total=resp.total},function(resp){modal.toast.error(resp.data.resultMsg)})},searching:!$scope.isGroup,language:app.lang.datatables.translation,createdRow:function(nRow,aData,iDataIndex){var a_link=$(nRow).find(".a-link");a_link.click(function(){})},columns:$scope.isGroup?[{data:"childName",orderable:!1,searchable:!1},{data:"telephone",orderable:!1,searchable:!1},{data:"typeName",orderable:!1,searchable:!1},{data:"orderNO",orderable:!1,searchable:!1},{data:"createDate",orderable:!1,searchable:!1,render:function(set,status,dt){return set&&0!==set.length?utils.dateFormat(set,"yyyy年MM月dd日，hh点mm分"):""}},{data:"orderMoney",orderable:!1,searchable:!1,render:function(set,status,dt){return(set/100).toFixed(2)}},{data:"money",orderable:!1,searchable:!1,render:function(set,status,dt){return(set/100).toFixed(2)}}]:[{data:"doctorName",orderable:!1,searchable:!1,render:function(set,status,dt){return'<a class="a-link">'+set+"</a>"}},{data:"telephone",orderable:!1,searchable:!1},{data:"finishedMoney",orderable:!1,searchable:!1,render:function(set,status,dt){return(set/100).toFixed(2)}},{data:"unfinishedMoney",orderable:!1,searchable:!1,render:function(set,status,dt){return(set/100).toFixed(2)}}]}),!$scope.isGroup){var table_of_doctor_filter=$("#table_of_doctor_filter"),_form=$("<form></form>"),_lbl=table_of_doctor_filter.addClass("group-search").children("label").append(_i),_i=$('<i ng-show="loaded" class="fa icon-magnifier"></i>'),_ipt=_lbl.find("input").attr("placeholder","搜索...").attr("autocomplete","off"),_timer=0,_temp="",isSearching=!1;table_of_doctor_filter.append(_form),_form.append(_lbl),_lbl.html("").append(_ipt).append(_i),_ipt.focus(function(){_timer=setInterval(function(){var val=$.trim(_ipt.val());val?(isSearching=!0,_i.removeClass("icon-magnifier").addClass("fa-times-circle"),keyWord=_temp=val):(isSearching=!1,_i.removeClass("fa-times-circle").addClass("icon-magnifier"),_temp&&!val&&($scope.searching=!1,keyWord=_temp="",start=length*(index-1),param={upGroup:groupId}))},100)}),_ipt.blur(function(){clearInterval(_timer)}),_i.click(function(){isSearching=!1,keyWord=_temp="",_ipt.trigger("submit"),_ipt.val(""),_i.removeClass("fa-times-circle").addClass("icon-magnifier"),start=length*(index-1),dTable.fnDestroy(),param={upGroup:groupId},url=app.url.finance.gdIncomeList,dTable.fnDestroy(),initTable()}),_ipt.val(keyWord).trigger("focus"),utils.keyHandler(_ipt,{key13:submit})}dTable.off().on("init.dt",function(){table.find("tr[data-id="+$rootScope.curRowId+"]").addClass("currentRow"),setSearchBar()}).on("length.dt",function(e,settings,len){index=1,start=0,length=len,dTable.fnDestroy(),setTable(),utils.localData("page_length",len)}).on("page.dt",function(e,settings){isSearching||(index=settings._iDisplayStart/length+1)})};setTable()}var watch_form,groupId=utils.localData("curGroupId"),name=$stateParams.name,flg=$stateParams.date,orderForm=$("#order_query");$scope.currentOrgInfo=Group.getCurrentOrgInfo(),$scope.currentOrgInfo&&AppFactory.group.isServiceGroup($scope.currentOrgInfo.id).then(function(_data){_data?$scope.isServiceGroup=!0:$scope.isServiceGroup=!1});var selectStartTime=new Date(Date.parse(flg.replace("年","-").replace("月","-").replace("日",""))),selectEndTime=new Date(selectStartTime);if(selectEndTime.setMonth(selectStartTime.getMonth()+1),selectEndTime.setDate(0),"group"===name){var url=app.url.finance.gIncomeDetail,date=new Date,MM=date.getMonth()+1;MM=MM>9?MM:"0"+MM;var date=date.getFullYear()+"-"+MM,param={groupId:groupId,month:flg};$scope.isGroup=!0}else{var url=app.url.finance.gdIncomeList,param={upGroup:groupId};$scope.isGroup=!1}flg&&"0"!=flg&&($scope.canBack=!0),$scope.goBack=function(){window.history.back()};var formData=["childName","telephone","oType","startTime","endTime"];$scope.queryOrder=function(){url=app.url.finance.gMIncomeDetail,dTable&&(dTable.fnDestroy(),initTable())},monitorOfFormData(),$scope["export"]=function(){if(param){param.pageSize=total,param.startTime&&"number"!=typeof param.startTime&&(param.startTime=Date.parse(param.startTime.replace(/-/g,"/")+" 00:00:00")),param.endTime&&"number"!=typeof param.endTime&&(param.endTime=Date.parse(param.endTime.replace(/-/g,"/")+" 23:59:59"));var str="";for(var k in param)str+="&"+k+"="+param[k]}param.access_token?$scope.action_url=app.url.finance.downExcel+"?type=21"+(str?str:""):$scope.action_url=app.url.finance.downExcel+"?access_token="+app.url.access_token+"&groupId="+groupId+"&type=21&month="+flg+"&pageIndex="+(index-1)+"&pageSize="+total+(str?str:""),window.location.href=$scope.action_url};var table,dTable,keyWord,index,length,total;initTable(),$scope.open=function($event,typeBtn){$event.preventDefault(),$event.stopPropagation(),$scope[typeBtn]=!0}}]);