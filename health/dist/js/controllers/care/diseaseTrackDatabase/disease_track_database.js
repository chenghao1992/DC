"use strict";function deleteTrackContentCtrl($scope,$modalInstance){$scope.ok=function(){$modalInstance.close(!0)},$scope.cancel=function(){$modalInstance.dismiss(!1)}}function funchooseIllnessModalCtrl($scope,$modalInstance,$timeout){function initTree(){function treeClick(info){$scope.diseaseName=info.name,diseaseName=info.name,$scope.diseaseId=info.id,diseaseId=info.id,$scope.$apply()}var contacts=new Tree("thisLifeQualityLibraryTree",{hasCheck:!1,allCheck:!1,multiple:!1,allHaveArr:!1,self:!0,search:!1,arrType:[1,0],data:{url:app.yiliao+"article/getTypeByParent",param:{access_token:app.url.access_token,groupId:groupId}},datakey:{id:"id",name:"name",sub:"children"},info:{name:"name",id:"id",pid:"department",leaf:"leaf"},root:{selectable:!0,name:"全部",id:null},events:{click:treeClick},callback:function(){contacts.tree.find("dt")}})}var groupId=app.url.groupId(),diseaseId="",diseaseName="";$timeout(initTree,0),$scope.ok=function(){var returnInfo={};returnInfo={id:diseaseId,diseaseName:diseaseName,isTrue:!0},$modalInstance.close(returnInfo)},$scope.cancel=function(){$modalInstance.dismiss(!1)}}!function(){function funDiseaseTrackDatabaseCtrl($scope,$http,$state,toaster,AddIllnessTrackFtory,$modal,utils,$timeout){function treeClick(info){$scope.diseaseName=info.name,$scope.diseaseId=info.id,$scope.$apply(),$scope.initTable(info.id)}$scope.diseaseName="全部",$scope.pageSize=10,$scope.pageIndex=1;var groupId=app.url.groupId();$scope.token=app.url.access_token,function(){$http({url:serverApiRoot+"vpanfile/getUploadToken",method:"post",data:{access_token:app.url.access_token,bucket:"resource"}}).then(function(response){var rep=response.data;rep&&1==rep.resultCode&&rep.data&&rep.data.token&&rep.data.domain||console.error(rep)})}();var contacts=new Tree("lifeQualityLibraryTree",{hasCheck:!1,allCheck:!1,multiple:!1,allHaveArr:!1,self:!0,search:!1,arrType:[1,0],data:{url:app.url.designer.getDiseaseTypeFromStore,param:{access_token:app.url.access_token,groupId:groupId}},datakey:{id:"id",name:"name",sub:"children"},info:{name:"name",id:"id",pid:"department",leaf:"leaf"},root:{selectable:!0,name:"全部",id:null},events:{click:treeClick},callback:function(){var dts=contacts.tree.find("dt");dts.eq(0).data().info&&treeClick(dts.eq(0).data().info)}});$scope.deleteQuestionFromStore=function(questionId){console.log(questionId);var modalInstance=$modal.open({templateUrl:"delModalContent.html",controller:"deleteTrackContentCtrl",size:"md"});modalInstance.result.then(function(result){result&&$http.post(app.urlRoot+"designer/deleteQuestionFromStore",{access_token:app.url.access_token,questionId:questionId}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"删除成功"),$scope.initTable($scope.diseaseId)):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"删除出错"),console.error(rpn))})})},$scope.initTable=function(itemId){$http.post(app.url.designer.getQuestionListFromStore,{access_token:app.url.access_token,groupId:groupId,diseaseTypeId:itemId,pageSize:$scope.pageSize||10,pageIndex:$scope.pageIndex-1||0}).success(function(data){1==data.resultCode?($scope.surveyList=data.data,$scope.pageTotal=data.data.total):toaster.pop("error",null,data.resultMsg)}).error(function(data){toaster.pop("error",null,"服务器通讯出错")})},$scope.initTable($scope.diseaseId||""),$scope.createTrack=function(item){var item=item;item={diseaseTypeId:item.diseaseTypeId,diseaseTypeName:item.diseaseTypeName,item:item};var modalInstance=$modal.open({templateUrl:"eidtTrackModalContent.html",controller:"createTrackCtrl",windowClass:"docModal doc",resolve:{item:function(){return item}}});modalInstance.result.then(function(result){console.log(result),result&&$scope.initTable($scope.diseaseId||"")})},$scope.selectFile=function(){console.log("fds"),$scope.upload()},$scope.editTips=function(question){function callBack(tipsData){getPlanData()}var tipsData={question:question};AddIllnessTrackFtory.editTips(tipsData,callBack)}}angular.module("app").controller("diseaseTrackDatabaseCtrl",funDiseaseTrackDatabaseCtrl),funDiseaseTrackDatabaseCtrl.$inject=["$scope","$http","$state","toaster","AddIllnessTrackFtory","$modal","utils","$timeout"]}(),app.controller("createTrackCtrl",function($scope,$timeout,$modalInstance,item,$sce,$http,toaster,$state,$modal,Lightbox){var diseaseTypeId=item.diseaseTypeId;$scope.diseaseName=item.diseaseTypeName,$scope.titleImgs=[];var UpadeId="";item.item?(item.item.picUrls||(item.item.picUrls=[]),$scope.illnessTrack=item.item,$scope.titleImgs=item.item.picUrls,UpadeId=item.item.id):($scope.isEditNew=!0,$scope.illnessTrack={name:"题目名称",options:[{seq:"1",name:"选项名称",level:"1",appendQuestions:[],picUrls:[]},{seq:"2",name:"选项名称",level:"1",appendQuestions:[],picUrls:[]}]}),$scope.openLightboxModal=function(index){Lightbox.openModal($scope.titleImgs,index)},$scope.openSingleLightboxModal=function(index,item){Lightbox.openModal(item,0)},$scope.chooseDepartment=function(){console.log("df");var modalInstance=$modal.open({templateUrl:"chooseIllnessModalContent.html",controller:"chooseIllnessModalCtrl",size:"md"});modalInstance.result.then(function(result){result.isTrue&&(diseaseTypeId=result.id,$scope.diseaseName=result.diseaseName)})},$scope.addOption=function(){$scope.illnessTrack.options.push({seq:$scope.illnessTrack.options[$scope.illnessTrack.options.length-1].seq+1,name:"选项名称",level:"1",appendQuestions:[],picUrls:[]})},$scope.removeItem=function(item,arry){var index=arry.indexOf(item);arry.splice(index,1)},$scope.addAppendQuestion=function(option){option.appendQuestions||(option.appendQuestions=[]),option.appendQuestions.push({name:"追加题目名称",options:[{name:"选项名称"},{name:"选项名称"}]})},$scope.addAppendOption=function(question){question.options.push({name:"选项名称"})},$scope.copyAppendQuestion=function(question,questions){var index=questions.indexOf(question);questions.splice(index+1,0,{name:question.name,options:function(){return angular.copy(question.options)}()})},$scope.optionChange=function(option,arry){var index=arry.indexOf(option.levelName);option.level=index+1},$scope.exchangeItem=function(moveItem,replaceItem,arry){var mIndex=arry.indexOf(moveItem),rIndex=arry.indexOf(replaceItem);arry.splice(rIndex,1,moveItem),arry.splice(mIndex,1,replaceItem)},$scope.ok=function(){if($scope.totalUploadFilesNum>1)return void toaster.pop("waring",null,"图片正常上传，请稍后");var json={name:$scope.illnessTrack.name,options:$scope.illnessTrack.options,picUrls:$scope.titleImgs},param={};return param=UpadeId?{questionId:UpadeId,access_token:app.url.access_token,groupId:app.url.groupId(),diseaseType:diseaseTypeId,jsonData:JSON.stringify(json)}:{access_token:app.url.access_token,groupId:app.url.groupId(),diseaseType:diseaseTypeId,jsonData:JSON.stringify(json)},diseaseTypeId?void $http.post(app.urlRoot+"designer/storeQuestion",param).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(UpadeId?toaster.pop("success",null,"修改成功"):toaster.pop("success",null,"新建成功"),$modalInstance.close(!0)):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"新建错误"),console.error(rpn))}):void toaster.pop("waring",null,"请先选择科室")},$scope.closeModal=function(){$modalInstance.dismiss("cancel")},$scope.multiSelection=!1,$scope.qiniuFilters={mime_types:[{title:"Image files",extensions:"jpg,gif,png"}]},$scope.selectFile=function(e){$scope.titleImgs>=8||("uploadTotalPics"==e?$scope.selectPicItem="isUploadTotalPic":"isHeadTitlePic"!=e?($scope.selectPicItem=e,$scope.selectPicItem.picUrls||($scope.selectPicItem.picUrls=[])):($scope.selectPicItem="isHeadTitlePic",$scope.titleImgs=$scope.titleImgs||[]),$scope.upload())},$scope.removeItemImg=function(item){$scope.titleImgs.splice(item,1)},$scope.fileUploadProcess=function(up,file){"isUploadTotalPic"==$scope.selectPicItem?$scope.uploadTotalPicsPercent=0:"isHeadTitlePic"!=$scope.selectPicItem?$scope.selectPicItem.uploadPercent=100==file.percent?99:file.percent:$scope.titlePicUrlUlPenct=100==file.percent?99:file.percent},$scope.removeOptionImg=function(item){item.picUrls.splice(0,1),item.uploadPercent=0},$scope.token=app.url.access_token,$scope.uploaderAdded=function(up,files){$scope.totalUploadFilesNum=files.length,$scope.titlePicUrlUlPenct=0,"isUploadTotalPic"==$scope.selectPicItem?$scope.uploadTotalPicsPercent=0:"isHeadTitlePic"!=$scope.selectPicItem&&($scope.selectPicItem.uploadPercent=0)},$scope.uploaderSuccess=function(up,file,info){function getImageInfo(callback){$http.get(file.url+"?imageInfo").then(function(rpn){rpn?(imageInfo=rpn.data,callback()):console.log("something happened unexpected")})}function setPicInfo(){"isUploadTotalPic"==$scope.selectPicItem?($scope.isEditNew=!1,$scope.isEditNew?($scope.illnessTrack.options=[],$scope.illnessTrack.options.push({seq:$scope.illnessTrack.options.length+1,name:"选项名称",level:"1",appendQuestions:[],picUrls:[file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key]}),$scope.isEditNew=!1):$scope.illnessTrack.options.push({seq:$scope.illnessTrack.options[$scope.illnessTrack.options.length-1].seq+1,name:"选项名称",level:"1",appendQuestions:[],picUrls:[file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key]})):"isHeadTitlePic"!=$scope.selectPicItem?($scope.selectPicItem.picUrls[0]=file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key,$scope.selectPicItem.uploadPercent=100):($scope.titleImgs.push(file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key),$scope.titlePicUrlUlPenct=100),$scope.copy_small=file.url+"?imageView2/3/w/200/h/200",toaster.pop("success",null,"题图上传成功！")}if($scope.totalUploadFilesNum--,$scope.titleImgs.length>=8&&"isHeadTitlePic"==$scope.selectPicItem)return void toaster.pop("error",null,"最多上传8张题目图片");var info=JSON.parse(info),imageInfo={};getImageInfo(setPicInfo)},$scope.uploaderError=function(up,err,errTip){toaster.pop("error",null,"题图大于2M，请重新上传"),"-600"==err.code?toaster.pop("error",null,"题图大于2M，请重新上传"):toaster.pop("error",null,errTip)}}),angular.module("app").controller("deleteTrackContentCtrl",deleteTrackContentCtrl),deleteTrackContentCtrl.$inject=["$scope","$modalInstance"],angular.module("app").controller("chooseIllnessModalCtrl",funchooseIllnessModalCtrl),funchooseIllnessModalCtrl.$inject=["$scope","$modalInstance","$timeout"];