"use strict";function funCopyMsgCtrl($scope,$http,$modal,$modalInstance,toaster,item){$scope.thisExecuteTimeList=[],$scope.thisExecuteTime=item.thisExecuteTime;for(var j=1;j<=item.thisExecuteTime;j++)$scope.thisExecuteTimeList.push(j);$scope.questionLength=item.questionLength,$scope.dateSeq="1",$scope.hourData=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],$scope.sendTimeHour="09",$scope.sendTimeMin="00",$scope.ok=function(){$http.post(app.urlRoot+"designer/copyIllnessTrack",{access_token:app.url.access_token,sendTime:$scope.sendTimeHour+":"+$scope.sendTimeMin,carePlanId:item.carePlanId,schedulePlanId:item.schedulePlanId,dateSeq:$scope.dateSeq,questionIds:item.questionIds}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"复制成功"),$modalInstance.close(!0)):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"复制出错")})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}app.controller("CarePlanCtrl",function($scope,$http,$log,toaster,$modal,$stateParams,addTextDomeFtory,EditCareInfoFtory,AddCareRemindFtory,AddMedicationFtory,AddSurveyFtory,AddCareCheckRemindFtory,AddLifeQualityFtory,AddCheckDocReplyFtory,AddIllnessTrackFtory){function getPlanData(){$http.post(app.urlRoot+"designer/findCarePlan",{access_token:app.url.access_token,carePlanId:$stateParams.planId}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?($scope.planData=rpn.data,$scope.thisExecuteTime=rpn.data.executeTime):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"获取计划数据出错"),console.error(rpn))})}function funGetMedicationInDay(schedulePlan){var careItems=schedulePlan.careItems;if(!careItems)return null;for(var i=0;i<careItems.length;i++)if(20==careItems[i].type)return careItems[i];return null}$scope.token=app.url.access_token,$stateParams.planId&&getPlanData(),$scope.getQuestionIndex=function(id,ids){for(var i=0;i<ids.length;i++)if(ids[i]==id)return i;return null},$scope.addSchedulePlan=function(){$scope.planData.schedulePlans.push({dateSeq:function(){return!$scope.planData.schedulePlans||$scope.planData.schedulePlans.length<1?1:$scope.planData.schedulePlans[$scope.planData.schedulePlans.length-1].dateSeq+1}()})},$scope.dateSeqS=function(max,except,pre,next){for(var _max=max,_min=1,_arry=[],i=_min;i<=_max;i++)_arry.push(i);for(var _dateSeqS=[],k=0;k<$scope.planData.schedulePlans.length;k++)_dateSeqS.push($scope.planData.schedulePlans[k].dateSeq);var _result=[];return _result=_arry.filter(function(item){return item==except||(_dateSeqS.indexOf(item)==-1||void 0)})},$scope.changeSeq=function(schedulePlanId,dateSeq){schedulePlanId&&$http.post(app.urlRoot+"/designer/updateDateSeq",{access_token:app.url.access_token,schedulePlanId:schedulePlanId,dateSeq:dateSeq}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"设置成功"),getPlanData()):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"获取计划数据出错"),console.error(rpn))})},$scope.deleteSchedulePlan=function(schedulePlanId,index){$http.post(app.urlRoot+"designer/deleteSchedulePlan",{access_token:app.url.access_token,schedulePlanId:schedulePlanId}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"撤消成功"),getPlanData()):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"获取计划数据出错"),console.error(rpn))})},$scope.openEdit=function(){function callBack(planData){$scope.planData=planData}var planData={};$scope.planData?planData=$scope.planData:planData.tmpType=1,EditCareInfoFtory.open(planData,callBack)},$scope.deleteCareItem=function(careItemId){$http.post(app.urlRoot+"designer/deleteCareItem",{access_token:app.url.access_token,careItemId:careItemId}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"删除成功"),getPlanData()):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"获取计划数据出错"),console.error(rpn))})},$scope.addRemind=function(dateSeq,schedulePlanId,remindId,sendTime,content){function callBack(remindData){getPlanData()}var remindData={id:remindId||null,carePlanId:$scope.planData.id||null,dateSeq:dateSeq,sendTime:sendTime||"09:00",schedulePlanId:schedulePlanId||null,tmpType:1,OtherRemind:{content:content||""}};AddCareRemindFtory.open(remindData,callBack)},$scope.addMedication=function(schedulePlan,medicationId,sendTime,medicalInfos){function callBack(medication){getPlanData()}if(!medicationId){var _medication=funGetMedicationInDay(schedulePlan);_medication&&(medicationId=_medication.id,sendTime=medicationId.sendTime,medicalInfos=_medication.medicalCare.medicalInfos)}var medication={id:medicationId||null,carePlanId:$scope.planData.id||null,dateSeq:schedulePlan.dateSeq,sendTime:sendTime||"09:00",schedulePlanId:schedulePlan.id||null,MedicalCare:{medicalInfos:medicalInfos||[]}};AddMedicationFtory.open(medication,callBack)},$scope.addCheckRemind=function(dateSeq,schedulePlanId,checkId,sendTime,checkItem){function callBack(checkRemind){getPlanData()}var checkData={id:checkId||null,carePlanId:$scope.planData.id||null,dateSeq:dateSeq,sendTime:sendTime||"09:00",schedulePlanId:schedulePlanId||null,checkItem:checkItem||{}};AddCareCheckRemindFtory.open(checkData,callBack)},$scope.addCheckDocReply=function(careItemId,doctorReply){function callBack(checkRemind){getPlanData()}var checkData={careItemId:careItemId,doctorReply:doctorReply};AddCheckDocReplyFtory.open(checkData,callBack)},$scope.addLifeQuality=function(dateSeq,schedulePlanId,lifeScaleId,sendTime,lifeScaleItem){function callBack(lifeQualityData){getPlanData()}var lifeQualityData={id:lifeScaleId||null,carePlanId:$scope.planData.id||null,dateSeq:dateSeq,sendTime:sendTime||"09:00",schedulePlanId:schedulePlanId||null,tmpType:1,lifeScaleItem:lifeScaleItem};AddLifeQualityFtory.open(lifeQualityData,callBack)},$scope.copyLifeQuality=function(careItem,sendTime){function callBack(repeatAskData){getPlanData()}var repeatAskData={careItem:careItem,sendTime:sendTime,thisExecuteTime:$scope.thisExecuteTime};AddLifeQualityFtory.copyLifeQuality(repeatAskData,callBack)},$scope.addText=function(dateSeq,schedulePlanId,surveyId,sendTime,surveyItem,documentItem){function callBack(addTextData){getPlanData()}var addTextData={id:surveyId||null,carePlanId:$scope.planData.id||null,dateSeq:dateSeq,sendTime:sendTime||"09:00",schedulePlanId:schedulePlanId||null,tmpType:1,surveyItem:documentItem};addTextDomeFtory.open(addTextData,callBack)},$scope.addSurvey=function(dateSeq,schedulePlanId,surveyId,sendTime,surveyItem){function callBack(surveyData){getPlanData()}var surveyData={id:surveyId||null,carePlanId:$scope.planData.id||null,dateSeq:dateSeq,sendTime:sendTime||"09:00",schedulePlanId:schedulePlanId||null,tmpType:1,surveyItem:surveyItem};AddSurveyFtory.open(surveyData,callBack)},$scope.addIllnessTrack=function(dateSeq,schedulePlanId,lifeScaleId,sendTime,question){function callBack(illnessTrackData){getPlanData()}var illnessTrackData={id:lifeScaleId||null,carePlanId:$scope.planData.id||null,dateSeq:dateSeq,sendTime:sendTime||"09:00",schedulePlanId:schedulePlanId||null,diseaseTypeId:$scope.planData.diseaseTypeId};question?(illnessTrackData.question=angular.copy(question),AddIllnessTrackFtory.createIllnessTrack(illnessTrackData,callBack)):AddIllnessTrackFtory.selectBox(illnessTrackData,callBack)},$scope.addTtriggerMsg=function(careItemId,triggerMsgs){function callBack(triggerMsgData){getPlanData()}var triggerMsgData={careItemId:careItemId,triggerMsgs:triggerMsgs||""};AddIllnessTrackFtory.triggerMsg(triggerMsgData,callBack)},$scope.repeatAsk=function(question,sendTime){function callBack(repeatAskData){getPlanData()}var repeatAskData={question:question,sendTime:sendTime,thisExecuteTime:$scope.thisExecuteTime};AddIllnessTrackFtory.repeatAsk(repeatAskData,callBack)},$scope.editTips=function(question){function callBack(tipsData){getPlanData()}var tipsData={question:question};AddIllnessTrackFtory.editTips(tipsData,callBack)},$scope.copyMsg=function(schedulePlanId,item,questions){console.log(questions.length);for(var questionIds=[],i=0;i<questions.length;i++)questionIds.push(questions[i].id);var item={item:item,schedulePlanId:schedulePlanId,questionIds:questionIds,carePlanId:$stateParams.planId,thisExecuteTime:$scope.thisExecuteTime,questionLength:questions.length||0},modalInstance=$modal.open({animation:!0,templateUrl:"copyMsgModalContent.html",controller:"copyMsgContentCtrl",size:"md",resolve:{item:function(){return item}}});modalInstance.result.then(function(item){getPlanData()})},$scope.removeIllnessTrackQuestion=function(questionId){$http.post(app.urlRoot+"designer/deleteIllnessTrackQuestion",{access_token:app.url.access_token,questionId:questionId}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"删除成功"),getPlanData()):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"删除出错"),console.error(rpn))})},$scope.moveIllnessTrack=function(careItemId,index,direction){$http.post(app.urlRoot+"designer/moveQuestion",{access_token:app.url.access_token,careItemId:careItemId,location:index,direction:direction}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"移动成功"),getPlanData()):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"移动出错"),console.error(rpn))})}}),angular.module("app").controller("copyMsgContentCtrl",funCopyMsgCtrl);