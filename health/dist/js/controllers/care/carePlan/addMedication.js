!function(){function AddMedicationFtory($http,$modal){function openModel(medicationData,callBack){medicationData||(medicationData={MedicalCare:{medicalInfos:[]}}),console.log(medicationData);var modalInstance=$modal.open({animation:!0,templateUrl:function(){var isChack=window.location.href.indexOf("/check/");return isChack!=-1?"../src/tpl/care/carePlan/addMedication.html":"src/tpl/care/carePlan/addMedication.html"}(),controller:"AddMedicationCtrl",windowClass:"docModal doc",resolve:{medicationData1:function(){return medicationData}}});modalInstance.result.then(function(callbackData){callBack&&callBack(callbackData)})}return{open:openModel}}function AddMedicationCtrl($scope,$http,$modal,$modalInstance,toaster,SelectMedicineBoxFactory,medicationData1){function submitRemindData(data){var param={access_token:app.url.access_token,sendTime:data.sendTime,carePlanId:data.carePlanId,schedulePlanId:data.schedulePlanId,dateSeq:data.dateSeq,jsonData:JSON.stringify(data.MedicalCare)};$scope.isSaved=!0,data.id&&(param.id=data.id),$http.post(app.urlRoot+"designer/saveMedicalCare",param).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"保存成功"),$modalInstance.close(rpn.data),$scope.isSaved=!1):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"保存出错"),console.error(rpn))})}function checkData(data){if(!data.sendTime)return toaster.pop("error",null,"请输入发送时间");if(!data.carePlanId)return toaster.pop("error",null,"缺少关怀计划id");if(!data.dateSeq)return toaster.pop("error",null,"缺少日程天数");if(data.MedicalCare&&data.MedicalCare.medicalInfos){if(data.MedicalCare.medicalInfos.length<1)return toaster.pop("error",null,"请添加药品");for(var arry=data.MedicalCare.medicalInfos,i=0;i<arry.length;i++){if(!arry[i].usage)return toaster.pop("error",null,"请正确填写药品的每一项");if("适量"!=arry[i].usage.quantity&&"0"!=arry[i].usage.quantity||(arry[i].usage.quantity="0"),!(arry[i].totalQuantity&&arry[i].totalQuantity.quantity&&arry[i].totalQuantity.unit&&arry[i].totalQuantity.days&&arry[i].usage&&arry[i].usage.patients&&arry[i].usage.quantity&&arry[i].usage.times&&arry[i].usage.periodNum&&arry[i].usage.unit))return toaster.pop("error",null,"请正确填写药品的每一项")}}submitRemindData(data)}$scope.medicationData=angular.copy(medicationData1),$scope.packUnit=medicationData1,$scope.isSaved=!1,$scope.openDrugBox=function(){SelectMedicineBoxFactory.open({medicines:[],access_token:app.url.access_token,callback:function(medicines){medicines.map(function(item){var drug={goodsId:item.id,generalName:item.generalName,title:item.title,manufacturer:item.manufacturer,packSpecification:item.packSpecification,imageUrl:item.imageUrl,packUnitText:item.packUnitText||"",totalQuantity:{quantity:1,unit:item.packUnitText,days:1},specification:item.specification};$scope.medicationData.MedicalCare.medicalInfos.push(drug)})}})},$scope.removeDrug=function(index){$scope.medicationData.MedicalCare.medicalInfos.splice(index,1)},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.ok=function(){checkData($scope.medicationData)},$scope.SetDose=function(index,dose,untext,days){var Dose={quantity:dose,unit:untext,days:days};$scope.medicationData.MedicalCare.medicalInfos[index].totalQuantity=Dose},$scope.SetDay=function(index,dose,untext,days){var Day={quantity:dose,unit:untext,days:days};$scope.medicationData.MedicalCare.medicalInfos[index].totalQuantity=Day},$scope.setUsage=function(index,usage,goodsId){console.log(usage),usage||(usage={}),goodsId&&(usage.goodsId=goodsId);var modalInstance=$modal.open({animation:!0,templateUrl:"SetUsageView.html",controller:"SetUsageCtrl",size:"md",resolve:{usage:function(){return usage}}});modalInstance.result.then(function(usage){$scope.medicationData.MedicalCare.medicalInfos[index].usage=usage})}}function SetUsageCtrl($scope,$http,$modal,$modalInstance,toaster,usage){function formChange(oldArray){var newArray=[];return oldArray.map(function(item,index){"适量"==item.quantity&&(item.quantity=0,item.unit=""),newArray.push({periodNum:item.periodNum||0,periodUnit:"天",times:item.times||0,quantity:item.quantity||0,unit:item.unitText||"",patients:item.patients||"",remarks:item.method||""})}),newArray}function getUsages(){$http.post(drugFirmsApiRoot+"goods/viewGoods",{access_token:app.url.access_token,id:goodsId}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode&&rpn.data&&rpn.data.drugUsegeList?($scope.usagesList=formChange(rpn.data.drugUsegeList||[]),$scope.usageSelected=angular.copy(usage),$scope.usage=angular.copy(usage),$scope.usage.quantity||($scope.usage.quantity=1)):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"获取药品失败")})}function checkData(usageSelected){return usageSelected?usageSelected.patients?!usageSelected.periodNum||usageSelected.periodNum<=0?(toaster.pop("error",null,"请输入正确的用法天数"),!1):!usageSelected.times||usageSelected.times<=0?(toaster.pop("error",null,"请输入正确的用法次数"),!1):!!usageSelected.unit||(toaster.pop("error",null,"请输入正确的用量单位"),!1):(toaster.pop("error",null,"请输入适用人群"),!1):(toaster.pop("error",null,"请设置用法用量"),!1)}var goodsId=usage.goodsId;!function(){$http.post(drugFirmsApiRoot+"goods/dose/getAvailDoseList",{access_token:app.url.access_token}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?($scope.unitList=rpn.data||[],getUsages()):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"获取用量单位失败")})}(),$scope.usageChange=function(usage){$scope.usageSelected=angular.copy(usage)},$scope.onlyNbr=function(nbr){return console.log(nbr),null===nbr||void 0===nbr||nbr<=0?(toaster.pop("error",null,"请输入正确数量"),1):nbr},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.ok=function(){checkData($scope.usageSelected)&&$modalInstance.close($scope.usageSelected)}}angular.module("app").factory("AddMedicationFtory",AddMedicationFtory),AddMedicationFtory.$inject=["$http","$modal"],angular.module("app").controller("AddMedicationCtrl",AddMedicationCtrl),angular.module("app").controller("SetUsageCtrl",SetUsageCtrl)}();