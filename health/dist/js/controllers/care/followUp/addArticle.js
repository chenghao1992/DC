!function(){function AddArticleFtory($http,$modal,$http,toaster){function openModel(artilceData,callBack){artilceData||(artilceData={});var modalInstance=$modal.open({animation:!0,templateUrl:function(){var isChack=window.location.href.indexOf("/check/");return isChack!=-1?"../src/tpl/care/followUp/addArticle.html":"src/tpl/care/followUp/addArticle.html"}(),controller:"AddArticleCtrl",windowClass:"docModal doc",resolve:{artilceData:function(){return artilceData}}});modalInstance.result.then(function(artilce){var jsonData={articleId:artilce.followUpDayDetails.itemId};$http.post(app.urlRoot+"designer/saveArticleItem",{access_token:app.url.access_token,sendTime:artilceData.sendTime,carePlanId:artilceData.carePlanId,schedulePlanId:artilceData.schedulePlanId,dateSeq:artilceData.dateSeq,jsonData:JSON.stringify(jsonData)}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"添加成功"),callBack&&callBack(artilceData)):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"添加出错"),console.error(rpn))})})}return{open:openModel}}function AddArticleCtrl($scope,$http,$modal,$modalInstance,toaster,utils,artilceData){function clone(myObj){var newObj={};if(newObj.label=myObj.name+"("+myObj.count+")",newObj.id=myObj.diseaseId,void 0!=myObj.children){newObj.children=[];for(var i in myObj.children)newObj.children[i]=clone(myObj.children[i])}return newObj}function initPlatDocTable(){var index=1,length=5,start=0,size=5,setTable=function(){platArticleTable=$("#doc_list").DataTable({language:app.lang.datatables.translation,searching:!1,sScrollX:"100%",sScrollXInner:"110%",destroy:!0,lengthChange:!0,ordering:!0,draw:index,pageLength:length,lengthMenu:[5,10,20,50],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:allDocUrl,fnServerData:function(sSource,aoData,fnCallback){$.ajax({type:"post",url:sSource,dataType:"json",data:allDocParam,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else console.log(resp.resultMsg)}})},columns:[{data:"author",render:function(set,status,dt){var keywordsStr="";dt.tag&&dt.tag.length>0?(keywordsStr+="关键字：",dt.tag.forEach(function(item,index,array){item&&(keywordsStr+=item.name+"；")})):keywordsStr+="&nbsp;";var groupNameStr=dt.groupName?"@"+dt.groupName+" ":"",doctorTitle=dt.doctor?dt.doctor.title:"",doctorHos=dt.doctor?"|"+dt.doctor.hospital:"",authorName=dt.authorName?dt.authorName:"",photoPath="src/img/nophoto.jpg";return dt.copyPath&&""!=dt.copyPath&&(photoPath=dt.copyPath),"<img src="+photoPath+' alt="..." style="width:60px;height:60px;margin-right:10px;float:left;border-radius:0;"><span class="clear"><span>'+dt.title+'</span><small class="text-muted clear text-ellipsis">'+keywordsStr.substring(0,30)+'</small><small class="text-muted clear text-ellipsis">作者：'+authorName+groupNameStr+" "+doctorTitle+doctorHos+"</small></span>"},orderable:!1},{data:"useNum",orderable:!1,render:function(set,status,dt){return void 0==dt.useNum?0:dt.useNum}},{data:"visitCount",orderable:!1,render:function(set,status,dt){return void 0==dt.visitCount?0:dt.visitCount}},{render:function(set,status,dt){return utils.dateFormat(dt.lastUpdateTime,"yyyy-MM-dd")}},{render:function(set,status,dt){return"<button class='btn btn-primary text-xs btn-xs'>添加</button>"},orderable:!1}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","button",function(event){var result={followUpDayDetails:{itemId:aData.id,type:6,name:aData.title}};$modalInstance.close(result)})}}),platArticleTable.off("page.dt").on("page.dt",function(e,settings){index=platArticleTable.page.info().page+1,start=length*(index-1),allDocParam.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=1,start=0,allDocParam.pageIndex=1,allDocParam.pageSize=len})};setTable()}console.log(artilceData);var platArticleTable,curGroupId=app.url.groupId();$scope.isCollapsed=!1,$scope.open=!1,$scope.showMore=!1;var currentTreeId;$scope.keywords=[],$scope.isTreeLoad=!1,$scope.mainKeyword=null;var preBranch,tree={};$scope.my_tree=tree={};var allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5};$scope.my_data=[];var getTreeData=function(){$http.post(app.url.document.findDiseaseTreeForArticle,{access_token:app.url.access_token,createType:1}).success(function(data,status,headers,config){if(1==data.resultCode){var source={count:data.data.total,name:"全部文档",diseaseId:null};source.children=data.data.tree;var result=clone(source),eArray=new Array;eArray[0]=result,$scope.my_data=eArray,$scope.isTreeLoad=!0}else console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})};getTreeData(),$scope.my_tree_handler=function(branch){currentTreeId=branch.id,$scope.isTop=!1,0==branch.children.length?$http.post(app.url.document.getDisease,{parentId:branch.id}).success(function(data,status,headers,config){1==data.resultCode?($scope.keywords=data.data,$scope.keywords.length>0&&$scope.keywords.unshift({name:"不限",id:null})):alert(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)}):$scope.keywords=[],allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5,diseaseId:branch.id},initPlatDocTable()},$scope.mainKWLength=0,$scope.$watch("mainKeyword",function(newValue,oldValue){newValue!=oldValue&&($scope.mainKeyword?$scope.mainKWLength=$scope.mainKeyword.length:$scope.mainKWLength=0)}),$scope.$watch("keywords",function(newValue,oldValue){setTimeout(function(){var kw_c_height=$("#p_kw_content").height();kw_c_height<70?$scope.showMore=!1:$scope.showMore=!0,$scope.$apply("showMore")},0)}),$scope.sortByKeyword=function(keyword){"不限"==keyword.name?(allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5,diseaseId:currentTreeId}):(allDocUrl=app.url.document.findArticleByTag,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5,tags:keyword.id}),initPlatDocTable()},$scope.clearMainKW=function(){$scope.my_tree.select_branch(preBranch),$scope.mainKeyword=null},$scope.pressEnter=function($event){13==$event.keyCode&&$scope.findDocByKeyWord()},$scope.findDocByKeyWord=function(){preBranch=$scope.my_tree.get_selected_branch(),$scope.my_tree.select_branch(),$scope.keywords=[],null==$scope.mainKeyword||0==$scope.mainKeyword.length?(allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5}):(allDocUrl=app.url.document.findArticleByKeyWord,allDocParam={title:$scope.mainKeyword,access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5}),initPlatDocTable()},setTimeout(function(){initPlatDocTable()},200),$scope.cancel=function(){$modalInstance.dismiss("cancel")}}angular.module("app").factory("AddArticleFtory",AddArticleFtory),AddArticleFtory.$inject=["$http","$modal","$http","toaster"],angular.module("app").controller("AddArticleCtrl",AddArticleCtrl)}();