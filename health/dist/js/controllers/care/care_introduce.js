app.controller("CareIntroCtrl",function($scope,$timeout,utils,$http,$modal,Upload,toaster,$state,$stateParams,$sce){function getPriceRange(){$http.post(app.urlRoot+"group/fee/get",{access_token:localStorage.getItem("access_token"),groupId:localStorage.getItem("curGroupId")}).then(function(rpn){1===rpn.data.resultCode&&rpn.data.data.carePlanMax&&rpn.data.data.carePlanMin&&($scope.carePlanMax=rpn.data.data.carePlanMax/100,$scope.carePlanMin=rpn.data.data.carePlanMin/100)})}function goUpload(files,fileName,certType){if(null!=files){var isAllow=!1,fileTypes=["jpg","jpeg","png","bmp"];if(fileTypes.forEach(function(item,index,array){files.name.split(".").slice(-1)[0]==item&&(isAllow=!0)}),!isAllow)return void toaster.pop("error",null,"图片类型不支持");angular.isArray(files)||(files=[files]);for(var i=0;i<files.length;i++)$scope.errorMsg=null,function(f,fileName,certType){utils.fileCompressToBlob(f,1,1e6,function(blob){upload(blob,fileName,certType)})}(files[i],fileName,certType)}}function upload(file,fileName){console.log(file),file.upload=Upload.upload({url:app.url.upload.CommonUploadServlet,file:file,fields:{path:"care"}}),file.upload.success(function(response){1==response.resultCode?response.data.datas[0]&&($scope.fontImgUrl=response.data.datas[0].oUrl,$scope.thumPath=response.data.datas[0].tUrl,toaster.pop("success",null,"题图上传成功！")):(toaster.pop("error",null,"题图上传失败！"),console.log(response.resultMsg))}),file.upload.error(function(response){console.log(response),toaster.pop("error",null,"题图上传失败！")})}$scope.titleLength=0,$scope.summaryLength=0,$scope.formData={},$scope.formData.keywords=[],$scope.fontImg=null,$scope.fontImgUrl=null,$scope.thumPath=null,$scope.isSaved=!1;var planSave={};$scope.isEdit="edit"==$stateParams.isEdit;var um=UM.getEditor("myEditor",{initialFrameWidth:"100%",initialFrameHeight:300,imageUrl:app.url.upload.CommonUploadServlet,imagePath:"",uploadPath:"care"});$scope.$on("$destroy",function(){um.destroy()}),$scope.diseaseData=[];var getDiseaseData=function(){$http.post(app.url.care.getDiseaseTypeTree,{access_token:app.url.access_token,groupId:localStorage.getItem("curGroupId"),tmpType:3}).success(function(data,status,headers,config){1==data.resultCode?data.data.forEach(function(item,index,array){$scope.diseaseData.push({id:item.id,name:item.name})}):alert(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})};getDiseaseData(),getPriceRange(),"edit"==$stateParams.isEdit&&(planSave=JSON.parse(localStorage.getItem("planSave")),$scope.formData.title=planSave.title,$scope.fontImgUrl=planSave.fontImgUrl,$scope.thumPath=planSave.thumPath,$scope.formData.selectedDisease=planSave.selectedDisease,$scope.formData.planPrice=planSave.planPrice/100,$scope.formData.summary=planSave.summary,um.setContent(planSave.content?planSave.content:"")),$scope.$watch("formData.title",function(newValue,oldValue){if(newValue!=oldValue)if($scope.formData.title){for(var totalLen=0,cutTitle="",j=0;j<$scope.formData.title.length&&!(totalLen>=40);j++)totalLen+=$scope.formData.title[j].length,cutTitle+=$scope.formData.title[j];$scope.titleLength=$scope.formData.title.length,$scope.formData.title=cutTitle}else $scope.titleLength=0}),$scope.$watch("formData.summary",function(newValue,oldValue){if(newValue!=oldValue)if($scope.formData.summary){for(var totalLen=0,cutSummary="",j=0;j<$scope.formData.summary.length&&!(totalLen>=80);j++)totalLen+=$scope.formData.summary[j].length,cutSummary+=$scope.formData.summary[j];$scope.summaryLength=$scope.formData.summary.length,$scope.formData.summary=cutSummary}else $scope.summaryLength=0}),$scope.$watch("fontImg",function(files){goUpload(files,"fontImg")}),$scope.deleteImg=function(){if(null!=$scope.fontImgUrl){var originUrl=$scope.fontImgUrl,newURL=originUrl.match("^[^#]*?://.*?(/.*)$")[1];$http.get(app.url.upload.commonDelFile+"?fileName="+newURL).success(function(data,status,headers,config){1==data.resultCode?($scope.fontImg=null,$scope.fontImgUrl=null,toaster.pop("success","",data.resultMsg)):toaster.pop("error","",data.resultMsg)}).error(function(data,status,headers,config){toaster.pop("error","",data.resultMsg)})}else toaster.pop("error","","图片为空！")},$scope.saveDoc=function(){if(!$scope.formData.title)return void toaster.pop("warn","","请填写标题");if(!$scope.formData.selectedDisease)return void toaster.pop("warn","","请选择病种");if(!$scope.formData.planPrice)return void toaster.pop("warn","","请填写价格");if($scope.formData.planPrice<$scope.carePlanMin||$scope.formData.planPrice>$scope.carePlanMax)return void toaster.pop("warn","","价格不在价格区间内");if(!$scope.fontImgUrl)return void toaster.pop("warn","","请上传题图");if(!$scope.formData.summary)return void toaster.pop("warn","","请填写摘要");var html=um.getContent();return console.log(html),html.length<=0?void toaster.pop("warn","","请填写正文"):(planSave.title=$scope.formData.title,planSave.fontImgUrl=$scope.fontImgUrl,planSave.thumPath=$scope.thumPath,planSave.selectedDisease=$scope.formData.selectedDisease,planSave.planPrice=100*$scope.formData.planPrice,planSave.summary=$scope.formData.summary,planSave.content=html,localStorage.setItem("planSave",JSON.stringify(planSave)),void($stateParams.planId?$state.go("app.edit_plan",{planId:$stateParams.planId,isEdit:"edit"}):$state.go("app.new_plan",{isEdit:"edit"})))},$scope.toPreview=function(){if(!$scope.formData.title)return void toaster.pop("warn","","请填写标题");if(!$scope.formData.selectedDisease)return void toaster.pop("warn","","请选择病种");if(!$scope.formData.planPrice)return void toaster.pop("warn","","请填写价格");if($scope.formData.planPrice<$scope.carePlanMin||$scope.formData.planPrice>$scope.carePlanMax)return void toaster.pop("warn","","价格不在价格区间内");if(!$scope.fontImgUrl)return void toaster.pop("warn","","请上传题图");if(!$scope.formData.summary)return void toaster.pop("warn","","请填写摘要");var html=um.getContent();if(html.length<=0)return void toaster.pop("warn","","请填写正文");var article={title:$scope.formData.title,fontImgUrl:$scope.fontImgUrl,thumPath:$scope.thumPath,selectedDisease:$scope.formData.selectedDisease,planPrice:100*$scope.formData.planPrice,summary:$scope.formData.summary,content:html,time:utils.dateFormat(new Date,"yyyy-MM-dd")};$modal.open({templateUrl:"previewModalContent.html",controller:"previewModalInstanceCtrl",windowClass:"carePreview",resolve:{article:function(){return article}}})}}),app.controller("previewModalInstanceCtrl",function($scope,$modalInstance,article,$sce){$scope.article=article,$scope.article.content=$sce.trustAsHtml(article.content),console.log(article),$scope.cancel=function(){$modalInstance.dismiss("cancel")}});