"use strict";app.controller("EditorSurveyCtrl",function($scope,$state,$http,toaster,editableThemes,editableOptions,ChooseDepartmentFactory,$stateParams,Lightbox){function checkData(_checkData_){if(!_checkData_.diseaseTypeId)return toaster.pop("error",null,"请选择科室"),!1;if(!_checkData_.title)return toaster.pop("error",null,"请填写调查表标题"),!1;if(!_checkData_.desc)return toaster.pop("error",null,"请填写调查表简介"),!1;if(!_checkData_.questions||_checkData_.questions.length<1)return toaster.pop("error",null,"请添加题目"),!1;for(var i=0;i<_checkData_.questions.length;i++)if(!_checkData_.questions[i].name)return toaster.pop("error",null,"请填写Q"+(i+1)+"题目"),!1;return!!_checkData_.groupId||(toaster.pop("error",null,"集团ID不能为空"),!1)}editableThemes.bs3.inputClass="input-xs",editableThemes.bs3.buttonsClass="btn-xs",editableOptions.theme="bs3",$scope.token=app.url.access_token,function(){$http({url:serverApiRoot+"vpanfile/getUploadToken",method:"post",data:{access_token:app.url.access_token,bucket:"resource"}}).then(function(response){var rep=response.data;rep&&1==rep.resultCode&&rep.data&&rep.data.token&&rep.data.domain||console.error(rep)})}(),$scope.qiniuFilters={mime_types:[{title:"Image files",extensions:"jpg,gif,png"}]},$scope.openLightboxModal=function(targetItem,index){Lightbox.openModal(targetItem,index)},$scope.openSingleLightboxModal=function(index,item){Lightbox.openModal(item,0)},$scope.fileUploadProcess=function(up,file){"isUploadTotalPic"==$scope.selectPicItem?$scope.uploadTotalPicsPercent=0:"isHeadTitlePic"!=$scope.selectPicItem?$scope.selectPicItem.uploadPenct=100==file.percent?99:file.percent:$scope.itemTitle.uploadPenct=100==file.percent?99:file.percent},$scope.selectFile=function(e,t){"uploadTotalPics"==e?($scope.selectPicItem="isUploadTotalPic",$scope.isUploadTotalImages=t):"isHeadTitlePic"!=e?($scope.selectPicItem=e,e.uploadPenct=0,e.picUrls||(e.picUrls=[])):(t.picUrls||(t.picUrls=[]),t.uploadPenct=0,$scope.selectPicItem="isHeadTitlePic",$scope.itemTitle=t),$scope.upload()},$scope.removeItemImg=function(e,index){e.uploadPenct=0,e.splice(index,1)},$scope.removeOptionImg=function(item){item.picUrls.splice(0,1),item.uploadPenct=0},$scope.token=app.url.access_token,$scope.uploaderAdded=function(up,files){$scope.totalUploadFilesNum=files.length},$scope.uploaderSuccess=function(up,file,info){function getImageInfo(callback){$http.get(file.url+"?imageInfo").then(function(rpn){rpn?(imageInfo=rpn.data,callback()):console.log("something happened unexpected")})}function setPicInfo(){"isUploadTotalPic"==$scope.selectPicItem?($scope.isEditNew=!1,$scope.isEditNew?($scope.surveyData.questions[$scope.isUploadTotalImages].options=[],$scope.surveyData.questions[$scope.isUploadTotalImages].options.push({name:"请点击输入选项名称",piont:0,picUrls:[file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key]}),$scope.isEditNew=!1):$scope.surveyData.questions[$scope.isUploadTotalImages].options.push({name:"请点击输入选项名称",piont:0,picUrls:[file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key]})):"isHeadTitlePic"!=$scope.selectPicItem?($scope.selectPicItem.picUrls[0]=file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key,$scope.selectPicItem.uploadPenct=100):($scope.itemTitle.picUrls.push(file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key),$scope.itemTitle.uploadPenct=100),$scope.copy_small=file.url+"?imageView2/3/w/200/h/200",toaster.pop("success",null,"题图上传成功！")}if($scope.totalUploadFilesNum--,$scope.itemTitle&&$scope.itemTitle.picUrls.length>=8&&"isHeadTitlePic"==$scope.selectPicItem)return void toaster.pop("error",null,"最多上传8张题目图片");var info=JSON.parse(info),imageInfo={};getImageInfo(setPicInfo)},$scope.uploaderError=function(up,err,errTip){toaster.pop("error",null,"题图大于2M，请重新上传"),"-600"==err.code?toaster.pop("error",null,"题图大于2M，请重新上传"):toaster.pop("error",null,errTip)},$stateParams.surveyId&&$stateParams.version?$http.post(app.yiliao+"designer/findSurveyByOne",{access_token:app.url.access_token,surveyId:$stateParams.surveyId,version:$stateParams.version}).then(function(rpn){rpn=rpn.data,1===rpn.resultCode?($scope.surveyData=rpn.data,$scope.isDiseaseDisable=!0):rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"接口出错")}):$scope.isEditNew=!0,$scope.surveyData={groupId:app.url.groupId(),questions:[]},$scope.chooseDepartment=function(){function callback(department){$scope.surveyData.diseaseTypeId=department.departmentLable,$scope.surveyData.diseaseName=department.departmentLableName}ChooseDepartmentFactory.open(callback)},$scope.addOption=function(qIndex){$scope.surveyData.questions[qIndex].options.push({name:"请点击输入选项名称",piont:0})},$scope.removeOption=function(qIndex,oIndex){$scope.surveyData.questions[qIndex].options.splice(oIndex,1)},$scope.addQuestion=function(type){1===type?$scope.surveyData.questions.push({name:"选择题",type:1,options:[{name:"请点击输入选项名称"},{name:"请点击输入选项名称"}]}):$scope.surveyData.questions.push({name:2===type?"填空题":"问答题",type:type})},$scope.copyQyestiong=function(qIndex,item){var name="问题题目"+qIndex+1,picUrls=[];item.name&&(name=item.name),item.picUrls&&(picUrls=item.picUrls);var _copyItem_={name:name,type:item.type,picUrls:picUrls};if(item.options){_copyItem_.options=[];for(var i=0;i<item.options.length;i++)_copyItem_.options[i]={name:item.options[i].name||"请点击输入选项名称",isAddRemark:item.options[i].isAddRemark||null,picUrls:item.options[i].picUrls||[]}}$scope.surveyData.questions.splice(qIndex+1,0,_copyItem_)},$scope.removeQuestion=function(qIndex){$scope.surveyData.questions.splice(qIndex,1)},$scope.putUpQuestion=function(qIndex){var _copyItem_=$scope.surveyData.questions[qIndex-1];$scope.surveyData.questions[qIndex-1]=$scope.surveyData.questions[qIndex],$scope.surveyData.questions[qIndex]=_copyItem_},$scope.putDownQuestion=function(qIndex){var _copyItem_=$scope.surveyData.questions[qIndex+1];$scope.surveyData.questions[qIndex+1]=$scope.surveyData.questions[qIndex],$scope.surveyData.questions[qIndex]=_copyItem_},$scope.saveEdit=function(){if($scope.totalUploadFilesNum>1)return void toaster.pop("waring",null,"图片正常上传，请稍后");var _checkData_=$scope.surveyData;checkData(_checkData_)&&(_checkData_=JSON.stringify(_checkData_),$http.post(app.yiliao+"designer/saveSurvey",{access_token:app.url.access_token,jsonData:_checkData_}).then(function(rpn){rpn=rpn.data,1===rpn.resultCode?(toaster.pop("success",null,"保存成功"),$state.go("app.care_plan.surveyLibrary")):rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"接口出错")}))}});