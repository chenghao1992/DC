"use strict";app.controller("Contacts",function($rootScope,$scope,$state,$http,$compile,utils,modal,Group,$stateParams){function getNumber(url,param,fun){$http({url:url,method:"post",data:param}).then(function(resp){1===resp.data.resultCode&&resp.data.data&&fun(resp.data.data.total)},function(x){console.error(x.statusText)})}function ReInitStatusList(n){for(var idx=5;idx--;){if(n&&(idx=n),2===idx){var numEle=$("#doctor_invited").html("0");_getData(app.url.yiliao.searchDoctor,{status:"I"},numEle)}else if(3===idx){var numEle=$("#doctor_quit").html("0");_getData(app.url.yiliao.searchDoctor,{status:"S"},numEle)}else if(4===idx){var numEle=$("#doctor_normal").html("0");_getData(app.url.yiliao.searchDoctor,{status:"C"},numEle)}else if(0===idx){var numEle=$("#doctor_asked").html("0");_getData(app.url.yiliao.searchDoctor,{status:"J"},numEle)}if(n)break}}function _getData(url,param,target){var dt={access_token:app.url.access_token,groupId:groupId};$.extend(dt,param),$http({url:url,method:"post",data:dt}).then(function(resp){1===resp.data.resultCode&&resp.data.data?(target.html(resp.data.data.total),"J"===param.status&&0===resp.data.data.total&&($rootScope.hasUncheckedMumber=!1)):console.warn("编辑失败！")},function(x){console.error(x.statusText)})}function enter(info){if(!info.isExtra&&canEdit){$scope.curIndex=null;contacts.treeWrapper.find(".back-line");"0"!=info.id&&4==itemType&&(iEdit=$('<i class="pos-edit fa fa-pencil-square-o"></i>'),iDelete=$('<i class="pos-delete fa fa-trash-o"></i>'),$(this).append(iEdit).append(iDelete)),"0"!=info.pid&&"0"!=info.id||($rootScope.curDepartmentId=info.id||"0"==info.id?info.id:null,utils.localData("curDepartmentId",$scope.curDepartmentId),iAdd=$('<i class="pos-add fa fa-plus"></i>'),$(this).append(iAdd),iAdd.click(function(e){var evt=e||window.event;evt.stopPropagation(),$state.go("app.contacts.list.add")})),"0"!=info.id&&4==itemType&&(iEdit.click(function(e){var evt=e||window.event;evt.stopPropagation(),$rootScope.targetDepartmentParentId=info.pid,$rootScope.targetDepartmentId=info.id,$rootScope.targetDepartmentName=info.name,$rootScope.targetDepartmentDescription=info.description,$state.go("app.contacts.list.edit")}),iDelete.click(function(e){var evt=e||window.event;evt.stopPropagation(),$rootScope.targetDepartmentId=info.id,$rootScope.targetDepartmentName=info.name;var htmlStr='<div class="clearfix"><i class="txt-warn pull-left thumb-md avatar fa fa-warning"></i><div class="clear"><div class="h4 m-t-xs m-b-xs text-left text-primary">'+info.name+'</div><small class="text-muted">若该组织下含有医生，您先将其移走或删除。您确定要移除该组织吗？</small></div></div></div>';modal.confirm("移除组织",htmlStr,function(){$http({url:app.url.yiliao.deleteByDepart,method:"post",data:{access_token:app.url.access_token,ids:$scope.targetDepartmentId}}).then(function(resp){1===resp.data.resultCode?$state.go("app.contacts.list",{},{reload:!0}):(console.warn("移除失败！"),modal.toast.error(resp.data.resultMsg))},function(x){console.error(x.statusText)})})}))}}function leave(info){!info.isExtra&&canEdit&&($scope.curIndex=null,"0"!=info.pid&&"0"!=info.id||iAdd.remove(),"0"!=info.id&&4==itemType&&(iEdit.remove(),iDelete.remove()))}function forward(info){$scope.curIndex=null,$rootScope.isSearching=!1,ids=[],2==itemType&&"0"!=info.id&&(info.id%1e4>0&&ids.push(info.id-(1*info.id%1e4+"")+""),info.id%100>0&&ids.push(info.id-(1*info.id%100+"")+"")),ids.push(info.id),$rootScope.itemId=ids,utils.localData("itemId",ids),$state.go("app.contacts.list",{id:ids.join("_")+"/"+itemType+"/"+statusType},{reload:!1})}function setSearchBar(){var keyIpt=$("#key_ipt"),timer=0,tmpKey="not empty!!!!!!!!!!",curLine=$(".cur-line"),curBkLine=$(".cur-back-line");keyIpt.val($rootScope.keyword),keyIpt.focus(function(){0!==$(".cur-line").length&&(curLine=$(".cur-line"),curBkLine=$(".cur-back-line")),timer=setInterval(function(){var val=$.trim(keyIpt.val());$rootScope.keyword=val,tmpKey!==val&&/\S+/.test(val)?$rootScope.keyword=tmpKey=val:val||"0"==val||($rootScope.loaded=!0,tmpKey="not empty!!!!!!!!!!",$rootScope.isSearching=!1)},100)}),keyIpt.blur(function(){}),$rootScope.keyword&&keyIpt.trigger("focus"),$scope.back=function(){$rootScope.isSearching=!1,clearInterval(timer),window.history.back()},$scope.submit=function(){var val=$.trim(keyIpt.val());return $rootScope.keyword=tmpKey=val,tmpKey||"0"==tmpKey?($rootScope.isSearching=!0,utils.localData("tmpKey",tmpKey),$rootScope.loaded=!1,void $state.go("app.contacts.search",{key:tmpKey+"_"+(new Date).getTime()},{reload:!1})):void modal.toast.warn("请输入搜索关键字!")}}console.log("test");var cnt_list=$("#cnt_list"),groupId=(cnt_list.find(".list-group-item"),utils.localData("curGroupId")),dataURL=app.url.yiliao.getDepartments;$scope.loading=!0,$rootScope.loaded=!0,$rootScope.isSearching=!1,$rootScope.memberNotInGroup=!0;var beReturn=!1;if(Group.handle(groupId,function(group){"S"===group.isBlocked&&$rootScope.roleX&&($state.go("app.group_in_blocked_status"),beReturn=!0)}),!beReturn){var statusType=1;$scope.getFilterData=function(type,e){var evt=e||window.event,target=evt.target||evt.srcElement,marks=$(".group-mark");switch("A"!=target.nodeName&&(target="DIV"!=target.nodeName?target.parentNode.parentNode:target.parentNode),evt.stopPropagation(),evt.preventDefault(),marks.removeClass("mark-focus"),$(target).addClass("mark-focus"),statusType=type,"1"==type?$state.go("app.contacts.list",{id:ids.join("_")+"/"+itemType+"/"+statusType},{reload:!1}):$state.go("app.contacts.list",{id:ids.join("_")+"/"+itemType+"/"+statusType+"/nav"},{reload:!1}),type){case 1:$scope.memberNotInGroup=!0;break;case 2:case 3:case 4:$scope.memberNotInGroup=!1}};var canEdit=!0,itemType=1*utils.localData("itemType")||1;$scope.showType=itemType||1,$scope.changeType=function(){switch(itemType=1*$scope.showType,statusType=1,utils.localData("itemType",itemType),$(".group-mark").removeClass("mark-focus").eq(0).addClass("mark-focus"),itemType){case 1:canEdit=!1,dataURL=app.url.yiliao.getDepartments,loadTree(),setTimeout(function(){getNumber(app.url.yiliao.searchDoctor,{access_token:app.url.access_token,groupId:groupId,deptId:"Undefined",status:"C"},function(n){null!=n&&void 0!=n&&$("#doctor_undistributed").html(n)})},200);break;case 2:canEdit=!1,dataURL=app.url.yiliao.getGroupRegion,loadTree(),getNumber(app.url.yiliao.searchDoctor,{access_token:app.url.access_token,groupId:groupId,areaId:"Undefined",status:"C"},function(n){null!=n&&void 0!=n&&$("#doctor_undistributed").html(n)});break;case 3:canEdit=!1,dataURL=app.url.yiliao.getServiceType,loadTree(),getNumber(app.url.yiliao.searchDoctor,{access_token:app.url.access_token,groupId:groupId,packId:"Undefined",status:"C"},function(n){null!=n&&void 0!=n&&$("#doctor_undistributed").html(n)});break;case 4:canEdit=!0,dataURL=app.url.yiliao.getAllData,loadTree(),getNumber(app.url.yiliao.getUndistributed,{access_token:app.url.access_token,groupId:groupId},function(n){null!=n&&void 0!=n&&$("#doctor_undistributed").html(n)})}};var contacts,loadTree=function(){contacts=new Tree("cnt_list",{hasCheck:!1,allCheck:!1,multiple:!1,allHaveArr:!1,self:!0,search:!1,arrType:[1,1,0],data:{url:dataURL,param:{access_token:app.url.access_token,groupId:groupId}},async:!1,icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check",root:"fa fa-hospital-o dcolor",branch:"fa fa-h-square dcolor",leaf:"fa fa-h-square dcolor",head:"headPicFileName"},root:{selectable:!0,name:utils.localData("curGroupName"),id:0},datakey:{id:"id",name:"name",sub:"subList"},info:{name:"name",id:"id",pid:"parentId",description:"description",isExtra:"isExtra"},extra:[{name:1==itemType?"未分配科室":2==itemType?"未分配区域":3==itemType?"未开启服务":"已加入,未分配",id:"Undefined",subList:[],icon:"fa fa-bookmark"}],events:{click:forward,mouseenter:enter,mouseleave:leave},callback:function(){$scope.toCurPage()}})};$scope.changeType(),$rootScope.toCurPage=function(){if($scope.curDepartmentId){for(var dts=contacts.getTree().find("dt"),i=0;i<dts.length;i++)if(dts.eq(i).data("info")&&dts.eq(i).data("info").id===$scope.curDepartmentId){$rootScope.isSearching||dts.eq(i).trigger("click");break}}else{var curDepartment=cnt_list.find(".cnt-list-warp").first();$rootScope.isSearching||curDepartment.find("dt").eq(0).trigger("click")}};var iAdd,iEdit,iDelete;$rootScope.ReInitStatusList=ReInitStatusList,ReInitStatusList();var ids=[];$scope.addUnit=function(){$state.go("app.contacts.list.add")},$scope.invite=function(){$state.go("app.contacts.list.invite")},$scope.addDoctor=function(){$state.go("app.create_doctor_account")},$scope.editUnit=function(){$rootScope.obj.id&&($rootScope.details=$rootScope.obj,setStatus(status_false),$state.go("app.org.edit"))};var mask=$('<div class="mask"></div>'),container=$("#dialog-container"),doIt=($("#dialog"),function(){});$rootScope["do"]=function(){doIt()},$rootScope.cancel=function(){mask.remove(),container.addClass("none")},$scope["return"]=function(){$rootScope.ids=[],setStatus(status),window.history.back()},setSearchBar()}});