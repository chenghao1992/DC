"use strict";app.controller("ContactsInvite",function($rootScope,$scope,$state,$timeout,$http,utils,modal){function invite(){$scope.viewData.numbers=[],$scope.viewData.hasGroupNumbers=[],$scope.viewData.otherGroupNumbers=[];var _success=!1;$http({url:app.url.yiliao.saveBatchInvite,method:"post",data:param}).then(function(resp){loading.addClass("hide"),$scope.isBLoading=!1;var _data=resp.data.data;if(_data){for(var _params=param.telepNumsOrdocNums,i=0;i<_params.length;i++){var _pData=_params[i];_data[_pData]&&_data[_pData].note?$scope.viewData.numbers.push(_params[i]):_data[_pData]&&"已加入本集团"===_data[_pData].msg?$scope.viewData.hasGroupNumbers.push(_params[i]):_data[_pData]&&"已加入其他集团"===_data[_pData].msg&&$scope.viewData.otherGroupNumbers.push(_params[i])}if(0===$scope.viewData.numbers.length)for(var k in _data)_data[k].note&&(_success=!0)}if(1===resp.data.resultCode&&!_data.wrong&&$scope.viewData.numbers.length>0||_success){$scope.viewData.numbers,keys.length;if(wrongNumber)for(var wNumbers=wrongNumber.split(","),i=0;i<wNumbers.length;i++){var idx=keys.indexOf(wNumbers[i]);idx!==-1&&keys.splice(idx,1)}if(nopassNumber)for(var nNumbers=nopassNumber.split(","),i=0;i<nNumbers.length;i++){var idx=keys.indexOf(nNumbers[i]);idx!==-1&&keys.splice(idx,1)}if($scope.viewData.hasGroupNumbers.length>0)for(var inGroupNumbers=$scope.viewData.hasGroupNumbers,i=0;i<inGroupNumbers.length;i++){var idx=keys.indexOf(inGroupNumbers[i]);idx!==-1&&keys.splice(idx,1)}if($scope.viewData.otherGroupNumbers.length>0)for(var otherGroupNumber=$scope.viewData.otherGroupNumbers,i=0;i<otherGroupNumber.length;i++){var idx=keys.indexOf(otherGroupNumber[i]);idx!==-1&&keys.splice(idx,1)}keys.length>0&&($scope.showSuccess=!0,$scope.viewData.numbers=keys.toString()),$scope.showNoneResult=!1}else resp.data.data.wrong?($scope.inGroup=!1,$scope.otherGroup=!1,$scope.showSuccess=!1,$scope.showNoneResult=!0,$scope.hasNoResult=!0,$scope.viewData.keys=_data.wrong,wrongNumber=_data.wrong):($scope.showNoneResult=!1,$scope.viewData.info_text="邀请失败！");$scope.viewData.hasGroupNumbers.length>0&&($scope.inGroup=!0,$scope.viewData.hasGroupNumbers=$scope.viewData.hasGroupNumbers.toString()),$scope.viewData.otherGroupNumbers.length>0&&($scope.otherGroup=!0,$scope.viewData.otherGroupNumbers=$scope.viewData.otherGroupNumbers.toString())},function(x){console.error(x.statusText)})}var container=$("#dialog_container"),ipt=$("#doctorInfo"),keys=null,tmpKey=keys,groupId=utils.localData("curGroupId"),loading=$("#is_loading").addClass("hide");$scope.viewData={},$scope.formData={},$scope.showNoneResult=!1,$scope.showMsgBox=!1,$scope.showSuccess=!1,$scope.hasNoResult=!0,$scope.showNopass=!1,$scope.inGroup=!1,$scope.otherGroup=!1,$scope.isNopass=!1,$scope.isBLoading=!1;var keyType=$("#key_type"),keyName="",type="",phone=/^(13[0-9]|14[57]|15[0-9]|17[0678]|18[0-9])[0-9]{8}$/,doctorNum=/^[0-9]{1,10}$/,timer=0;keyType.html('<i class="fa fa-question-circle"></i>'),ipt.on("focus",function(){timer=setInterval(function(){keys=ipt.val(),tmpKey!=keys&&(tmpKey&&tmpKey.length>keys.length&&ipt.css("height","auto"),ipt[0].scrollHeight>=200&&ipt.css("overflow-y","auto"),ipt.css("height",ipt[0].scrollHeight+2),tmpKey=keys)},200)}),ipt.on("blur",function(){clearInterval(timer)}),ipt.trigger("focus");var doIt=function(){var ttl,dpt,hsp,dt=null;return keys=ipt.val(),keys=keys.split(/\D+/),keys[0].match(/\d/)||keys.splice(0,1),keys[keys.length-1].match(/\d/)||keys.splice(keys.length-1,1),keys?(phone.test(keys)?(dt={access_token:app.url.access_token,keyWord:keys},keyName="telephone",$scope.formData.phone=keys):doctorNum.test(keys)?(dt={access_token:app.url.access_token,keyWord:keys},keyName="doctorNum",$scope.formData.phone=keys):(dt={access_token:app.url.access_token,keyWord:keys},keyName=" ",$scope.formData.phone=keys),void $http({url:app.url.doctor.searchs,method:"post",data:dt}).then(function(resp){var dt=resp.data.data;if(dt){for(var i=0;i<dt.length;i++)if("telephone"===keyName&&dt[i].telephone===keys||"doctorNum"===keyName&&dt[i].doctor.doctorNum===keys){dt=dt[i];break}dt.doctor&&(ttl=dt.doctor.title||"--",dpt=dt.doctor.departments||"--",hsp=dt.doctor.hospital||"--",$scope.formData.id=dt._id,$scope.viewData.name=dt.name||"--",$scope.viewData.headPicFile=dt.headPicFileName||"src/img/a0.jpg"),2===dt.hasGroup&&1===dt.status&&dt.doctor?($scope.showNoneResult=!1,$scope.showResult=!0,$scope.viewData.info=ttl+" / "+dpt+" / "+hsp):1===dt.hasGroup&&dt.doctor?($scope.showResult=!0,$scope.showNoneResult=!1,$scope.hasNoResult=!1,$scope.isNopass=!1,$scope.hasGroup=!0,$scope.viewData.info=ttl+" / "+dpt+" / "+hsp):1!==dt.status&&1!==dt.hasGroup&&dt.doctor?($scope.showResult=!0,$scope.showNoneResult=!1,$scope.hasNoResult=!1,$scope.hasGroup=!1,$scope.isNopass=!1,$scope.viewData.info=ttl+" / "+dpt+" / "+hsp):($scope.showResult=!1,$scope.showNoneResult=!0,$scope.hasGroup=!1,$scope.isNopass=!1,$scope.hasNoResult=!0,$scope.viewData.keys=keys+" ("+type+") ")}},function(x){console.error(x.statusText)})):(keyType.html('<i class="text-danger">无效查询！</i>'),void console.warn("无效查询！"))};$scope.invite=function(){var param={access_token:app.url.access_token,groupId:groupId,doctorId:$scope.formData.id};$scope.inviteAgain&&(param.againInvite=1),$http({url:app.url.yiliao.saveByGroupDoctor,method:"post",data:param}).then(function(resp){1===resp.data.resultCode&&2!==resp.data.data.status?($scope.showResult=!1,$scope.showSuccess=!0):1!==resp.data.resultCode||2!==resp.data.data.status||resp.data.data.sms?1===resp.data.resultCode&&2===resp.data.data.status?($scope.showResult=!1,$scope.showWarn=!1,$scope.inviteAgain=!1,$scope.showSuccess=!0,$scope.viewData.info_text=resp.data.data.msg):($scope.showResult=!1,$scope.showWarn=!0,$scope.inviteAgain=!1,$scope.viewData.info_text=resp.data.resultMsg,console.log("[邀请失败！] "+resp.data.resultMsg)):($scope.showResult=!1,$scope.showWarn=!0,$scope.inviteAgain=!0,$scope.viewData.info_text=resp.data.data.msg)},function(x){console.error(x.statusText)})};var param={},wrongNumber=null,nopassNumber=null;$scope.batchInvite=function(){return keys=ipt.val(),$scope.showSuccess=!1,$scope.inGroup=!1,$scope.otherGroup=!1,loading.removeClass("hide"),keys=keys.split(/\D+/),keys[0].match(/\d/)||keys.splice(0,1),keys.length>0&&!keys[keys.length-1].match(/\d/)&&keys.splice(keys.length-1,1),keys=utils.unique(keys),keys&&0!==keys.length?(param.access_token=app.url.access_token,param.groupId=groupId,param.telepNumsOrdocNums=keys,param.ignore=!1,wrongNumber=null,nopassNumber=null,void invite()):(loading.addClass("hide"),void modal.toast.warn("请输入有效号码！"))},$scope.batchInviteAnyway=function(){$scope.showSuccess=!1,$scope.isBLoading=!0,param.ignore=!0,invite()},$scope.sendMsg=function(){$scope.showNoneResult=!1,$scope.showMsgBox=!0},$scope.doSend=function(){$http({url:app.url.yiliao.saveByGroupDoctor,method:"post",data:{access_token:app.url.access_token,telephone:$scope.formData.phone,groupId:groupId}}).then(function(resp){1===resp.data.resultCode?($scope.showMsgBox=!1,$scope.showSuccess=!0):($scope.showMsgBox=!1,$scope.showWarn=!0)},function(x){console.error(x.statusText)})},$scope.query=function(){$scope.showMsgBox=!1,$scope.showSuccess=!1,$scope.showWarn=!1,doIt()},$scope["return"]=function(){$scope.showResult=!1,$scope.showNoneResult=!1,$scope.hasGroup=!1,$scope.isNopass=!1,$scope.hasNoResult=!1},$scope.cancel=function(){"function"==typeof $rootScope.ReInitStatusList&&$rootScope.ReInitStatusList(),"function"==typeof $rootScope.ReInitStatusList&&$rootScope.initContacsTable(),container.prev().remove(),container.remove(),window.history.back()}});