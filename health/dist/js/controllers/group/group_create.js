"use strict";app.controller("groupCreate",["$rootScope","$scope","$modal","$log","$http","$state","$stateParams","utils","toaster","modal","Group",function($rootScope,$scope,$modal,$log,$http,$state,$stateParams,utils,toaster,modal,Group){function getCheckInfo(){$http.post(app.url.yiliao.groupApplyInfo,{access_token:app.url.access_token,groupId:groupId||localStorage.getItem("curId")}).success(function(data){1===data.resultCode?($scope.groupName=data.data.name,$scope.groupInfo=data.data.introduction,$scope.auditMsg=data.data.auditMsg):toaster.pop("error",null,data.resultMsg)}).error(function(data){$scope.authError=data.resultMsg})}$scope.financialState=!0;var groupId=localStorage.getItem("curGroupId"),doctorId=$scope.datas.user_id||utils.localData("user_id"),logoImg=null;Group.handle(groupId,function(group){if(!group.name)return $scope.step_apply=!0,$scope.step_check=!1,$scope.step_active=!1,$scope.step_status=!0,void(logoImg=$scope.groupLogoUrl=utils.localData("headPicFile")||"src/img/logoDefault.jpg");switch(group.status.applyStatus){case"P":$rootScope.canCreateGroup?($scope.un_check=!1,$scope.step_apply=!0,$scope.step_check=!1,$scope.step_active=!1,$scope.step_status=!0,logoImg=$scope.groupLogoUrl=utils.localData("headPicFile")||"src/img/logoDefault.jpg"):($scope.pass=!0,$scope.step_apply=!0,$scope.step_check=!0,$scope.step_active=!0,$scope.step_status=!0);break;case"NP":$scope.step_apply=!0,$scope.step_check=!0,$scope.step_active=!1,$scope.no_pass=!0,$scope.step_status=!1,logoImg=group.logo,$scope.groupLogoUrl=group.logo,getCheckInfo();break;case"A":$scope.un_check=!0,$scope.step_apply=!0,$scope.step_check=!0,$scope.step_active=!1,$scope.step_status=!0;break;default:$scope.un_check=!1,$scope.step_apply=!0,$scope.step_check=!1,$scope.step_active=!1,$scope.step_status=!0,logoImg=$scope.groupLogoUrl=utils.localData("headPicFile")||"src/img/logoDefault.jpg"}group.status.active&&"active"!==group.status.active||void 0===$rootScope.canCreateGroup||$rootScope.canCreateGroup?"inactive"===group.status.active?$scope.status_normal=!1:$scope.step_status=!0:$state.go("app.setting.group_edit")}),$scope.submitBt=function(){$scope.regGroup()},$scope.regGroup=function(){var params={access_token:app.url.access_token,name:$scope.groupName,introduction:$scope.groupInfo,applyUserId:doctorId};$scope.isReapply&&(params.id=groupId),params.logoUrl=logoImg||utils.localData("headPicFile")||"src/img/logoDefault.jpg",$http.post(app.url.yiliao.groupApply,params).success(function(data){1===data.resultCode?($scope.isActive=!1,Group.set("status.applyStatus","A"),$scope.isReapply||!$scope.isReapply&&!$scope.pass&&!$scope.step_apply?$state.go("app.group_create",null,{reload:!0}):$rootScope.verifyByGuser(data.data.groupId,data.data.applyUserId),$scope.isReapply=!1):modal.toast.error(data.resultMsg)}).error(function(data){modal.toast.error(data.resultMsg)})},groupId&&($scope.logoUpdate=!0),$scope.reapply=function(){$scope.isReapply=!0,$scope.step_apply=!0,$scope.step_check=!1,$scope.step_active=!1,$scope.step_status=!0},$scope.selectFile=function(){$scope.upload()},$scope.token=localStorage.getItem("access_token"),$scope.uploaderAdded=function(up,files){$scope.uploadBoxOpen=!0},$scope.progress=function(up,file){$scope.groupLogoProgress=file.percent},$scope.uploaderSuccess=function(up,file,info){file.url&&($scope.groupLogoUrl=file.url,logoImg=file.url,$scope.$apply()),file.result="上传成功！",toaster.pop("success",null,"头像上传成功！")},$scope.uploaderError=function(up,err,errTip){toaster.pop("error",null,errTip)}}]);