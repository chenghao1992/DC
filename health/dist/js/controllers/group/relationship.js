"use strict";app.controller("Relationship",function($rootScope,$scope,$state,$http,$compile,utils,modal,uiLoad,JQ_CONFIG,Doctor,AppFactory,Group){function enter(info){$scope.curIndex=null;contacts.tree.find(".back-line");iEdit=$('<i class="pos-edit fa fa-pencil-square-o"></i>'),iDelete=$('<i class="pos-delete fa fa-trash-o"></i>'),$(this).append(iEdit).append(iDelete),iEdit.click(function(e){var evt=e||window.event;evt.stopPropagation(),$rootScope.targetDoctorParentId=info.pid,$rootScope.targetDoctorId=info.id,$rootScope.targetDoctorName=info.name,$rootScope.groupProfit=info.groupProfit,$rootScope.superProfit=info.superProfit,$state.go("app.relationship.list.edit")}),iDelete.click(function(e){var evt=e||window.event;evt.stopPropagation(),$rootScope.targetDoctorId=info.id,$rootScope.targetDoctorName=info.name,$state.go("app.relationship.list.delete")})}function leave(info){$scope.curIndex=null,iEdit.remove(),iDelete.remove()}function forward(info){$scope.curIndex=null,$rootScope.targetDoctorParentId=info.pid,$rootScope.targetDoctorId=info.id,$rootScope.targetDoctorName=info.name,$rootScope.groupProfit=info.groupProfit||0,$rootScope.superProfit=info.superProfit||0,$rootScope.curDoctorId=info.id||null,utils.localData("curDoctorId",$scope.curDoctorId),$state.go("app.relationship.edit",{id:info.id},{reload:!1})}function initRoute(dt){var n=0;!function getPrent(dt){dt.parent?(routeItem.unshift(dt),level.push(n++),getPrent(dt.parent)):(routeItem.unshift(dt),level.push(n++))}(dt)}function setLevel(dt){if(isListMode){if(dt){for(var isExist=!1,i=0;i<routeItem.length;i++)if(dt.id===routeItem[i].id){isExist=!0;break}isExist||(level.push(num),routeItem.push(dt),num++)}}else num=0,level=[],initRoute(dt);setLevelRoute(),initTable()}function setLevelRoute(){function locateTo(){var _n=$(this).data("level");if(isListMode)_n<level.length-1&&(level.splice(_n+1,level.length-_n-1),routeItem.splice(_n+1,routeItem.length-_n-1),$(this).nextAll().remove(),routeItem[_n].childrenCount>0||routeItem[_n].children&&routeItem[_n].children.length>0?(param.parentId=routeItem[_n].id,setLevel()):(param.parentId=0,num=0,level=[],routeItem=[],setLevel({id:0,name:utils.localData("curGroupName")})),num=_n+1);else{var _dt=utils.queryByKey(inviteData,routeItem[_n].id,!0,["parent"],["id"]);$scope.centerNode(_dt)}}var len=level.length;route.html("");for(var i=0;i<len;i++){if(0===i)var a=$('<a class="route-link route-first fa fa-hospital-o">'+(routeItem[i].name||"")+"</a>");else if(i===len-1)var a=$('<a class="route-link route-last">'+(routeItem[i].name||"")+"</a>");else var a=$('<a class="route-link">'+(routeItem[i].name||"")+"</a>");a.click(locateTo),a.data("level",i),route.append(a)}}function initTable(data){var _index,_start,subs=[],index=1,start=0,searchTimes=0,length=1*utils.localData("page_length")||50,setTable=function(){function submit(){route.addClass("none"),$scope.searching=!0,keyWord||"0"==keyWord?(param={groupId:groupId,keyword:keyWord},listUrl=app.url.yiliao.searchByKeyword):listUrl=app.url.yiliao.getProfitList,initTable()}$rootScope.isSearch?doctorList=$("#searchList"):(doctorList=!$scope.isServiceGroup&&$scope.currentOrgInfo&&1==$scope.currentOrgInfo.orgType?$("#contactsList_a"):$scope.isServiceGroup?$("#contactsList_c"):$("#contactsList_b"),doctorList.removeClass("hide")),dTable&&dTable.fnDestroy(),dTable=doctorList.dataTable({draw:index,displayStart:start,lengthMenu:[5,10,15,20,30,40,50,100],pageLength:length,bServerSide:!0,sAjaxSource:listUrl,fnServerData:function(sSource,aoData,fnCallback){param.pageIndex=index-1,param.pageSize=aoData[4].value,param.keyword=keyWord,param.access_token=app.url.access_token,isSearching?(route.html(""),sSource=app.url.yiliao.getProfitListByKeyword):sSource=app.url.yiliao.getProfitList,$http({method:"post",url:sSource,data:param}).then(function(resp){if(!(resp&&resp.data&&resp.data.data))return void modal.toast.error("数据获取失败!");resp=resp.data.data;for(var i=0;i<resp.pageData.length;i++)utils.extendHash(resp.pageData[i],["name","contactWay","attributes","departments","title","departmentFullName","children"]);resp.start=resp.start,resp.recordsTotal=resp.total,resp.recordsFiltered=resp.total,resp.length=resp.pageSize,resp.data=resp.pageData,fnCallback(resp),$scope.loading=!1,$rootScope.loaded=!0})},processing:!0,language:app.lang.datatables.translation,createdRow:function(nRow,aData,iDataIndex){if(aData.childrenCount){var btn=$('<button class="btn btn-info">'+aData.childrenCount+"</button>");$(nRow).find(".next-level").append(btn),btn.on("click",aData,function(e){var evt=e||window.event;evt.stopPropagation(),route.removeClass("none"),param.parentId=e.data.id,keyWord="",isSearching=!1,setLevel(e.data)})}var a_link=$(nRow).find(".a-link");a_link.click(function(){$scope.seeDetails(aData.id)})},columns:$scope.isServiceGroup?[{orderable:!1,render:function(set,status,dt){if(dt.headPicFileName)var path=dt.headPicFileName;else var path="src/img/a0.jpg";return'<img class="a-link" src="'+path+'"/></a>'},searchable:!1},{orderable:!1,render:function(set,status,dt){return'<a class="a-link">'+dt.name+"</a>"}},{data:"departmentFullName",orderable:!1},{data:"title",orderable:!1},{data:"contactWay",orderable:!1},{render:function(set,status,dt){return""},orderable:!1,searchable:!1},{render:function(set,status,dt){var a=dt.appointmentGroupProfit,b=dt.appointmentParentProfit;return'<p class="l-h-2x">'+(a?a+" %":"0")+"<br/>"+(b?b+" %":"0")+"</p>"},orderable:!1,searchable:!1},{render:function(set,status,dt){return""},orderable:!1,searchable:!1},{render:function(set,status,dt){var a=dt.carePlanGroupProfit,b=dt.carePlanParentProfit;return'<p class="l-h-2x">'+(a?a+" %":"0")+"<br/>"+(b?b+" %":"0")+"</p>"},orderable:!1,searchable:!1},{render:function(set,status,dt){return""},orderable:!1,searchable:!1},{render:function(set,status,dt){var a=dt.chargeItemGroupProfit,b=dt.chargeItemParentProfit;return'<p class="l-h-2x">'+(a?a+" %":"0")+"<br/>"+(b?b+" %":"0")+"</p>"},orderable:!1,searchable:!1},{render:function(set,status,dt){return""},orderable:!1,searchable:!1},{render:function(set,status,dt){var a=dt.textGroupProfit,b=dt.textParentProfit;return'<p class="l-h-2x">'+(a?a+" %":"0")+"<br/>"+(b?b+" %":"0")+"</p>"},orderable:!1,searchable:!1},{render:function(set,status,dt){return""},orderable:!1,searchable:!1},{render:function(set,status,dt){var a=dt.phoneGroupProfit,b=dt.phoneParentProfit;return'<p class="l-h-2x">'+(a?a+" %":"0")+"<br/>"+(b?b+" %":"0")+"</p>"},orderable:!1,searchable:!1},{render:function(set,status,dt){if(dt.childrenCount){var btnStr='<span class="next-level"></span>';return btnStr}return""},orderable:!1,searchable:!1}]:[{orderable:!1,render:function(set,status,dt){if(dt.headPicFileName)var path=dt.headPicFileName;else var path="src/img/a0.jpg";return'<img class="a-link" src="'+path+'"/></a>'},searchable:!1},{orderable:!1,render:function(set,status,dt){return'<a class="a-link">'+dt.name+"</a>"}},{data:"departmentFullName",orderable:!1},{data:"title",orderable:!1},{data:"contactWay",orderable:!1},{orderable:!1,render:function(set,status,dt){return dt.carePlanGroupProfit?dt.carePlanGroupProfit+"%":0}},{orderable:!1,render:function(set,status,dt){return dt.carePlanParentProfit?dt.carePlanParentProfit+"%":0}},{orderable:!1,render:function(set,status,dt){return dt.clinicGroupProfit?dt.clinicGroupProfit+"%":0}},{orderable:!1,render:function(set,status,dt){return dt.clinicParentProfit?dt.clinicParentProfit+"%":0}},{orderable:!1,render:function(set,status,dt){return dt.textGroupProfit?dt.textGroupProfit+"%":0}},{orderable:!1,render:function(set,status,dt){return dt.textParentProfit?dt.textParentProfit+"%":0}},{orderable:!1,render:function(set,status,dt){return dt.phoneGroupProfit?dt.phoneGroupProfit+"%":0}},{orderable:!1,render:function(set,status,dt){return dt.phoneParentProfit?dt.phoneParentProfit+"%":0}},{render:function(set,status,dt){if(dt.childrenCount){var btnStr='<span class="next-level"></span>';return btnStr}return""},orderable:!1,searchable:!1}]});var contactsList_filter=$("#list_view .dataTables_filter"),_form=$("<form></form>"),_lbl=contactsList_filter.addClass("group-search").children("label").append(_i),_i=$('<i ng-show="loaded" class="fa icon-magnifier"></i>'),_ipt=_lbl.find("input").attr("placeholder","搜索...").attr("autocomplete","off"),_timer=0,_temp="";contactsList_filter.append(_form),_form.append(_lbl),_lbl.html("").append(_ipt).append(_i),_ipt.focus(function(){_timer=setInterval(function(){var val=$.trim(_ipt.val());val?(isSearching=!0,_i.removeClass("icon-magnifier").addClass("fa-times-circle"),keyWord=_temp=val):(isSearching=!1,_i.removeClass("fa-times-circle").addClass("icon-magnifier"),_temp&&!val&&(route.removeClass("none"),$scope.searching=!1,keyWord=_temp="",start=length*(index-1),dTable.fnDestroy(),param={groupId:groupId,parentId:0},listUrl=app.url.yiliao.getProfitList,initTable()))},100)}),_ipt.blur(function(){clearInterval(_timer)}),_i.click(function(){route.removeClass("none"),isSearching=!1,keyWord=_temp="",_ipt.trigger("submit"),_ipt.val(""),_i.removeClass("fa-times-circle").addClass("icon-magnifier"),start=length*(index-1),dTable.fnDestroy(),param={groupId:groupId,parentId:0},listUrl=app.url.yiliao.getProfitList,initTable()}),_ipt.val(keyWord).trigger("focus"),utils.keyHandler(_ipt,{key13:submit}),dTable.off().on("draw.dt",function(e,settings){}).on("length.dt",function(e,settings){index=1,start=0}).on("page.dt",function(e,settings){subs=[],isSearching||(index=settings._iDisplayStart/length+1)}).on("search.dt",function(e,settings){isSearching?(index=1,start=0):searchTimes>0&&(searchTimes=0,index=_index,start=_start,listUrl=app.url.yiliao.getProfitList,dTable.fnDestroy(),setTable())})};setTable()}function graphicMode(){uiLoad.load(JQ_CONFIG.d3).then(function(){var dragListener,node,scale,x,y,dragStarted,domNode,nodes,target,parentLink,relCoords,links,nodePaths,nodesExit,panTimer,translateCoords,translateX,translateY,scaleX,scaleY,overlayWidth=100,makeTree=function(){function initTree(){function visit(parent,visitFn,childrenFn){if(parent){visitFn(parent);var children=childrenFn(parent);if(children)for(var count=children.length,i=0;i<count;i++)visit(children[i],visitFn,childrenFn)}}function sortTree(){tree.sort(function(a,b){return(b.name&&b.length>0?b.name:"").toLowerCase()<(a.name&&a.length>0?a.name:"").toLowerCase()?1:-1})}function pan(domNode,direction){var speed=panSpeed;panTimer&&(clearTimeout(panTimer),translateCoords=d3.transform(svgGroup.attr("transform")),"left"==direction||"right"==direction?(translateX="left"==direction?translateCoords.translate[0]+speed:translateCoords.translate[0]-speed,translateY=translateCoords.translate[1]):"up"!=direction&&"down"!=direction||(translateX=translateCoords.translate[0],translateY="up"==direction?translateCoords.translate[1]+speed:translateCoords.translate[1]-speed),scaleX=translateCoords.scale[0],scaleY=translateCoords.scale[1],scale=zoomListener.scale(),svgGroup.transition().attr("transform","translate("+translateX+","+translateY+")scale("+scale+")"),d3.select(domNode).select("g.node").attr("transform","translate("+translateX+","+translateY+")"),zoomListener.scale(zoomListener.scale()),zoomListener.translate([translateX,translateY]),panTimer=setTimeout(function(){pan(domNode,speed,direction)},50))}function zoom(){svgGroup.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function initiateDrag(d,domNode){draggingNode=d,d3.select(domNode).select(".ghostCircle").attr("pointer-events","none"),d3.selectAll(".ghostCircle").attr("class","ghostCircle show"),d3.select(domNode).attr("class","node activeDrag"),svgGroup.selectAll("g.node").sort(function(a,b){return a.id!=draggingNode.id?1:-1}),nodes.length>1&&(links=tree.links(nodes),nodePaths=svgGroup.selectAll("path.link").data(links,function(d){return d.target.id}).remove(),nodesExit=svgGroup.selectAll("g.node").data(nodes,function(d){return d.id}).filter(function(d,i){return d.id!=draggingNode.id}).remove()),parentLink=tree.links(tree.nodes(draggingNode.parent)),svgGroup.selectAll("path.link").filter(function(d,i){return d.target.id==draggingNode.id}).remove(),dragStarted=null}function moveNode(dt){if(dt){var parentId=dt.parent?dt.parent.id:"0",param={access_token:app.url.access_token,groupId:groupId,parentId:parentId,id:dt.id};"0"==parentId?(dt.attributes.tempProfit=dt.attributes.parentProfit,dt.parentId="0"):(dt.attributes.tempProfit&&(dt.attributes.parentProfit=dt.attributes.tempProfit),dt.parent&&(dt.parentId=dt.parent.id)),$http({url:app.url.yiliao.updateProfitRelation,method:"post",data:param}).then(function(resp){1===resp.data.resultCode?modal.toast.success("修改成功！"):modal.toast.warn(resp.data.resultMsg)},function(x){console.error(x.statusText)})}}function endDrag(){selectedNode=null,d3.selectAll(".ghostCircle").attr("class","ghostCircle"),d3.select(domNode).attr("class","node"),d3.select(domNode).select(".ghostCircle").attr("pointer-events",""),updateTempConnector(),null!==draggingNode&&(update(root),centerNode(draggingNode),draggingNode=null)}function expand(d){d._children&&(d.children=d._children,d.children.forEach(expand),d._children=null)}function centerNode(source){target=source,scale=zoomListener.scale(),x=-source.y0,y=-source.x0,x=x*scale+viewerWidth/2-300,y=y*scale+viewerHeight/2,d3.select("g").transition().duration(duration).attr("transform","translate("+x+","+y+")scale("+scale+")"),zoomListener.scale(scale),zoomListener.translate([x,y])}function toggleChildren(d){return d.children?(d._children=d.children,d.children=null):d._children&&(d.children=d._children,d._children=null),d}function flex(d){d3.event.defaultPrevented||(d=toggleChildren(d),update(d),centerNode(d))}function click(d,n,e){var evt=e||window.event;if(evt.stopPropagation(),d.parentId){({name:d.name,id:d.id,pid:d.parentId,groupProfit:d.attributes.groupProfit,superProfit:d.attributes.parentProfit});centerNode(d),isListMode=!1,setLevel(d)}}function update(source){var levelWidth=[1],childCount=function(level,n){n.children&&n.children.length>0&&(levelWidth.length<=level+1&&levelWidth.push(0),levelWidth[level+1]+=n.children.length,n.children.forEach(function(d){childCount(level+1,d)}))};childCount(0,root);var newHeight=45*d3.max(levelWidth);tree=tree.size([newHeight,viewerWidth]);var nodes=tree.nodes(root).reverse(),links=tree.links(nodes);nodes.forEach(function(d){d.y=d.depth*(10*maxLabelLength)}),node=svgGroup.selectAll("g.node").data(nodes,function(d){return d.id||(d.id=++i)});var nodeEnter=node.enter().append("g").call(dragListener).attr("class","node").attr("transform",function(d){return"translate("+source.y0+","+source.x0+")"});nodeEnter.append("circle").attr("class","nodeCircle").attr("r",0).style("fill",function(d){return d._children?"lightsteelblue":"#fff"}).on("click",flex),nodeEnter.append("text").attr("x",function(d){return d.children||d._children?-10:10}).attr("dy",".35em").attr("class","nodeText").attr("text-anchor",function(d){return d.children||d._children?"end":"start"}).text(function(d){return d.name}).style("fill-opacity",0),nodeEnter.append("circle").attr("class","ghostCircle").attr("r",20).attr("opacity",.2).style("fill","red").attr("pointer-events","mouseover").on("mouseover",function(node){overCircle(node)}).on("mouseout",function(node){outCircle(node)}),node.select("text").attr("x",function(d){return d.parentId?10:d.children||d._children?-10:10}).attr("text-anchor",function(d){return d.parentId?"start":d.children||d._children?"end":"start"}).text(function(d){return d.name}).on("click",click).on("mouseover",function(d,n,e){if(d.attributes){"0"==d.parent.id;var evt=e||window.event,dt=d.attributes,_a=dt.clinicGroupProfit,_b=dt.clinicParentProfit,_c=dt.textGroupProfit,_d=dt.textParentProfit,_e=dt.phoneGroupProfit,_f=dt.phoneParentProfit,_g=dt.carePlanGroupProfit,_h=dt.carePlanParentProfit,_i=dt.consultationGroupProfit,_j=dt.consultationParentProfit,_k=dt.appointmentGroupProfit,_l=dt.appointmentParentProfit,_m=dt.chargeItemGroupProfit,_n=dt.chargeItemParentProfit,str='<img src="'+d.attributes.headPicFileName+'"/><div><b>姓名：</b>'+d.name+"<b>&nbsp;&nbsp;&nbsp;职称：</b>"+(d.attributes.title||"")+"<b>&nbsp;&nbsp;&nbsp;科室：</b>"+(d.attributes.departments||"")+"<br/><b>医院：</b>"+(d.attributes.hospital||"")+(isVPGroup?'<table style="text-align: center"><thead><tr><th></th><th>&nbsp;&nbsp;名医面对面&nbsp;&nbsp;</th><th>&nbsp;&nbsp;健康关怀&nbsp;&nbsp;</th><th>&nbsp;&nbsp;收费项&nbsp;&nbsp;</th><th>&nbsp;&nbsp;图文咨询&nbsp;&nbsp;</th><th>&nbsp;&nbsp;电话咨询&nbsp;&nbsp;</th></tr></thead>':'<table style="text-align: center"><thead><tr><th></th><th>&nbsp;&nbsp;在线门诊&nbsp;&nbsp;</th><th>&nbsp;&nbsp;图文咨询&nbsp;&nbsp;</th><th>&nbsp;&nbsp;电话咨询&nbsp;&nbsp;</th><th>&nbsp;&nbsp;健康关怀&nbsp;&nbsp;</th><th>&nbsp;&nbsp;会诊&nbsp;&nbsp;</th></tr></thead>')+"<tbody><tr><td><b>集团&nbsp;&nbsp;</b></td><td>"+(isVPGroup?(_k?_k+" %":"0")+"</td><td>"+(_g?_g+" %":"0")+"</td><td>"+(_m?_m+" %":"0")+"</td><td>"+(_c?_c+" %":"0")+"</td><td>"+(_e?_e+" %":"0"):(_a?_a+" %":"0")+"</td><td>"+(_c?_c+" %":"0")+"</td><td>"+(_e?_e+" %":"0")+"</td><td>"+(_g?_g+" %":"0")+"</td><td>"+(_i?_i+" %":"0"))+"</td></tr><tr><td><b>上级&nbsp;&nbsp;</b></td><td>"+(isVPGroup?(_l?_l+" %":"0")+"</td><td>"+(_h?_h+" %":"0")+"</td><td>"+(_n?_n+" %":"0")+"</td><td>"+(_d?_d+" %":"0")+"</td><td>"+(_f?_f+" %":"0"):(_b?_b+" %":"0")+"</td><td>"+(_d?_d+" %":"0")+"</td><td>"+(_f?_f+" %":"0")+"</td><td>"+(_h?_h+" %":"0")+"</td><td>"+(_j?_j+" %":"0"))+"</td></tr></tbody></table></div>";tips.html(str),tips.css({top:evt.clientY+20,left:evt.clientX+14}),body.append(tips)}}).on("mouseout",function(){tips.remove()}),node.select("circle.nodeCircle").attr("r",6).style("fill",function(d){return d._children?"#0f0":"#fff"});var nodeUpdate=node.transition().duration(duration).attr("transform",function(d){return"translate("+d.y+","+d.x+")"});nodeUpdate.select("text").style("fill-opacity",1);var nodeExit=node.exit().transition().duration(duration).attr("transform",function(d){return"translate("+source.y+","+source.x+")"}).remove();nodeExit.select("circle").attr("r",0),nodeExit.select("text").style("fill-opacity",0);var link=svgGroup.selectAll("path.link").data(links,function(d){return d.target.id});link.enter().insert("path","g").attr("class","link").attr("d",function(d){var o={x:source.x0,y:source.y0};return diagonal({source:o,target:o})}),link.transition().duration(duration).attr("d",diagonal),link.exit().transition().duration(duration).attr("d",function(d){var o={x:source.x,y:source.y};return diagonal({source:o,target:o})}).remove(),nodes.forEach(function(d){d.x0=d.x,d.y0=d.y})}$("#tree-container").html(""),treeData=data;var root,totalNodes=0,maxLabelLength=0,selectedNode=null,draggingNode=null,panSpeed=200,panBoundary=20,i=0,duration=750,viewerWidth=$("#tree-container").width()-15,viewerHeight=$(window).height()-195,tree=d3.layout.tree().size([viewerHeight,viewerWidth]),diagonal=d3.svg.diagonal().projection(function(d){return[d.y,d.x]});visit(treeData,function(d){totalNodes++,maxLabelLength=Math.max(d.name?d.name.length:0,maxLabelLength)+.01},function(d){return d.children&&d.children.length>0?d.children:null}),sortTree();var zoomListener=d3.behavior.zoom().scaleExtent([.1,3]).on("zoom",zoom),baseSvg=d3.select("#tree-container").append("svg").attr("width",viewerWidth).attr("height",viewerHeight).attr("class","overlay").call(zoomListener);dragListener=d3.behavior.drag().on("dragstart",function(d){d!=root&&(dragStarted=!0,nodes=tree.nodes(d),d3.event.sourceEvent.stopPropagation())}).on("drag",function(d){if(d!=root){if(dragStarted&&(domNode=this,initiateDrag(d,domNode)),relCoords=d3.mouse($("svg").get(0)),relCoords[0]<panBoundary)panTimer=!0,pan(this,"left");else if(relCoords[0]>$("svg").width()-panBoundary)panTimer=!0,pan(this,"right");else if(relCoords[1]<panBoundary)panTimer=!0,pan(this,"up");else if(relCoords[1]>$("svg").height()-panBoundary)panTimer=!0,pan(this,"down");else try{clearTimeout(panTimer)}catch(e){}d.x0+=d3.event.dy,d.y0+=d3.event.dx;var node=d3.select(this);node.attr("transform","translate("+d.y0+","+d.x0+")"),updateTempConnector()}}).on("dragend",function(d){if(d!=root)if(domNode=this,selectedNode){var index=draggingNode.parent.children.indexOf(draggingNode);index>-1&&draggingNode.parent.children.splice(index,1),"undefined"!=typeof selectedNode.children||"undefined"!=typeof selectedNode._children?"undefined"!=typeof selectedNode.children?selectedNode.children.push(draggingNode):selectedNode._children.push(draggingNode):(selectedNode.children=[],selectedNode.children.push(draggingNode)),expand(selectedNode),sortTree(),endDrag(),moveNode(d)}else endDrag()});var overCircle=function(d){selectedNode=d,updateTempConnector()},outCircle=function(d){selectedNode=null,updateTempConnector()},updateTempConnector=function(){var data=[];null!==draggingNode&&null!==selectedNode&&(data=[{source:{x:selectedNode.y0,y:selectedNode.x0},target:{x:draggingNode.y0,y:draggingNode.x0}}]);var link=svgGroup.selectAll(".templink").data(data);link.enter().append("path").attr("class","templink").attr("d",d3.svg.diagonal()).attr("pointer-events","none"),link.attr("d",d3.svg.diagonal()),link.exit().remove()};$scope.centerNode=centerNode,$(window).resize(function(){viewerWidth=$("#tree-container").width()-15,viewerHeight=$(this).height()-195,viewerWidth<0||viewerHeight<0||(baseSvg.attr("width",viewerWidth).attr("height",viewerHeight),centerNode(target))});var tips=$('<div class="tip-tool"></div>'),body=$("body"),svgGroup=baseSvg.append("g");root=treeData,root.x0=viewerHeight/2,root.y0=0,update(root),centerNode(root),window.center=$scope.center=centerNode}var path=app.url.yiliao.getProfitTree+"?access_token="+app.url.access_token+"&groupId="+groupId,dt={},data={},treeData={};inviteData?(data=inviteData,initTree()):d3.xhr(path,"application/json,text/javascript",function(error,treeDt){eval("dt="+treeDt.response),data.name=utils.localData("curGroupName"),data.children=dt.data,data.id="0",inviteData=data,initTree()}),isGrapMade=!0};makeTree("src/js/testData.json")})}$scope.currentOrgInfo=Group.getCurrentOrgInfo(),$scope.isServiceGroup=!1;var isVPGroup=!1;$scope.currentOrgInfo&&AppFactory.group.isServiceGroup($scope.currentOrgInfo.id).then(function(_data){_data?($scope.isServiceGroup=!0,isVPGroup=!0):($scope.isServiceGroup=!1,isVPGroup=!1),setLevel({id:0,name:utils.localData("curGroupName")})});var inviteData=null,tempData=null,cnt_list=$("#cnt_list"),items=cnt_list.find(".list-group-item"),dt=null,groupId=utils.localData("curGroupId"),isListMode=!0,isGrapMade=!1,listUrl=app.url.yiliao.getProfitList;$scope.isLoading=!0,$scope.loaded=!0,$scope.seeDetails=function(dt){dt&&($("#doctor_details").removeClass("hide"),$rootScope.winVisable=!0,Doctor.addData(dt))};var iEdit,iDelete,keyIpt=$("#key_ipt");$scope.submit=function(){var val=$.trim(keyIpt.val());if($scope.loaded=!1,/\S+/.test(val),!inviteData)return $scope.loaded=!0,void modal.toast.warn("数据未加载完成！");var data=utils.getDataByVal(inviteData,"name",val);data&&data.length>0?$scope.center(data[0]):modal.toast.warn("未找到相关数据！"),$scope.loaded=!0},$("#list_mode").click(function(){$(this).hasClass("active")||(isListMode=!0,$("#list_view").removeClass("hide"),$("#tree-container").addClass("hide"),$(this).addClass("active").next().removeClass("active"))}),$("#grap_mode").click(function(){$(this).hasClass("active")||(isListMode=!1,$("#tree-container").removeClass("hide"),$("#list_view").addClass("hide"),$(this).addClass("active").prev().removeClass("active"),isGrapMade||graphicMode())});var routeItem=[],level=[],num=0,route=$("#level_route"),doctorList,dTable,keyWord,isSearching=!1,param={groupId:groupId,parentId:0},dt={}});