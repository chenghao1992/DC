"use strict";app.controller("CreateDoctorAccount",function($rootScope,$scope,$state,$timeout,$http,utils,modal,$modal,$compile){function setDefaultHospital(hospital){$scope.hospital.selected.id=hospital.id,$scope.hospital.selected.name=hospital.name}function initList(param){$http({url:param.url,data:param.data,method:param.method}).then(function(dt){function makeList(data){var len=data.length,ul=$('<ul class="eara-list"></ul>');access_level%2===0?ul.addClass("bg-even"):ul.addClass("bg-odd"),ul.data("level",access_level);for(var i=0;i<len;i++){var li=$("<li></li>");li.data(param.key,data[i][param.key]),li.data("name",data[i].name),li.click(function(){route.find(".route-link").eq(3).remove(),search.val(""),$(this).parent().nextAll().remove(),access_level=$(this).parent().data("level"),key&&(key="code");var link=$("#link_"+access_level);link.length>0?link.nextAll().remove():(link=$('<a class="route-link"></a>'),link.attr("id","link_"+access_level)),link.html($(this).data("name")),route.append(link),link.data("offsetTop",panel.scrollTop()),link.data("offsetLeft",panel.scrollLeft()),link.off().on("click",function(){var top=1*$(this).data("offsetTop");1*$(this).data("offsetLeft");panel.scrollTop(top).scrollLeft(0)});var data_key=$(this).data(param.key);if(access_level%2===0?($(this).siblings().removeClass("item-odd"),$(this).addClass("item-odd")):($(this).siblings().removeClass("item-even"),$(this).addClass("item-even")),3===access_level){var url=app.url.admin.check.getHospitals;key="id"}else{var url=param.url;key=null}4===access_level||"code"!==param.key&&2===access_level?container.find("button[type=submit]").removeClass("disabled"):container.find("button[type=submit]").addClass("disabled"),target=$(this),data_key&&initList({url:url,data:{id:data_key,access_token:app.url.access_token},method:"POST",key:key||param.key}),4===access_level&&(curClickItem=$(this)),areaId[access_level-2]=data_key});var str='<a class="auto">'+(4===access_level||"code"!==param.key&&2===access_level?"":'<span class="pull-right text-muted"><i class="fa fa-fw fa-angle-right text"></i></span>')+"<span>"+data[i].name+"</span></a>";li.html(str),ul.append(li)}panel.append(ul),lastUl=panel.find(".eara-list").last()}var route=$("#list_route"),panel=$("#eara_panel"),search=$("#search_input"),lastUl=null;if(1!==dt.data.resultCode){for(var lnks=route.find("a"),w=0,i=0;i<lnks.length;i++)w+=lnks.eq(i).width();return void(w>route.width()&&route.animate({scrollLeft:w-route.width()+50},300))}if(0===dt.data.data.length&&4!==access_level)return target.find("i").css("visibility","hidden"),void container.find("button[type=submit]").removeClass("disabled");data=dt.data.data,makeList(data);var isLast=!0;search.off().on("keydown",function(){setTimeout(function(){if(val=search.val(),!val.match(/\S+/g))return lastUl.remove(),isLast=!0,void makeList(data);for(var len=data.length,keys=val.split(/\s+/),isMatched=!1,dts=[],i=0;i<len;i++){isMatched=!0;for(var j=0;j<keys.length;j++)data[i].name.search(keys[j])===-1&&(isMatched=!1);isMatched&&dts.push(data[i])}0!==dts.length?(isLast&&panel.find(".eara-list").last().remove(),isLast=!0,makeList(dts)):0!==keys.length?(lastUl.remove(),isLast=!1):(lastUl.remove(),isLast=!0,makeList(data))},200)});for(var uls=panel.find(".eara-list"),links=route.find("a"),w1=0,w2=0,i=0;i<uls.length;i++)w1+=uls.eq(i).width();for(var i=0;i<links.length;i++)w2+=links.eq(i).width();w1>panel.width()&&panel.animate({scrollLeft:w1-panel.width()+25},300),panel.animate({scrollTop:0},300),w2>panel.width()&&route.animate({scrollLeft:w2-panel.width()+50},300),panel.animate({scrollTop:0},300)}),access_level++}function initChosen(dt){for(var opt,select=$("#doctor_title"),len=dt.length,tmp=$("<select></select>"),isExist=!1,i=0;i<len;i++)opt=$("<option>"+dt[i].name+"</option>"),tmp.append(opt);!isExist&&$scope.title?(opt=$("<option selected>"+$scope.title+"</option>"),tmp.prepend(opt)):isExist||(opt=$('<option selected value="0">请选择职称</option>'),tmp.prepend(opt)),select.html(tmp.html()),select.on("change",function(e){0!=$(this).val()?$scope.formData.title=$(this).val():($scope.formData.title=null,$scope.FillInfoForm.$invalid=!0,$scope.$apply())})}function clearData(){$rootScope.reuseDcotorData={name:$scope.hospital.selected.name,id:$scope.hospital.selected.id,deptId:$scope.deptId,department:$scope.department,title:$scope.title},$state.reload()}$scope.groupId=utils.localData("curGroupId")||"666666666666666666666666",$scope.hospital={},$rootScope.reuseDcotorData&&($scope.hospital.selected={},$scope.hospital.selected.id=$rootScope.reuseDcotorData.id||null,$scope.hospital.selected.name=$rootScope.reuseDcotorData.name||null,$scope.deptId=$rootScope.reuseDcotorData.deptId||null,$scope.department=$rootScope.reuseDcotorData.department||null,$scope.title=$rootScope.reuseDcotorData.title||null),$scope.getHospitalOption=function getHospitalOption(keyWord){return $scope.keyWord=keyWord,$http.post(app.url.hospital.findHospitalByCondition,{access_token:app.url.access_token,pageIndex:0,pageSize:20,keyWord:keyWord||null}).then(function(rpn){rpn=rpn.data,1===rpn.resultCode?$scope.hospitalOption=rpn.data.pageData:rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"接口出错")}),getHospitalOption}(),$scope.createHospital=function(){var modalInstance=$modal.open({template:'<div class="clearfix">                    <h4 class="col-xs-12 m-t-lg text-center">添加医院</h4>                    <div class="col-xs-12 m-t m-b">                        <div class="form-group clearfix m-b-xs">                            <label class="col-xs-3 control-label m-b-none text-right">医院所在省份：</label>                            <div class="col-xs-9">                                <select class="form-control m-b-none" ng-model="_provincesCode" ng-change="getArea(_provincesCode,\'citys\');_cityCode=\'\';_regionCode=\'\'">                                    <option value="">请选择</option>                                    <option value="{{pro.code}}" ng-repeat="pro in provinces">{{pro.name}}</option>                                </select>                            </div>                        </div>                        <div class="line line-dashed b-b line-lg pull-in"></div>                        <div class="form-group clearfix m-b-xs">                            <label class="col-xs-3 control-label m-b-none text-right">医院所在城市：</label>                            <div class="col-xs-9">                                <select class="form-control m-b-none" ng-model="_cityCode" ng-change="getArea(_cityCode,\'regions\');_regionCode=\'\'" ng-disabled="!_provincesCode">                                  <option value="">{{_provincesCode?\'请选择\':\'请先选择省份\'}}</option>                                  <option value="{{city.code}}" ng-repeat="city in citys">{{city.name}}</option>                                </select>                            </div>                        </div>                        <div class="line line-dashed b-b line-lg pull-in"></div>                        <div class="form-group clearfix m-b-xs">                            <label class="col-xs-3 control-label m-b-none text-right">医院所在区域：</label>                            <div class="col-xs-9">                                <select class="form-control m-b-none" ng-model="_regionCode" ng-disabled="!_cityCode">                                  <option value="">{{_cityCode?\'请选择\':\'请先选择城市\'}}</option>                                  <option value="{{region.code}}" ng-repeat="region in regions">{{region.name}}</option>                                </select>                            </div>                        </div>                        <div class="line line-dashed b-b line-lg pull-in"></div>                        <div class="form-group clearfix">                            <label class="col-xs-3 control-label m-b-none text-right">医院名称：</label>                            <div class="col-xs-9">                                <input type="text" class="form-control" placeholder="请输入医院名称" ng-model="_hospitalName">                            </div>                        </div>                        <div class="line line-dashed b-b line-lg pull-in"></div>                        <div class="form-group clearfix">                            <label class="col-xs-3 control-label m-b-none text-right">医院等级：</label>                            <div class="col-xs-9">                                <select class="form-control" ng-model="_hospitalLevel">                                    <option value="">请先选医院等级</option>                                    <option ng-repeat="lv in levels" value="{{lv.level}}">{{lv.level}}</option>                                </select>                            </div>                        </div>                        <div class="line line-dashed b-b line-lg pull-in"></div>                        <div class="form-group">                            <div class="col-xs-offset-3 col-xs-3">                                <button type="submit" class="w100 btn btn-primary" ng-click="addHospital(_provincesCode, _cityCode, _regionCode, _hospitalName, _hospitalLevel)" ng-disabled="!_provincesCode||!_cityCode||!_regionCode||!_hospitalName||!_hospitalLevel">                                    添加                                </button>                            </div>                            <div class="col-xs-3">                                <button type="button" class="w100 btn btn-default" ng-click="cancel()">返回</button>                            </div>                        </div>                    </div>                </div>',controller:"AddHospitalCtrl",size:"md"});modalInstance.result.then(function(hospital){setDefaultHospital&&setDefaultHospital(hospital)})};var curClickItem,key=null,data=null,val="",areaId=[],access_level=0,target=null,mask=$('<div class="mask"></div>'),container=$("#dialog-container"),doIt=function(){};$rootScope["do"]=function(){doIt()},$rootScope["return"]=function(){mask.remove(),container.addClass("none")},$scope.goBack=function(){window.history.back()},$scope.selectDepts=function(){var header=$('<div class="list-header"></div>'),route=$('<div id="list_route"></div>'),search=$('<div class="data-search  hide"><div><input id="search_input" type="text"/><i class="fa icon-magnifier"></i></div></div>'),panel=$('<div id="eara_panel"></div>'),dialog=$("#dialog");dialog.attr("class","col-lg-offset-4 col-lg-4 col-md-offset-3 col-md-6 col-sm-offset-2 col-sm-8 col-xs-12 m-dialog animating fade-in-down"),header.append(route),header.append(search),access_level=0,container.find("button[type=submit]").addClass("disabled"),mask.insertBefore(container),container.find(".form-content").addClass("def-border").html("").append(header).append(panel);var param={url:app.url.admin.check.getDepts,data:{access_token:app.url.access_token},method:"POST",key:"id"};initList(param),container.removeClass("none"),doIt=function(){3!==access_level&&2!==access_level||($scope.deptId=target.data("id"),$scope.department=target.data("name")),access_level=0,mask.remove(),container.addClass("none")}},$scope.formData={},function(){$http.post(app.url.admin.check.getTitles,{access_token:app.url.access_token}).then(function(resp){var dt=resp.data.data;dt.length>0?initChosen(dt):$scope.authError="数据有误！"},function(x){$scope.authError="服务器错误！"})}(),$scope.submitInfo=function(){$http({url:app.url.hospital.registerByAdmin,method:"post",data:{access_token:app.url.access_token,name:$scope.userName,telephone:$scope.telephone,groupId:$scope.groupId,"doctor.departments":$scope.department,"doctor.deptId":$scope.deptId,"doctor.hospital":$scope.hospital.selected.name,"doctor.hospitalId":$scope.hospital.selected.id,"doctor.title":$scope.title,headPicFileName:$scope.usrPicUrl,platform:1}}).then(function(resp){if($scope.do_or_not=function(){$scope.willSendMsg=!$scope.willSendMsg},1===resp.data.resultCode)if(0===resp.data.data.status){var div=$("<div></div>"),str='<p class="text-success">新建成功！</p><br/><p class="text-normal">用户可以使用手机号登陆app，<br/>密码默认为空，通过“找回密码”重置登陆密码。<br/><br/><label class="checkbox i-checks"><input type="checkbox" name="do_or_not" ng-init="willSendMsg=true" ng-click="do_or_not()" checked><i></i>发送短信通知用户</label></p>';div.html(str),modal.prompt(null,div,function(){$scope.willSendMsg&&$http({url:app.url.hospital.registerByGroupNotify,method:"post",data:{access_token:app.url.access_token,phone:$scope.telephone}}).then(function(resp){1===resp.data.resultCode?modal.toast.success("通知短信发送成功！"):modal.toast.error("通知短信发送失败！")}),clearData()}),$compile(div.contents())($scope)}else 2===resp.data.data.status?modal.confirm(null,"该手机号已注册，是否发送短信邀请医生加入集团？",function(){$http({url:app.url.hospital.saveBatchInvite,method:"post",data:{access_token:app.url.access_token,groupId:$scope.groupId,telepNumsOrdocNums:$scope.telephone,ignore:!0}}).then(function(resp){1===resp.data.resultCode?modal.toast.success("邀请短信发送成功！"):modal.toast.error("邀请短信发送失败！"),clearData()})},function(){clearData()},{OK:"是，发送",CANCEL:"不，谢谢"}):3===resp.data.data.status&&modal.prompt(null,"该医生已在集团内，不需要再次邀请。",function(){clearData()});else modal.toast.error(resp.data.resultMsg||"添加失败")},function(resp){modal.toast.error(resp.data.resultMsg)})},$scope.qiniuFilters={mime_types:[{title:"Image files",extensions:"jpg,gif,png"}]};var progress,imgURL;$scope.selectFile=function(model){$scope.upload(),progress=model+"Progress",imgURL=model+"Url"},$scope.token=app.url.access_token,$scope.uploaderAdded=function(up,files){$scope.uploadBoxOpen=!0},$scope.progress=function(up,file){$scope[progress]=file.percent},$scope.uploaderSuccess=function(up,file,info){if(file.url){if(!/.(gif|jpg|jpeg|png|gif|jpg|png)$/.test(file.type))return modal.toast.error("图片格式不正确！"),$scope.usrPicProgress=0,void $scope.$apply();$scope[imgURL]=file.url,$scope.$apply()}file.result="上传成功！",modal.toast.success("上传成功！")},$scope.uploaderError=function(up,err,errTip){modal.toast.error("error",null,errTip)}}),app.controller("AddHospitalCtrl",function($http,$modalInstance,$scope,toaster){$http.post(app.url.hospital.getHospitalLevel,{access_token:app.url.access_token}).then(function(rpn){rpn=rpn.data,1===rpn.resultCode?rpn.data&&($scope.levels=rpn.data):rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"接口出错")}),$scope.levels=[{id:"",level:""}],$scope.addHospital=function(provinceId,cityId,countryId,name,level){$http.post(app.url.admin.check.addHospital,{access_token:app.url.access_token,provinceId:provinceId,cityId:cityId,countryId:countryId,name:name,level:level}).then(function(rpn){rpn=rpn.data,1===rpn.resultCode?(toaster.pop("success",null,"添加成功"),$modalInstance.close(rpn.data)):rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"接口出错")})},$scope.getArea=function getArea(area_id,area_scope){return $http.post(app.url.admin.check.getArea,{access_token:app.url.access_token,id:area_id}).then(function(rpn){rpn=rpn.data,1===rpn.resultCode?area_scope||area_id?$scope[area_scope]=rpn.data:($scope.provinces=rpn.data,$scope.citys=null,$scope.regions=null):rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"接口出错")}),getArea}(),$scope.cancel=function(){$modalInstance.dismiss("cancel")}});