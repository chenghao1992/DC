"use strict";app.controller("ContactsListDetails",function($rootScope,$scope,$state,$timeout,$http,utils,$stateParams){function createSchedule(dt){var times=[[],[],[]];if(dt){var dates=dt,m=0,n=0;if(dates)for(var i=0;i<dates.length;i++)if(m=1*dates[i].period,n=1*dates[i].week,dates[i].startTime&&dates[i].endTime){var start=dates[i].startTime.substr(0,2)+":"+dates[i].startTime.substr(2,2),end=dates[i].endTime.substr(0,2)+":"+dates[i].endTime.substr(2,2);times[m-1][n%7]=start+"-"+end}}for(var days=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],table=$("<table></table>"),thead=$("<thead></thead>"),tbody=$("<tbody></tbody>"),i=0;i<4;i++){for(var tr=$("<tr></tr>"),j=0;j<7;j++){var td=$("<td></td>");0===i?td.html(days[j]):times[i-1]&&times[i-1][j]?td.html(times[i-1][j]):td.html("&nbsp;"),tr.append(td)}0===i?thead.append(tr):tbody.append(tr)}table.append(thead).append(tbody),$("#duty_schedule").html("").append(table)}var container=$("#dialog_container"),html=$("html"),doctorId=$scope.doctorInfo.id,groupId=utils.localData("curGroupId"),deptId=$scope.curDepartmentId||utils.localData("curDepartmentId");if(doctorId){$scope.isNormal=!1,$scope.isQuit=!0,"I"===$scope.doctorInfo.status?($scope.isNormal=!1,$scope.isQuit=!0):"C"===$scope.doctorInfo.status?($scope.isNormal=!0,deptId&&($scope.isQuit=!1)):"S"===$scope.doctorInfo.status?($scope.isNormal=!1,$scope.isQuit=!0):deptId?($scope.isNormal=!0,$scope.isQuit=!1):($scope.isNormal=!1,$scope.isQuit=!0),html.css("overflow","hidden"),$scope.viewData={},$scope.formData={},$scope.viewData.headPicFile=$scope.doctorInfo.headPicFile,$scope.viewData.name=$scope.doctorInfo.name||"--",$scope.viewData.departmentFullName=$scope.doctorInfo.departmentFullName||"--",$scope.viewData.relation=$scope.doctorInfo.relation||"--",$scope.viewData.groupProfit=$scope.doctorInfo.groupProfit||"0",$scope.viewData.parentProfit=$scope.doctorInfo.parentProfit||"0",$scope.formData.contactWay=$scope.doctorInfo.contactWay,$scope.formData.remarks=$scope.doctorInfo.remarks,$scope.tabs={},$scope.tabs.select=function(){return $scope.imgs?void($scope.isLoading=!1):($scope.isLoading=!0,void $http.get(app.url.upload.getCertPath+"?"+$.param({userId:doctorId,access_token:app.url.access_token})).then(function(dt){dt=dt.data.data,dt&&dt.length>0?$scope.imgs=dt:$scope.imgs=!1,$scope.isLoading=!1}))},$scope.tabs.setProfit=function(){function check(info){if($scope.targetDoctorId==info.id)return list_wrapper.html(""),modal.toast.warn("不能选择自己！"),void contacts.setCheck(info.id);for(var dts=contacts.tree.find("dt"),curDt=null,i=0;i<dts.length;i++)if(dts.eq(i).data("info").id==$scope.targetDoctorId){curDt=dts.eq(i);break}dts=curDt.parent().children("dd").find("dt");for(var i=0;i<dts.length;i++)if(dts.eq(i).data("info").id==info.id)return list_wrapper.html(""),modal.toast.warn("不能选择自己的下级！"),contacts.setCheck(info.id),void($scope.hasSuper=!1);var target=$(contacts.getTargets());if(0===target.length)return parentId=null,void list_wrapper.html("");var span=(target.data("info"),$('<span class="label-btn btn-info"></span>')),i=$('<i class="fa fa-times"></i>');parentId=info.id,list_wrapper.html(""),list_wrapper.html(span.html(info.name).append(i)),i.click(function(){contacts.setCheck(info.id),list_wrapper.html(""),parentId=null,$scope.hasSuper=!1}),$scope.hasSuper=!0}var list_wrapper=$("#cnt_list_department"),parentId=null;$scope.groupProfit||0===$scope.groupProfit?$scope.formData.groupProfit=$scope.groupProfit:$scope.formData.groupProfit=0,$scope.parentProfit||0===$scope.parentProfit?$scope.formData.parentProfit=$scope.parentProfit:$scope.formData.parentProfit=0,$scope.formData.parentProfit||($scope.formData.parentProfit=0),0==$scope.targetDoctorParentId&&($scope.hasSuper=!1,$scope.formData.parentProfit=0);var contacts=new Tree("cnt_list_relationship",{hasCheck:!0,multiple:!1,self:!0,arrType:[1,1,1,0],data:{url:app.url.yiliao.getProfitTree,param:{access_token:app.url.access_token,groupId:groupId}},async:!1,icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check",root:"fa fa-hospital-o tomato",branch:"fa fa-user-md tomato",leaf:"fa fa-user-md tomato"},info:{name:"name",id:"id",pid:"parentId",description:"description"},datakey:{id:"id",name:"name",sub:"children"},events:{click:check},callback:function(){for(var dts=contacts.tree.find("dt"),curDt=null,i=0;i<dts.length;i++)if(dts.eq(i).data("info").id===$scope.targetDoctorParentId){curDt=dts.eq(i);break}curDt&&curDt.trigger("click")}});$scope.saveProfit=function(){if($scope.formData.groupProfit>100||$scope.formData.superProfit>100)return void modal.toast.warn("抽成比例不能大于100");$scope.formData.superProfit||($scope.formData.superProfit=0),parentId||(parentId=0,$scope.formData.superProfit=0);var param={access_token:app.url.access_token,groupId:groupId,parentId:parentId,id:$scope.targetDoctorId};$http({url:app.url.yiliao.updateProfitRelation,method:"post",data:param}).then(function(resp){1===resp.data.resultCode?(console.log("设置抽成关系成功！"),param={access_token:app.url.access_token,groupId:groupId,id:$scope.targetDoctorId,groupProfit:$scope.formData.groupProfit,parentProfit:$scope.formData.superProfit},$http({url:app.url.yiliao.updateProfit,method:"post",data:param}).then(function(resp){1===resp.data.resultCode?(console.log("修改抽成比例成功！"),$state.go("app.relationship.list",{id:$scope.curDepartmentId},{reload:!0}),html.css("overflow","auto")):modal.toast.warn("修改抽成比例失败！ ("+resp.data.resultMsg+")")},function(x){console.error(x.statusText)})):modal.toast.warn("设置抽成关系失败！ ("+resp.data.resultMsg+")")},function(x){console.error(x.statusText)})}},$scope.tabs.otherInfo=function(){return $scope.viewData.inviteCode="http://112.74.208.140/appInvite/joinToGroup.html?groupId="+groupId+"&doctorId="+doctorId,$scope.isLoading=!1,$scope.info?void($scope.isLoading=!1):($scope.isLoading=!0,void $http({url:app.url.yiliao.getUserDetail,data:{userId:doctorId,access_token:app.url.access_token},method:"post"}).then(function(dt){dt=dt.data.data,dt&&dt.length>0?$scope.info=dt:$scope.info=!1,$scope.isLoading=!1}))};var ttl,dpt,hsp;$http({url:app.url.doctor.getWork,method:"post",data:{access_token:app.url.access_token,userId:doctorId}}).then(function(resp){if(1===resp.data.resultCode&&resp.data.data){var dt=resp.data.data;ttl=dt.title||"--",dpt=dt.departments||"--",hsp=dt.hospital||"--",$scope.viewData.info=ttl+" / "+dpt+" / "+hsp}else $scope.viewData.info="-- / -- / -- "},function(x){console.error(x.statusText)}),$http({url:app.url.doctor.getIntro,method:"post",data:{access_token:app.url.access_token,userId:doctorId}}).then(function(resp){if(1===resp.data.resultCode&&resp.data.data){var dt=resp.data.data;$scope.viewData.introduction=dt.introduction||"--",$scope.viewData.skill=dt.skill||"--"}else $scope.viewData.introduction="--",$scope.viewData.skill="--"},function(x){console.error(x.statusText)}),deptId?$http({url:app.url.yiliao.getSchedule,method:"post",data:{access_token:app.url.access_token,doctorId:doctorId}}).then(function(resp){if(1===resp.data.resultCode&&resp.data.data.online){var dt=resp.data.data.online;createSchedule(dt)}else createSchedule(null)},function(x){console.error(x.statusText)}):createSchedule(null),$scope.query=function(){doIt()},$scope.apportion=function(id){$state.go("app.contacts.list.apportion")},$scope.quit=function(id){$state.go("app.contacts.list.quit")},$scope.save=function(){$http({url:app.url.yiliao.updateDoctor,method:"post",data:{access_token:app.url.access_token,id:$scope.groupDoctorId,contactWay:$scope.formData.contactWay||"--",remarks:$scope.formData.remarks||"--"}}).then(function(resp){1===resp.data.resultCode&&($rootScope.isSearch?$state.go("app.contacts.list",{id:$rootScope.keyword||utils.localData("tmpKey")},{reload:!1}):$state.go("app.contacts.list",{id:$scope.curDepartmentId},{reload:!0}),html.css("overflow","auto"))},function(x){console.error(x.statusText)})},$scope.cancel=function(){container.prev().remove(),container.remove(),$rootScope.isSearch?$state.go("app.contacts.list",{id:$rootScope.keyword||utils.localData("tmpKey")},{reload:!1}):$state.go("app.contacts.list",{id:$scope.curDepartmentId},{reload:!1}),html.css("overflow","auto")}}});