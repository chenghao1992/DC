"use strict";app.controller("groupEdit",["$rootScope","$scope","$modal","$log","$http","$state","$stateParams","utils","modal","Group","AppFactory",function($rootScope,$scope,$modal,$log,$http,$state,$stateParams,utils,modal,Group,AppFactory){function makeList(data){$scope.dataDom=data,$scope.$apply($scope.dataDom)}function setEditor(){$scope.addData=function(){pickData()},$scope.saveData=function(){var ids=[];$scope.dataDom.forEach(function(item,index,array){ids.push(item.id)}),$http.post(app.yiliao+"group/settings/setSpecialty",{access_token:localStorage.getItem("access_token"),docGroupId:localStorage.getItem("curGroupId"),specialtyIds:ids}).success(function(data){1===data.resultCode?($scope.result=!0,modal.toast.success("擅长病种保存成功！")):($scope.result=!1,modal.toast.error("擅长病种保存失败！"))}).error(function(data){console.error("保存擅长病种:"+data)})},$scope.removeItem=function(item){var index=$scope.dataDom.indexOf(item);$scope.dataDom.splice(index,1)}}$scope.currentOrgInfo=Group.getCurrentOrgInfo(),$scope.financialState=!0,$scope.memberInvite="true",$scope.memberApply="true";var groupId=localStorage.getItem("curGroupId"),doctorId=$scope.datas.user_id||utils.localData("user_id"),logoImg=null;$scope.currentOrgInfo&&AppFactory.group.isServiceGroup($scope.currentOrgInfo.id).then(function(_data){_data?$scope.isServiceGroup=!0:$scope.isServiceGroup=!1}),$scope.financialState=!1,$scope.groupLogoProgress=0,Group.handle(groupId,function(group){switch($scope.groupName=group.name,$scope.groupCreatorName=group.creatorName,$scope.groupInfo=group.introduction,$scope.groupLogoUrl=group.logo,group.config&&($scope.memberInvite=String(group.config.memberInvite),$scope.memberApply=String(group.config.memberApply)),group.user.admin){case"root":$scope.isRootAdmin=!0;break;default:$scope.isRootAdmin=!1}}),$scope.submitBt=function(){$scope.updateGroup(groupId),$scope.saveData()},$scope.updateGroup=function(groupId){$http.post(app.url.yiliao.updateGroup,{access_token:app.url.access_token,id:groupId,name:$scope.groupName,introduction:$scope.groupInfo,"config.memberInvite":$scope.memberInvite,"config.memberApply":$scope.memberApply,logoUrl:logoImg}).success(function(data){if(1===data.resultCode){utils.localData("curGroupName",data.data.name),$rootScope.rootGroup.name=localStorage.getItem("curGroupName"),Group.update(groupId,function(group){switch($scope.groupName=group.name,$scope.groupInfo=group.introduction,$scope.groupLogoUrl=group.logo,group.config&&($scope.memberInvite=String(group.config.memberInvite),$scope.memberApply=String(group.config.memberApply)),group.user.admin){case"root":$scope.isRootAdmin=!0;break;default:$scope.isRootAdmin=!1}});var _tip="集团信息修改成功！";1==$scope.currentOrgInfo.orgType&&(_tip="医院信息修改成功！"),modal.toast.success(_tip)}else modal.toast.error(data.resultMsg)}).error(function(data){$scope.authError=data.resultMsg})},$http.post(app.url.yiliao.getDiseaseLabel,{access_token:localStorage.getItem("access_token"),docGroupId:localStorage.getItem("curGroupId")}).success(function(data){data.data.length>0?($scope.loading=!1,data.data.map(function(e){return e.id=e.diseasesId,e.name=e.diseasesName,delete e.diseasesId,delete e.diseasesName,e}),$scope.dataDom=data.data):$scope.loading=!1,setEditor()}).error(function(data){console.error(data)});var pickData=function(){new DataBox("data_res",{hasCheck:!0,allCheck:!0,leafCheck:!0,multiple:!0,allHaveArr:!1,self:!1,cover:!1,leafDepth:2,selectView:!0,search:{url:"",param:{},dataKey:{name:"name",id:"id",union:"parentId",dataSet:"data.data"},unwind:!1},arrType:[1,1,0],data:{url:app.yiliao+"base/getDiseaseTree"},titles:{main:"选择病种",searchKey:"搜索病种...",label:"已选择病种数"},icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check/fa fa-square",root:"fa fa-hospital-o cfblue",branch:"fa fa-h-square cfblue",leaf:"fa fa-stethoscope dcolor",head:"headPicFileName"},fixdata:$scope.dataDom,response:makeList,datakey:{id:"id",name:"name",sub:"children"},info:{name:"name",id:"id",leaf:"leaf"}})};groupId&&($scope.logoUpdate=!0);var modalInstance;$scope.transferTo=function(){1==$scope.isRootAdmin?modalInstance=$modal.open({animation:!0,templateUrl:"groupTransfer.html",controller:"GroupTransfer",size:"md",resolve:{item:function(){return doctorId}}}):modal.toast.error("非创建人不可以进行此操作，请联系创建人处理。")},$scope.selectFile=function(){$scope.upload()},$scope.token=localStorage.getItem("access_token"),$scope.uploaderAdded=function(up,files){$scope.uploadBoxOpen=!0},$scope.progress=function(up,file){$scope.groupLogoProgress=file.percent},$scope.uploaderSuccess=function(up,file,info){groupId&&file.url&&(file.url&&($scope.groupLogoUrl=file.url,$scope.datas.groupPicFile=file.url,logoImg=file.url,$scope.$apply()),file.result="上传成功！",modal.toast.success("头像上传成功！"))},$scope.uploaderError=function(up,err,errTip){modal.toast.error(errTip)}}]),app.controller("GroupTransfer",function($scope,$rootScope,$modalInstance,$http,item,modal,utils){function setDoctor(dt){return item===dt[0].id?void($scope.authError="不能转让给自己！"):($scope.selectedDoctorId=dt[0].id,$scope.selectedDoctorName=dt[0].name,$scope.authError=!1,void $scope.$apply())}$scope.account={};var groupId=localStorage.getItem("curGroupId");$scope.confirm=function(){$http({url:app.url.yiliao.applyTransfer,method:"post",data:{access_token:app.url.access_token,groupId:groupId,inviteUserId:item,confirmUserId:$scope.selectedDoctorId}}).then(function(resp){"1"==resp.data.resultCode?(modal.toast.success("成功提交变更申请，等待医生确认！"),$modalInstance.dismiss("cancel")):$scope.authError=resp.data.resultMsg})},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.selectDoctor=function(){new DataBox("data_res",{hasCheck:!0,allCheck:!1,leafCheck:!0,multiple:!1,allHaveArr:!0,self:!1,cover:!1,selectView:!1,arrType:[1,0,0],search:{url:app.url.yiliao.searchDoctorByKeyWord,param:{access_token:app.url.access_token,groupId:groupId,keyword:"name",pageSize:1e4,pageIndex:0},dataKey:{name:"doctor.name",id:"doctorId",union:"departmentId",dataSet:"data.pageData"},keyName:"keyword",unwind:!1},data:{url:app.url.yiliao.getAllData,param:{access_token:app.url.access_token,groupId:groupId}},async:{url:app.url.yiliao.getDepartmentDoctor,dataKey:{departmentId:"id"},data:{access_token:app.url.access_token,groupId:groupId,status:"C",type:1},dataName:"",target:{data:"",dataKey:{id:"id",name:"name"}}},titles:{main:"选择医生",searchKey:"医生姓名",label:"已选择医生"},icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check/fa fa-square",root:"fa fa-hospital-o cfblue",branch:"fa fa-h-square cfblue",leaf:"fa fa-user-md dcolor",head:"headPicFileName"},root:{selectable:!1,name:utils.localData("curGroupName"),id:0},extra:[{name:"未分配",id:"idx_0",parentId:0,subList:[],url:app.url.yiliao.getUndistributed,dataName:"pageData",target:{data:"doctor",dataKey:{id:"doctorId",name:"name"}},param:{access_token:app.url.access_token,groupId:groupId,pageIndex:0,pageSize:1e4},icon:"fa fa-bookmark"}],response:setDoctor,datakey:{id:"id",name:"name",sub:"subList"},info:{name:"name",id:"id",pid:"parentId",dpt:"departments",description:"description",param:"param",icon:"icon",url:"url",isExtra:"isExtra",target:"target"},callback:function(){}})}});