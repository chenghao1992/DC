"use strict";app.controller("DoctorDetails",function($rootScope,$scope,$state,$timeout,$http,utils){function createSchedule(dt){var times=[[],[],[]];if(dt){var dates=dt,m=0,n=0;if(dates)for(var i=0;i<dates.length;i++)if(m=1*dates[i].period,n=1*dates[i].week,dates[i].startTime&&dates[i].endTime){var start=dates[i].startTime.substr(0,2)+":"+dates[i].startTime.substr(2,2),end=dates[i].endTime.substr(0,2)+":"+dates[i].endTime.substr(2,2);times[m-1][n%7]=start+"-"+end}}for(var days=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],table=$("<table></table>"),thead=$("<thead></thead>"),tbody=$("<tbody></tbody>"),i=0;i<4;i++){for(var tr=$("<tr></tr>"),j=0;j<7;j++){var td=$("<td></td>");0===i?td.html(days[j]):times[i-1]&&times[i-1][j]?td.html(times[i-1][j]):td.html("&nbsp;"),tr.append(td)}0===i?thead.append(tr):tbody.append(tr)}table.append(thead).append(tbody),$("#duty_schedule").html("").append(table)}var container=$("#dialog_container"),html=$("html"),doctorId=$scope.doctorInfo.id,groupId=utils.localData("curGroupId"),deptId=$scope.curDepartmentId||utils.localData("curDepartmentId");if(doctorId){$scope.isLoading=!0,html.css("overflow","hidden"),$scope.viewData={},$scope.formData={},$scope.viewData.headPicFile=$scope.doctorInfo.headPicFile,$scope.viewData.name=$scope.doctorInfo.name||"--",$scope.viewData.relation=$scope.doctorInfo.relation||"--",$scope.viewData.contactWay=$scope.doctorInfo.contactWay||"--",$scope.viewData.remarks=$scope.doctorInfo.remarks||"--",$scope.tabs={},$scope.tabs.select=function(){return $scope.imgs?void($scope.isLoading=!1):($scope.isLoading=!0,void $http.get(app.url.upload.getCertPath+"?"+$.param({userId:doctorId,access_token:app.url.access_token})).then(function(dt){dt=dt.data.data,dt&&dt.length>0?$scope.imgs=dt:$scope.imgs=!1,$scope.isLoading=!1}))},$scope.tabs.otherInfo=function(){$scope.viewData.inviteCode="http://112.74.208.140/appInvite/joinToGroup.html?groupId="+groupId+"&doctorId="+doctorId,$scope.isLoading=!1};var ttl,dpt,hsp;$http({url:app.url.doctor.getWork,method:"post",data:{access_token:app.url.access_token,userId:doctorId}}).then(function(resp){if(1===resp.data.resultCode&&resp.data.data){var dt=resp.data.data;ttl=dt.title||"--",dpt=dt.departments||"--",hsp=dt.hospital||"--",$scope.viewData.info=ttl+" / "+dpt+" / "+hsp}else $scope.viewData.info="-- / -- / -- "},function(x){console.error(x.statusText)}),$http({url:app.url.doctor.getIntro,method:"post",data:{access_token:app.url.access_token,userId:doctorId}}).then(function(resp){if(1===resp.data.resultCode&&resp.data.data){var dt=resp.data.data;$scope.viewData.introduction=dt.introduction||"--",$scope.viewData.skill=dt.skill||"--"}else $scope.viewData.introduction="--",$scope.viewData.skill="--"},function(x){console.error(x.statusText)}),deptId?$http({url:app.url.yiliao.getSchedule,method:"post",data:{access_token:app.url.access_token,doctorId:doctorId}}).then(function(resp){if(1===resp.data.resultCode&&resp.data.data.online){var dt=resp.data.data.online;createSchedule(dt)}else createSchedule(null)},function(x){console.error(x.statusText)}):createSchedule(null),$scope.query=function(){doIt()},$scope.apportion=function(id){$state.go("app.contacts.list.apportion")},$scope.quit=function(id){$state.go("app.contacts.list.quit")},$scope.save=function(){$http({url:app.url.yiliao.updateDoctor,method:"post",data:{access_token:app.url.access_token,id:$scope.groupDoctorId,contactWay:$scope.formData.contactWay||"--",remarks:$scope.formData.remarks||"--"}}).then(function(resp){1===resp.data.resultCode&&($state.go("app.contacts.list",{id:$scope.curDepartmentId},{reload:!0}),html.css("overflow","auto"))},function(x){console.error(x.statusText)})},$scope.cancel=function(){container.prev().remove(),container.remove(),$state.go("app.doctor_list",{id:$scope.curDoctorId},{reload:!0}),html.css("overflow","auto")}}});