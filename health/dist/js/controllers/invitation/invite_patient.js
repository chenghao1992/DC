"use strict";app.controller("InvitePatient",function($rootScope,$scope,$state,$timeout,$http,utils,modal,$modal){function editFocus(e){var evt=e||window.event;if(evt.stopPropagation(),curEle!==$(this)){clearInterval(tmr);var temp=$(this).html(),thiz=curEle=$(this);tmr=setInterval(function(){var _val=thiz.html();if(temp!==_val)if(temp=_val,phone.test(_val)){var _idx=keys.indexOf(_val);_idx===-1?(keys[e.data]=_val,numberEles[e.data]=thiz.parent()):blink(numberEles[_idx],thiz.parent()),thiz.parent().removeClass("btn-warning")}else thiz.parent().addClass("btn-warning")},50)}}function blink(eleA,eleB){var n=6,t=setInterval(function(){n%2?(eleA.addClass("btn-danger"),eleB.addClass("btn-danger")):(eleA.removeClass("btn-danger"),eleB.removeClass("btn-danger")),0===n--&&clearInterval(t)},100)}function iptFocus(e){var evt=e||window.event;if(evt.stopPropagation(),curEle!==$(this)){clearInterval(tmr),clearInterval(timer);var temp=$(this).val();curEle=$(this);timer=setInterval(function(){var _val=ipt.val();if(temp!==_val&&(temp=_val,phone.test(_val))){var span=$('<span class="label-btn btn-success"></span>'),b=$('<b contenteditable="true">'+_val+"</b>"),ie=$('<i class="fa fa-times"></i>'),idx=keys.indexOf(_val);span.prepend(b),span.prepend(ie),span.insertBefore(ipt),ipt.val(""),keys.push(_val),numberEles.push(span),idx!==-1&&blink(numberEles[idx],span),ie.on("click",index,function(e){keys[e.data]=null,$(this).parent().remove()}),b.on("click",index,editFocus),index++}},50)}}function createIpt(){ipt=$('<input maxlength="11" class="num-input" />'),txtLt.append(ipt),ipt.on("focus",iptFocus),ipt.trigger("focus")}var curEle,txtLt=$("#invite_phone_list"),keys=[],numbers=[],timer=0,tmr=0,phone=/^(13[0-9]|14[57]|15[0-9]|17[0678]|18[0-9])[0-9]{8}$/,target=null,ipt=$(),numberEles=[],index=0;$scope.inviteSucceed=!1,txtLt.trigger("focus").blur(function(){clearInterval(tmr)}),txtLt.click(function(e){var evt=e||window.event;evt.stopPropagation(),target=evt.target||evt.srcElement,ipt&&ipt.length?ipt.trigger("focus"):target===$(this)[0]&&createIpt()}),txtLt.on("paste",function(e){var clipboardData=event.clipboardData||window.clipboardData,nums=clipboardData.getData("text"),marks=nums.split(/\d+/),idxs=[];marks.splice(0,1),nums=nums.split(/\D+/),nums[0].match(/\d/)||nums.splice(0,1),nums[nums.length-1].match(/\d/)||nums.splice(nums.length-1,1),nums.length>0&&(nums=utils.unique(nums,idxs));for(var i=idxs.length-1;i>=0;i--)marks.splice(idxs[i],1);ipt&&ipt.remove();for(var i=0;i<nums.length;i++){if(phone.test(nums[i]))var span=$('<span class="label-btn btn-success"></span>');else var span=$('<span class="label-btn btn-success btn-warning"></span>');var b=$('<b contenteditable="true">'+nums[i]+"</b>"),name=marks[i].trim();if(/\S/.test(name))var m=$("<span>( "+marks[i].trim()+" )</span>");else var m=$("<span></span>");var ie=$('<i class="fa fa-times"></i>');span.prepend(m),span.prepend(b),span.prepend(ie),txtLt.append(span),keys.push(nums[i]),numberEles.push(span),ie.bind("click",index,function(e){keys[e.data]=null,$(this).parent().remove()}),b.on("click",index,editFocus),b.on("paste",function(e){var evt=e||window.event;evt.stopPropagation();var clipboardData=event.clipboardData||window.clipboardData;clipboardData.getData("text");$(this).html()}),index++}clearInterval(timer),createIpt()}),$scope.add=function(){clearInterval(tmr),clearInterval(timer),numbers=[],$scope.succeed=!1,$scope.invited=!1;for(var i=0;i<index;i++)phone.test(keys[i])&&numbers.push(keys[i]);if(numbers.length>0&&(numbers=utils.unique(numbers)),0===numbers.length){var v=ipt.val();return void(v&&v.length>0&&/\S/g.test(v)?modal.toast.warn("手机号码格式不正确！"):modal.toast.warn("手机号码格式不正确！"))}$http({method:"post",url:app.url.yiliao.addPatient,data:{access_token:app.url.access_token,telephones:numbers}}).then(function(resp){var _dt=resp.data;if("1"==_dt.resultCode&&_dt.data){var succeed=[],invited=[];$scope.inviteSucceed=!0;for(var k in _dt.data)"已是好友"===_dt.data[k].msg?invited.push(k):succeed.push(k);succeed.length>0&&($scope.succeed=!0,$("#succeed_list").html(succeed.toString().replace(/,/g,", ")+' <span class="text-success">邀请成功!</span>')),invited.length>0&&($scope.invited=!0,$("#invited_list").html(invited.toString().replace(/,/g,", ")+' <span class="text-primary">已是好友!</span>'))}})},$scope.clear=function(){clearInterval(tmr),clearInterval(timer),txtLt.html(""),keys=[],numbers=[],numberEles=[],$scope.succeed=!1,$scope.invited=!1,createIpt()}});