"use strict";!function(){function funDoctorKnowledgeAddCtrl($scope,$http,$state,toaster,utils,$stateParams,$modal){function diseaseSelected(dt){$scope.selectedType=dt[0],$scope.$apply($scope.selectedType)}function authorSelected(dt){dt.length>0&&(authorDate=dt[0],$scope.selectedAuthorId=authorDate.id,$scope.selectedAuthorName=authorDate.name,$scope.isGroup=!1,$scope.$apply($scope.selectedAuthor),$scope.$apply($scope.isGroup),console.log($scope.selectedAuthorId))}function tagsSelected(dt){$scope.keywords=dt,$scope.$apply($scope.keywords)}var curGroupId=localStorage.getItem("curGroupId"),userId=localStorage.getItem("user_id"),authorDate={},um=null;$scope.titleLength=$scope.title,$scope.isGroup=!1,$scope.isShow=!1,$scope.$on("$destroy",function(){um.destroy()}),$scope.isPersonKnowledge="true"==$stateParams.isPersonKnowledge,function(){$http.post(app.url.knowledge.getCategoryList,{access_token:app.url.access_token,groupId:curGroupId}).success(function(data){1==data.resultCode&&($scope.selectedType=data.data[data.data.length-1])}).error(function(data){toaster.pop("error",null,data.resultMsg)})}(),function(){$http({url:serverApiRoot+"vpanfile/getUploadToken",method:"post",data:{access_token:app.url.access_token,bucket:"resource"}}).then(function(response){var rep=response.data;rep&&1==rep.resultCode&&rep.data&&rep.data.token&&rep.data.domain?um=UM.getEditor("myEditor",{initialFrameWidth:"100%",initialFrameHeight:300,qiniuToken:rep.data.token,qiniuDomain:rep.data.domain}):console.error(rep)})}(),$scope.saveKnowledge=function(){var html=um.getContent();return $scope.title?$scope.selectedType?$scope.fontImgUrl?html?(2==$scope.createrType?$scope.creater=curGroupId:3==$scope.createrType&&($scope.creater=curGroupId),void $http.post(app.url.knowledge.addKnowledge,{access_token:app.url.access_token,title:$scope.title||"",isShow:$scope.isShow?1:0,copy:$scope.fontImgUrl||"",author:userId,authorName:$scope.selectedAuthorName||"",categoryId:$scope.selectedType.id||"",description:$scope.summary||"",content:html||"",createrType:3,creater:userId||""}).success(function(data){1==data.resultCode?(toaster.pop("success",null,"添加就医知识成功"),$state.go("app.doctorKnowledge.list",{isPersonKnowledge:!0},{reload:!0})):toaster.pop("error",null,data.resultMsg)}).error(function(data){toaster.pop("error",null,data.resultMsg)})):void toaster.pop("warn",null,"请填写正文"):void toaster.pop("info",null,"请上传题图"):void toaster.pop("info",null,"请选择分类"):void toaster.pop("warn","","请填写标题")},$scope.chooseType=function(){new DataBox("data_res",{hasCheck:!1,allCheck:!1,leafCheck:!0,multiple:!1,allHaveArr:!1,self:!1,cover:!1,leafDepth:1,selectView:!1,search:{dataKey:{name:"name",id:"id",union:"parentId",dataSet:"data"},unwind:!1},arrType:[0,0],data:{url:app.url.knowledge.getCategoryList+"?access_token="+app.url.access_token+"&&groupId="+curGroupId},titles:{main:"选择分类",searchKey:"搜索分类...",label:"已选择分类"},fixdata:[],icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check/fa fa-square",root:"fa fa-hospital-o cfblue",branch:"fa fa-h-square cfblue",leaf:"fa fa-stethoscope dcolor",head:"headPicFileName"},response:diseaseSelected,datakey:{id:"id",name:"name",sub:"children"},info:{name:"name",id:"id",leaf:"leaf",pid:"parentId"}})},$scope.chooseAuthor=function(){new DataBox("data_res",{hasCheck:!0,allCheck:!0,leafCheck:!0,multiple:!1,allHaveArr:!0,arrType:[1,0],data:{url:app.url.yiliao.getAllData,param:{access_token:app.url.access_token,groupId:curGroupId}},search:{url:app.url.yiliao.searchDoctorByKeyWord,param:{access_token:app.url.access_token,groupId:curGroupId,keyword:"name",pageSize:1e4,pageIndex:0},dataKey:{name:"doctor.name",id:"doctorId",union:"departmentId",dataSet:"data.pageData"},keyName:"keyword",unwind:!1},async:{url:app.url.yiliao.getDepartmentDoctor,dataKey:{departmentId:"id"},data:{access_token:app.url.access_token,groupId:curGroupId,status:"C",type:1},dataName:"",target:{data:"",dataKey:{id:"id",name:"name"}}},extra:[{name:"未分配",id:"idx_0",parentId:0,subList:[],url:app.url.yiliao.getUndistributed,dataName:"pageData",target:{data:"doctor",dataKey:{id:"doctorId",name:"name"}},param:{access_token:app.url.access_token,groupId:curGroupId,pageIndex:0,pageSize:1e4},icon:"fa fa-bookmark"}],icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check/fa fa-square",root:"fa fa-hospital-o cfblue",branch:"fa fa-h-square cfblue",leaf:"fa fa-user-md dcolor",head:"headPicFileName"},root:{selectable:!1,name:utils.localData("curGroupName"),id:"undefined"},datakey:{id:"id",name:"name",sub:"subList"},info:{name:"name",id:"id",pid:"parentId",dpt:"departments",description:"description",param:"param",icon:"icon",url:"url",isExtra:"isExtra",target:"target"},response:authorSelected})},$scope.switchAuthor=function(){$scope.isGroup=!$scope.isGroup},$scope.switchIsShow=function(){$scope.isShow=!$scope.isShow},$scope.chooseDisease=function(){new DataBox("data_res",{hasCheck:!0,allCheck:!0,leafCheck:!0,multiple:!0,allHaveArr:!1,self:!1,cover:!1,leafDepth:3,selectView:!0,search:{searchDepth:[2],dataKey:{name:"name",id:"id",union:"parentId",dataSet:"data"},unwind:!1},arrType:[0,0],data:{url:app.url.document.getDiseaseTree+"?access_token="+app.url.access_token},titles:{main:"选择标签",searchKey:"搜索标签...",label:"已选择标签数"},icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check/fa fa-square",root:"fa fa-hospital-o cfblue",branch:"fa fa-h-square cfblue",leaf:"fa fa-stethoscope dcolor",head:"headPicFileName"},fixdata:$scope.keywords,response:tagsSelected,datakey:{id:"id",name:"name",sub:"children"},info:{name:"name",id:"id",leaf:"leaf"}})},$scope.removeItem=function(item){var index=$scope.keywords.indexOf(item);$scope.keywords.splice(index,1)},$scope.qiniuFilters={mime_types:[{title:"Image files",extensions:"jpg,gif,png"}]},$scope.selectFile=function(){$scope.upload()},$scope.token=app.url.access_token,$scope.uploaderAdded=function(up,files){$scope.uploadPercent=0},$scope.uploaderSuccess=function(up,file,info){$scope.fontImgUrl=file.url,$scope.copy_small=file.url+"?imageView2/3/w/200/h/200",$scope.uploadPercent=100,toaster.pop("success",null,"封面修改成功！")},$scope.uploaderError=function(up,err,errTip){err.code==-600?toaster.pop("error",null,"文件过大"):toaster.pop("error",null,errTip)},$scope.fileUploadProcess=function(up,file){$scope.uploadPercent=100==file.percent?99:file.percent},$scope.toPreview=function(){if(!$scope.title)return void toaster.pop("warn","","请填写标题");if(!$scope.fontImgUrl)return void toaster.pop("warn","","请上传题图");var isShow=0==$scope.isShow?0:1,html=um.getContent();if(!html)return void toaster.pop("warn",null,"请填写正文");var firstParagraph=um.getContentTxt().slice(0,100),articlePreview={authorName:$scope.selectedAuthorName,title:$scope.title,isShow:isShow,copyPath:$scope.fontImgUrl,summary:$scope.summary?$scope.summary:firstParagraph,content:html,date:Date.now()};$modal.open({templateUrl:"previewModalContent.html",controller:"previewModalInstanceCtrl",windowClass:"docPreModal",resolve:{article:function(){return articlePreview}}})}}angular.module("app").controller("doctorKnowledgeAddCtrl",funDoctorKnowledgeAddCtrl),funDoctorKnowledgeAddCtrl.$inject=["$scope","$http","$state","toaster","utils","$stateParams","$modal"]}(),app.controller("previewModalInstanceCtrl",function($scope,$modalInstance,article,$sce){$scope.article=article,$scope.article.content=$sce.trustAsHtml($scope.article.content),$scope.cancel=function(){$modalInstance.dismiss("cancel")}});