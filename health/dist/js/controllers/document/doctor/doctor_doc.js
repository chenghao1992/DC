"use strict";app.controller("doctorDocCtrl",function($scope,$timeout,utils,$http,modal,toaster,$location,$state){function initdocArticleTable(){var index=1,length=10,start=0,size=10,setTable=function(){docArticleTable=$("#collectDocTable").DataTable({language:app.lang.datatables.translation,searching:!1,sScrollX:"100%",sScrollXInner:"110%",destroy:!0,lengthChange:!0,ordering:!1,draw:index,pageLength:length,lengthMenu:[5,10,20,50],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:docArticleUrl,fnServerData:function(sSource,aoData,fnCallback){$.ajax({type:"post",url:sSource,dataType:"json",data:docArticleParam,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else console.log(resp.resultMsg)}})},columns:[{data:"author",render:function(set,status,dt){var keywordsStr="";dt.tag&&dt.tag.length>0?(keywordsStr+="关键字：",dt.tag.forEach(function(item,index,array){item&&(keywordsStr+=item.name+"；")})):keywordsStr+="&nbsp;";var authorName=dt.authorName?dt.authorName:dt.author,photoPath=dt.copy_small?dt.copy_small:"src/img/nophoto.jpg";return"<img src="+photoPath+' alt="..." style="width:60px;height:60px;margin-right:10px;float:left;border-radius:0;"><span class="clear"><span>'+dt.title+'</span><small class="text-muted clear text-ellipsis">'+keywordsStr.substring(0,30)+'</small><small class="text-muted clear text-ellipsis">作者：'+authorName+"</small></span>"}},{data:"useNum",render:function(set,status,dt){return void 0==dt.useNum?0:dt.useNum}},{data:"visitCount",render:function(set,status,dt){return void 0==dt.visitCount?0:dt.visitCount}},{render:function(set,status,dt){return utils.dateFormat(dt.creatTime,"yyyy-MM-dd")}},{render:function(set,status,dt){return 2==dt.collect?'<label id="editArticle" class="operate">编辑</label> | <label id="copyUrl"  class="operate copyUrl" data-clipboard-text="'+dt.url+'">拷贝url</label>':1==dt.collect?'<label id="removeCollect" class="operate">取消收藏</label> | <label id="copyUrl"  class="operate copyUrl" data-clipboard-text="'+dt.url+'">拷贝url</label>':""}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#editArticle",function(event){editArticle(aData.id,aData.collect),event.stopPropagation()}),$(nRow).on("click","#removeCollect",function(event){removeCollect(aData.id,nRow),event.stopPropagation()}),$(nRow).on("click","",function(event){if("copyUrl"!=event.target.id){var url=$state.href("doctorArticle",{id:aData.id,createType:3});window.open(url,"_blank")}})}}),docArticleTable.off("page.dt").on("page.dt",function(e,settings){index=docArticleTable.page.info().page+1,start=length*(index-1),docArticleParam.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=1,start=0,docArticleParam.pageIndex=1,docArticleParam.pageSize=len})};setTable()}var docArticleTable;$scope.mainKeyword=null;var docArticleUrl=(localStorage.getItem("user_id"),app.url.document.getArticleByDoctor),docArticleParam={access_token:app.url.access_token,pageIndex:1,pageSize:10};$scope.mainKWLength=0,$scope.$watch("mainKeyword",function(newValue,oldValue){newValue!=oldValue&&($scope.mainKeyword?$scope.mainKWLength=$scope.mainKeyword.length:$scope.mainKWLength=0)}),$scope.clearMainKW=function(){$scope.mainKeyword=null,docArticleUrl=app.url.document.getArticleByDoctor,docArticleParam={access_token:app.url.access_token,pageIndex:1,pageSize:10},initdocArticleTable()},$scope.findDocByKeyWord=function(){docArticleUrl=app.url.document.findArticleByKeyWord,docArticleParam={access_token:app.url.access_token,title:$scope.mainKeyword,createType:3,pageIndex:1,pageSize:10},initdocArticleTable()},$scope.pressEnter=function($event){13==$event.keyCode&&$scope.findDocByKeyWord()},$scope.findDocByKeyWord=function(){null==$scope.mainKeyword||0==$scope.mainKeyword.length?(docArticleUrl=app.url.document.getArticleByDoctor,docArticleParam={access_token:app.url.access_token,pageIndex:1,pageSize:10,createType:3}):(docArticleUrl=app.url.document.findArticleByKeyWord,docArticleParam={access_token:app.url.access_token,title:$scope.mainKeyword,pageIndex:1,pageSize:10,createType:3}),initdocArticleTable()};var editArticle=function(id,collect){$state.go("app.document.doctor.edit_article",{id:id},{reload:!0})},removeCollect=function(id,nRow){$http.post(app.url.document.collectArticleRemove,{access_token:app.url.access_token,articleId:id,createType:3}).success(function(data,status,headers,config){1==data.resultCode?(nRow.remove(),toaster.pop("success","","取消收藏成功")):console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})};initdocArticleTable();var clipboard=new Clipboard(".copyUrl");clipboard.on("success",function(e){$scope.$apply(toaster.pop("success","","复制成功")),e.clearSelection()}),clipboard.on("error",function(e){$scope.$apply(toaster.pop("error","","复制失败")),e.clearSelection()}),window.reflashData=function(){initdocArticleTable()},$scope.$on("$destroy",function(){clipboard.destroy()})});