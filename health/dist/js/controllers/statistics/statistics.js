"use strict";app.controller("StatisticCtrl",function($rootScope,$scope,$modal){$scope.tabs={},$scope.tabs.active=[!0,!1,!1],$scope.refresh=[],$scope.tabs.byDisease=function(){$scope.ofDisease=!0,setTimeout(function(){"function"==typeof $scope.refresh[0]&&$scope.refresh[0]()},50)},$scope.tabs.byTitle=function(){$scope.ofTitle=!0,"function"==typeof $scope.refresh[1]&&$scope.refresh[1]()},$scope.tabs.byArea=function(){$scope.ofArea=!0,setTimeout(function(){"function"==typeof $scope.refresh[2]&&$scope.refresh[2]()},50)}}),app.controller("StatisticsOfDisease",function($rootScope,$scope,$state,$http,utils,$modal){function initProTable(res){(setTable=function(){function refresh(){chk_val?(chk_val=!1,showOnJob=!1):(chk_val=!0,showOnJob=!0),InitChart(eChart),level_0_table.destroy()}var level_0_table=$("#level_0_table").DataTable({language:app.lang.datatables.translation,lengthMenu:[100],destroy:!0,searching:!1,paging:!1,ordering:!1,data:res.data,columns:[{data:"name",render:function(data,type,row){return void 0==row.name?"":row.name}},{data:"value",render:function(data,type,row){return void 0==row.value?"":row.value}},{render:function(set,status,dt){return'<button id="showDetail" class="btn btn-xs btn-primary">查 询</button>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#showDetail",function(event){aData.showOnJob=showOnJob,showDetail(aData),event.stopPropagation()})}});_chk=$("#level_0_checkbox"),chk_val?(_chk.attr("checked",!0),chk_val=!0):(_chk.attr("checked",!1),chk_val=!1),_chk.off().click(function(){refresh()}),$scope.$parent.refresh[0]=function(){InitChart(eChart),level_0_table.destroy()}})()}function initCityTable(res){$("#level_1_table").DataTable({destroy:!0,ordering:!1,searching:!1,paging:!1,language:app.lang.datatables.translation,bLengthChange:!1,data:res.data,columns:[{data:"name",render:function(data,type,row){return void 0==row.name?"":row.name}},{data:"value",render:function(data,type,row){return void 0==row.value?"":row.value}},{render:function(set,status,dt){return'<button id="showDetail" class="btn btn-xs btn-primary">查 询</button>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#showDetail",function(event){aData.showOnJob=showOnJob,showDetail(aData),event.stopPropagation()})}})}function initDisTable(res){$("#level_2_table").DataTable({language:app.lang.datatables.translation,destroy:!0,ordering:!1,searching:!1,paging:!1,bLengthChange:!1,data:res.data,columns:[{data:"name",render:function(data,type,row){return void 0==row.name?"":row.name}},{data:"value",render:function(data,type,row){return void 0==row.value?"":row.value}},{render:function(set,status,dt){return'<button id="showDetail" class="btn btn-xs btn-primary">查 询</button>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#showDetail",function(event){aData.showOnJob=showOnJob,showDetail(aData),event.stopPropagation()})}})}function showDetail(aData){console.log(aData);$modal.open({templateUrl:"StatisticeOfDiseaseContent.html",controller:"statistics_of_disease_docModalInstanceCtrl",windowClass:"modal-70-p",resolve:{items:function(){return aData}}})}var access_token=localStorage.getItem("access_token"),curGroupId=localStorage.getItem("curGroupId");require.config({paths:{echarts:"http://www.chinamediportal.com/static/health/echarts/dist"}});var _chk,setTable,eChart,chk_val=!0,showOnJob=!0,InitChart=function(ec){var option,myChart=ec.init(document.getElementById("disease_level"),"macarons");$("#level_1_content").css("visibility","hidden"),$("#level_2_content").css("visibility","hidden"),$http.post(app.url.yiliao.doctorDisease,{access_token:access_token,groupId:curGroupId,showOnJob:showOnJob,diseaseId:"",pageSize:100,pageIndex:0}).success(function(res){console.log(res),1==res.resultCode?(initProTable(res),option={tooltip:{trigger:"item",formatter:"{b} : {c} ({d}%)"},series:[{itemStyle:{normal:{label:{formatter:"{b} : {c}",show:!0},labelLine:{show:!0}}},name:"省级",type:"pie",radius:"22%",center:["50%","17%"],data:res.data}]},myChart.setOption(option,!0)):alert(res.resultMsg)}).error(function(reponse){alert(reponse)});var ecConfig=require("echarts/config");myChart.on(ecConfig.EVENT.CLICK,function(param){"省级"==param.seriesName?($("#level_2_content").css("visibility","hidden"),document.getElementById("disease_level_1").innerHTML="",$http.post(app.url.yiliao.doctorDisease,{access_token:access_token,groupId:curGroupId,showOnJob:showOnJob,diseaseId:param.data.diseaseId,pageSize:100,pageIndex:0}).success(function(res){if(1==res.resultCode){if(0==res.data.length)return;document.getElementById("disease_level_0").innerHTML=param.name,$("#level_1_content").css("visibility","visible"),initCityTable(res),option.series[1]={itemStyle:{normal:{label:{formatter:"{b} : {c}",show:!0},labelLine:{show:!0}}},name:"市级",type:"pie",radius:"22%",center:["50%","50%"],data:res.data},option.series[2]={itemStyle:{normal:{label:{formatter:"{b} : {c}",show:!0},labelLine:{show:!0}}},name:"区级",type:"pie",radius:"22%",center:["50%","85%"],data:[]},myChart.setOption(option,!0)}else alert(res.resultMsg)}).error(function(res){alert(res)})):"市级"==param.seriesName&&$http.post(app.url.yiliao.doctorDisease,{access_token:access_token,groupId:curGroupId,showOnJob:showOnJob,diseaseId:param.data.diseaseId,pageSize:100,pageIndex:0}).success(function(res){if(1==res.resultCode){if(0==res.data.length)return;document.getElementById("disease_level_1").innerHTML=param.name,$("#level_2_content").css("visibility","visible"),initDisTable(res),option.series[2]={itemStyle:{normal:{label:{formatter:"{b} : {c}",show:!0},labelLine:{show:!0}}},name:"区级",type:"pie",radius:"22%",center:["50%","85%"],data:res.data},myChart.setOption(option,!0)}else alert(res.resultMsg)}).error(function(res){alert(res)})})};require(["echarts","echarts/chart/pie"],function(ec){eChart=ec,InitChart(ec)})}),app.controller("statistics_of_disease_docModalInstanceCtrl",function($rootScope,$scope,$state,$http,utils,$modalInstance,items){function initDocsTable(){var index=0,length=10,start=0,size=10,setTable=function(){docsTable=$("#docsTableDisease").DataTable({language:app.lang.datatables.translation,searching:!1,destroy:!0,lengthChange:!0,ordering:!1,draw:index,pageLength:length,lengthMenu:[5,10,20,50],bLengthChange:!1,autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:app.url.yiliao.statDoctor,fnServerData:function(sSource,aoData,fnCallback){console.log(sSource),$.ajax({type:"post",url:sSource,dataType:"json",data:params,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else console.log(resp.resultMsg)}})},columns:[{render:function(set,status,dt){if(dt.headPicFileName)var path=dt.headPicFileName;else var path="src/img/a0.jpg";return'<img class="a-link" src="'+path+'"/></a>'}},{data:"name",defaultContent:""},{data:"doctorNum",defaultContent:""},{data:"title",defaultContent:""},{data:"telephone",defaultContent:""},{data:"remarks",defaultContent:""}]}),docsTable.off("page.dt").on("page.dt",function(e,settings){console.log("分页分页分页"),index=docsTable.page.info().page,start=length*(index-1),console.log(index),console.log(start),params.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=0,start=0,params.pageIndex=0,params.pageSize=len})};setTable()}$scope.rowInfo=items;var docsTable,params={access_token:app.url.access_token,groupId:localStorage.getItem("curGroupId"),type:1,showOnJob:$scope.rowInfo.showOnJob,typeId:items.diseaseId,pageIndex:0,pageSize:10};setTimeout(initDocsTable,0),$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),app.controller("StatisticsOfTitle",function($rootScope,$scope,$state,$http,utils,$modal){function getTitleData(){$http.post(app.urlRoot+"group/stat/title",{access_token:localStorage.getItem("access_token"),groupId:localStorage.getItem("curGroupId"),showOnJob:showOnJob,pageSize:100,pageIndex:0}).success(function(data){if(console.log(data),1===data.resultCode){if(data.data.length<1)return $scope.error="无数据";for(var i=data.data.length-1;i>=0;i--)""==data.data[i].name&&(data.data[i].name="未认证");setData(data.data)}else console.log(data),$scope.error="获取错误"}).error(function(data){console.log(data)})}function showDetail(aData){$modal.open({templateUrl:"StatisticsOfTitleModalContent.html",controller:"statistics_of_title_docModalInstanceCtrl",windowClass:"modal-70-p",resolve:{items:function(){return aData}}})}function setData(data){require.config({paths:{echarts:"http://www.chinamediportal.com/static/health/echarts/dist"}}),require(["echarts","echarts/chart/pie"],function(ec){function refresh(){chk_val?(chk_val=!1,showOnJob=!1):(chk_val=!0,showOnJob=!0),titleTable.destroy(),getTitleData()}var myChart=ec.init(document.getElementById("titleType"),"macarons"),option={tooltip:{trigger:"item",formatter:"{b} : {c} ({d}%)"},series:[{type:"pie",radius:"50%",center:["50%","50%"],data:data,itemStyle:{normal:{label:{formatter:"{b} : {c} ({d}%)"},labelLine:{show:!0}}},dataFilter:function(argument){console.log(argument)}}]};myChart.setOption(option);var titleTable=$("#statisticsOfTitle").DataTable({language:app.lang.datatables.translation,ordering:!1,searching:!1,paging:!1,lengthMenu:[100],data:data,columns:[{data:"name"},{data:"value"},{render:function(set,status,dt){return'<button id="showDetail" class="btn btn-xs btn-primary">查 询</button>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#showDetail",function(event){aData.showOnJob=showOnJob,showDetail(aData),event.stopPropagation()})}}),wrapper=$("#statisticsOfTitle_length"),_lb=$('<label class="checkbox i-checks" style="padding-left:7px"><i style="position:relative;top:0;width:20px;"></i>只显示在职医生</label>');_chk=$('<input type="checkbox" style="width:auto" checked />'),_lb.prepend(_chk),wrapper.append(_lb),_lb.prev().hide(),_chk=$("#statistics_checkbox"),chk_val?(_chk.attr("checked",!0),chk_val=!0):(_chk.attr("checked",!1),chk_val=!1),_chk.off().click(function(){refresh()}),$scope.$parent.refresh[1]=function(){titleTable.destroy(),getTitleData()}})}var showOnJob=!0;getTitleData();var _chk,chk_val=!0}),app.controller("statistics_of_title_docModalInstanceCtrl",function($rootScope,$scope,$state,$http,utils,$modalInstance,items){function initDocsTable(){var index=0,length=10,start=0,size=10,setTable=function(){docsTable=$("#docsTableTitle").DataTable({language:app.lang.datatables.translation,searching:!1,destroy:!0,lengthChange:!0,ordering:!1,draw:index,pageLength:length,lengthMenu:[5,10,20,50],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:app.url.yiliao.statDoctor,fnServerData:function(sSource,aoData,fnCallback){console.log(sSource),$.ajax({type:"post",url:sSource,dataType:"json",data:params,success:function(resp){if(1==resp.resultCode){var data={};console.log(resp.data),data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else console.log(resp.resultMsg)}})},columns:[{render:function(set,status,dt){if(dt.headPicFileName)var path=dt.headPicFileName;else var path="src/img/a0.jpg";return'<img class="a-link" src="'+path+'"/></a>'}},{data:"name",defaultContent:""},{data:"doctorNum",defaultContent:""},{data:"title",defaultContent:""},{data:"telephone",defaultContent:""},{data:"remarks",defaultContent:""}]}),docsTable.off("page.dt").on("page.dt",function(e,settings){console.log("分页分页分页"),index=docsTable.page.info().page,start=length*(index-1),console.log(index),console.log(start),params.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=0,start=0,params.pageIndex=0,params.pageSize=len})};setTable()}$scope.rowInfo=items;var docsTable,params;params="未认证"==items.name?{access_token:app.url.access_token,groupId:localStorage.getItem("curGroupId"),type:2,showOnJob:$scope.rowInfo.showOnJob,typeId:"",pageIndex:0,pageSize:10}:{access_token:app.url.access_token,groupId:localStorage.getItem("curGroupId"),type:2,showOnJob:$scope.rowInfo.showOnJob,typeId:items.name,pageIndex:0,pageSize:10},setTimeout(initDocsTable,0),$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),app.controller("AreaCtrl",function($rootScope,$scope,$http,$modal){function initProTable(res){res.data.forEach(function(item,index,array){void 0==item.id&&(item.name="其他")}),(setTable=function(){function refresh(){chk_val?(chk_val=!1,showOnJob=!1):(chk_val=!0,showOnJob=!0),InitChart(eChart),provinceTable.destroy()}var provinceTable=$("#provinceTable").DataTable({language:app.lang.datatables.translation,destroy:!0,searching:!1,ordering:!1,paging:!1,data:res.data,columns:[{data:"name",render:function(data,type,row){return void 0==row.name?"":row.name}},{data:"value",render:function(data,type,row){return void 0==row.value?"":row.value}},{render:function(set,status,dt){return'<button id="showDetail" class="btn btn-xs btn-primary">查 询</button>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#showDetail",function(event){aData.showOnJob=showOnJob,showDetail(aData),event.stopPropagation()})}});_chk=$("#province_checkbox"),chk_val?(_chk.attr("checked",!0),chk_val=!0):(_chk.attr("checked",!1),chk_val=!1),_chk.off().click(function(){refresh()}),$scope.$parent.refresh[2]=function(){InitChart(eChart),provinceTable.destroy()}})()}function initCityTable(res){$("#cityTable").DataTable({destroy:!0,ordering:!1,searching:!1,paging:!1,language:app.lang.datatables.translation,bLengthChange:!1,data:res.data,columns:[{data:"name",render:function(data,type,row){return void 0==row.name?"":row.name}},{data:"value",render:function(data,type,row){return void 0==row.value?"":row.value}},{render:function(set,status,dt){return'<button id="showDetail" class="btn btn-xs btn-primary">查 询</button>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#showDetail",function(event){aData.showOnJob=showOnJob,showDetail(aData),event.stopPropagation()})}})}function initDisTable(res){$("#districtTable").DataTable({language:app.lang.datatables.translation,destroy:!0,ordering:!1,searching:!1,paging:!1,bLengthChange:!1,data:res.data,columns:[{data:"name",render:function(data,type,row){return void 0==row.name?"":row.name}},{data:"value",render:function(data,type,row){return void 0==row.value?"":row.value}},{render:function(set,status,dt){return'<button id="showDetail" class="btn btn-xs btn-primary">查 询</button>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#showDetail",function(event){aData.showOnJob=showOnJob,showDetail(aData),event.stopPropagation()})}})}function showDetail(aData){$modal.open({templateUrl:"StatisticsOfAreaModalContent.html",controller:"ofarea_docModalInstanceCtrl",windowClass:"modal-70-p",resolve:{items:function(){return aData}}})}function getPre(arr){return arr.slice(0,12)}var access_token=localStorage.getItem("access_token"),curGroupId=localStorage.getItem("curGroupId");require.config({paths:{echarts:"http://www.chinamediportal.com/static/health/echarts/dist"}});var _chk,setTable,eChart,chk_val=!0,showOnJob=!0,InitChart=function(ec){var option,myChart=ec.init(document.getElementById("main"),"macarons");$("#cityContent").css("visibility","hidden"),$("#districtContent").css("visibility","hidden"),$http.post(app.url.yiliao.doctorArea,{access_token:access_token,groupId:curGroupId,showOnJob:showOnJob,areaId:"",pageSize:100,pageIndex:0}).success(function(res){1==res.resultCode?(initProTable(res),option={tooltip:{trigger:"item",formatter:"{b} : {c} ({d}%)"},series:[{itemStyle:{normal:{label:{formatter:"{b} : {c}",show:!0},labelLine:{show:!0}}},name:"省级",type:"pie",radius:"25%",center:["50%","17%"],data:getPre(res.data)}]},myChart.setOption(option,!0)):alert(res.resultMsg)}).error(function(reponse){alert(reponse)});var ecConfig=require("echarts/config");myChart.on(ecConfig.EVENT.CLICK,function(param){if(void 0!=param.data.id){param.name;"省级"==param.seriesName?(document.getElementById("curProvince").innerHTML=param.name,$("#cityContent").css("visibility","visible"),$("#districtContent").css("visibility","hidden"),document.getElementById("curCity").innerHTML="",$http.post(app.url.yiliao.doctorArea,{access_token:access_token,groupId:curGroupId,showOnJob:showOnJob,areaId:param.data.id,pageSize:100,pageIndex:0}).success(function(res){1==res.resultCode?(initCityTable(res),option.series[1]={itemStyle:{normal:{label:{formatter:"{b} : {c}",show:!0},labelLine:{show:!0}}},name:"市级",type:"pie",radius:"25%",center:["50%","50%"],data:getPre(res.data)},option.series[2]={itemStyle:{normal:{label:{formatter:"{b} : {c}",show:!0},labelLine:{show:!0}}},name:"区级",type:"pie",radius:"25%",center:["50%","85%"],data:[]},myChart.setOption(option,!0)):alert(res.resultMsg)}).error(function(res){alert(res)})):"市级"==param.seriesName&&($("#districtContent").css("visibility","visible"),document.getElementById("curCity").innerHTML=param.name,$http.post(app.url.yiliao.doctorArea,{access_token:access_token,groupId:curGroupId,showOnJob:showOnJob,areaId:param.data.id,pageSize:100,pageIndex:0}).success(function(res){1==res.resultCode?(initDisTable(res),option.series[2]={itemStyle:{normal:{label:{formatter:"{b} : {c}",show:!0},labelLine:{show:!0}}},name:"区级",type:"pie",radius:"25%",center:["50%","85%"],data:getPre(res.data)},myChart.setOption(option,!0)):alert(res.resultMsg)}).error(function(res){alert(res)}))}})};require(["echarts","echarts/chart/pie"],function(ec){eChart=ec,InitChart(ec)})}),app.controller("ofarea_docModalInstanceCtrl",function($rootScope,$scope,$state,$http,utils,$modalInstance,items){function initDocsTable(){var index=0,length=10,start=0,size=10,setTable=function(){docsTable=$("#docsTable").DataTable({language:app.lang.datatables.translation,searching:!1,destroy:!0,lengthChange:!0,ordering:!1,draw:index,pageLength:length,lengthMenu:[5,10,20,50],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:app.url.yiliao.statDoctor,fnServerData:function(sSource,aoData,fnCallback){console.log(sSource),$.ajax({type:"post",url:sSource,dataType:"json",data:params,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else console.log(resp.resultMsg)}})},columns:[{render:function(set,status,dt){if(dt.headPicFileName)var path=dt.headPicFileName;else var path="src/img/a0.jpg";return'<img class="a-link" src="'+path+'"/></a>'}},{data:"name",defaultContent:""},{data:"doctorNum",defaultContent:""},{data:"title",defaultContent:""},{data:"telephone",defaultContent:""},{data:"remarks",defaultContent:""}]}),docsTable.off("page.dt").on("page.dt",function(e,settings){console.log("分页分页分页"),index=docsTable.page.info().page,start=length*(index-1),console.log(index),console.log(start),params.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=0,start=0,params.pageIndex=0,params.pageSize=len})};setTable()}$scope.rowInfo=items;var docsTable,params;params=items.id?{access_token:app.url.access_token,groupId:localStorage.getItem("curGroupId"),type:3,showOnJob:$scope.rowInfo.showOnJob,typeId:items.id,pageIndex:0,pageSize:10}:{access_token:app.url.access_token,groupId:localStorage.getItem("curGroupId"),type:3,showOnJob:$scope.rowInfo.showOnJob,typeId:"",pageIndex:0,pageSize:10},setTimeout(initDocsTable,0),$scope.cancel=function(){$modalInstance.dismiss("cancel")}});