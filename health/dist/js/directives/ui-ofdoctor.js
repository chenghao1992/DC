app.directive("doctorDetails",["uiLoad","JQ_CONFIG","$document","$http","Doctor","$state","$stateParams","modal","utils","Group","AppFactory",function(uiLoad,JQ_CONFIG,$document,$http,Doctor,$state,$stateParams,modal,utils,Group,AppFactory){return{restrict:"E",templateUrl:"src/tpl/directives/doctor_details.html",link:function(scope,el,attr){function watch(){if(scope.$root){if(scope.$root.winVisable){profitContacts=null,apportionContacts=null,firstVisit=!0,clearInterval(timer),html.css("overflow","hidden");var tab_first=el.find(".tab-container li").first();tab_first.hasClass("active")?(scope.tabs.show(),firstVisit=!1):tab_first.children("a").trigger("click")}}else clearInterval(timer)}function _getData(url,param,target){var dt={access_token:app.url.access_token,groupId:groupId};$.extend(dt,param),$http({url:url,method:"post",data:dt}).then(function(resp){1===resp.data.resultCode&&resp.data.data?(target.html(resp.data.data.total),"J"===param.status&&0===resp.data.data.total&&($rootScope.hasUncheckedMumber=!1)):console.warn("编辑失败！")},function(x){console.error(x.statusText)})}var profitContacts,apportionContacts,groupId=utils.localData("curGroupId"),firstVisit=!1,dataInfo={},dataProfit={},dataApportion={};scope.$root.winVisable=!1,scope.isInit=!0;var timer=setInterval(watch,200);scope.tabs={},scope.tabs.tabInfo={},scope.tabs.tabProfit={},scope.tabs.tabApportion={},scope.viewData={},scope.formData={},scope.imgs=!1,scope.isNormal=!1,scope.isQuit=!0,scope.apportion=function(id){},scope.quit=function(id){scope.$root.quitStatus=!0,$("#pop_win").removeClass("hide")};var data={},html=$("html");scope.tabs.show=function(){function createSchedule(dt){var times=[[],[],[]];if(dt){var dates=dt,m=0,n=0;if(dates)for(var i=0;i<dates.length;i++)if(m=1*dates[i].period,n=1*dates[i].week,dates[i].startTime&&dates[i].endTime){var start=dates[i].startTime.substr(0,2)+":"+dates[i].startTime.substr(2,2),end=dates[i].endTime.substr(0,2)+":"+dates[i].endTime.substr(2,2);times[m-1][n%7]=start+"-"+end}}for(var days=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],table=$("<table></table>"),thead=$("<thead></thead>"),tbody=$("<tbody></tbody>"),i=0;i<4;i++){for(var tr=$("<tr></tr>"),j=0;j<7;j++){var td=$("<td></td>");0===i?td.html(days[j]):times[i-1]&&times[i-1][j]?td.html(times[i-1][j]):td.html("&nbsp;"),tr.append(td)}0===i?thead.append(tr):tbody.append(tr)}table.append(thead).append(tbody),$("#duty_schedule").html("").append(table)}firstVisit&&Doctor.getAsyncData(function(dt){if(!dt)return data={},scope.isQuit=!0,scope.viewData={},scope.isInit=!0,void(scope.isLoading=!0);scope.isInit=!1,data=dt,scope.targetDoctorId=data.doctorId,scope.viewData.headPicFile=data.headPic,scope.viewData.name=data.name,scope.viewData.inviter=data.inviter,scope.viewData.userStatus="1"==data.state?"审核通过":"2"==data.state?"待审核":"3"==data.state?"审核未通过":"未认证",scope.viewData.info=data.info,scope.viewData.contactWay=data.contactWay,scope.viewData.introduction=data.introduction,scope.viewData.skill=data.skill,scope.viewData.relation=data.relation,scope.viewData.remarks=data.remarks,scope.viewData.area=data.area.province+" - "+data.area.city+" - "+data.area.country,scope.viewData.departments=data.departments,scope.viewData.services=data.service.join(", "),scope.tabs.tabInfo.contactWay=scope.viewData.contactWay,scope.tabs.tabInfo.remarks=scope.viewData.remarks,dataInfo.contactWay=scope.viewData.contactWay,dataInfo.remarks=scope.viewData.remarks,"I"===data.status?(scope.isNormal=!1,scope.isQuit=!0,scope.isApply=!1):"C"===data.status?(scope.isNormal=!0,scope.isQuit=!1,scope.isApply=!1):"S"===data.status?(scope.isNormal=!1,scope.isQuit=!0,scope.isApply=!1):"J"===data.status?(scope.isNormal=!1,scope.isQuit=!0,scope.isApply=!0):deptId?(scope.isNormal=!0,scope.isQuit=!1,scope.isApply=!1):(scope.isNormal=!1,scope.isQuit=!0,scope.isApply=!1);var deptId=data.departmentId;deptId?$http({url:app.url.yiliao.getSchedule,method:"post",data:{access_token:app.url.access_token,doctorId:data.doctorId}}).then(function(resp){if(1===resp.data.resultCode&&resp.data.data.online){var dt=resp.data.data.online;createSchedule(dt)}else createSchedule(null)},function(x){console.error(x.statusText)}):createSchedule(null)}),scope.apply=function(bool){$http({url:app.url.yiliao.confirmByDoctorApply,method:"post",data:{access_token:app.url.access_token,id:data.groupDoctorId,approve:bool}}).then(function(resp){1===resp.data.resultCode?(bool?(modal.toast.success("已接受！"),scope.isQuit=!1):modal.toast.success("已拒绝！"),scope.isApply=!1):modal.toast.warn(resp.data.resultMsg)},function(x){console.error(x.statusText)})},scope.saveDoctorInfo=function(){scope.tabs.tabInfo.contactWay=scope.viewData.contactWay,scope.tabs.tabInfo.remarks=scope.viewData.remarks;var allEqual=!0;for(var k in dataInfo)if(dataInfo[k]!==scope.tabs.tabInfo[k]){allEqual=!1;break}return!!allEqual||($http({url:app.url.yiliao.updateDoctor,method:"post",data:{access_token:app.url.access_token,id:data.groupDoctorId,contactWay:scope.viewData.contactWay,remarks:scope.viewData.remarks}}).then(function(resp){1===resp.data.resultCode&&modal.toast.success("资料保存成功！")},function(x){console.error(x.statusText)}),!0)}},scope.tabs.select=function(){return scope.imgs?void(scope.isLoading=!1):data.doctorId?(scope.isLoading=!0,void $http.get(app.url.doctor.getDoctorFile+"?"+$.param({doctorId:data.doctorId,access_token:app.url.access_token,type:5})).then(function(dt){if(dt=dt.data.data,dt&&dt.length>0){scope.imgs=[];for(var i=0;i<dt.length;i++)scope.imgs.push(dt[i].url);0===scope.imgs.length&&(scope.imgs=!1)}else scope.imgs=!1;scope.isLoading=!1})):void(scope.isLoading=!0)},scope.tabs.setProfit=function(){function monitor(){watch_profit=scope.$watchGroup(profits,function(newValue,oldValue){for(var n=5;n--;){if(void 0!==newValue[2*n+1]&&isNaN(1*newValue[2*n+1])||void 0!==newValue[2*n]&&isNaN(1*newValue[2*n])){profits_tips.html("抽成比例必须为纯数字！"),scope.settingsForm.$invalid=!0;break}if(1*newValue[2*n+1]>100||1*newValue[2*n]>100){profits_tips.html("单个抽成比例不能大于100%！"),scope.settingsForm.$invalid=!0;break}if(1*newValue[2*n+1]<0||1*newValue[2*n]<0){profits_tips.html("单个抽成比例不能小于0！"),scope.settingsForm.$invalid=!0;break}if(1*newValue[2*n+1]+1*newValue[2*n]>100){profits_tips.html("集团与上级抽成比例之和不能大于100%！"),scope.settingsForm.$invalid=!0;break}profits_tips.html(""),scope.settingsForm.$invalid=!1}})}function check(info){if(scope.targetDoctorId==info.id)return list_wrapper.html(""),parentId=null,void modal.toast.warn("不能选择自己！");for(var dts=profitContacts.tree.find("dt"),curDt=null,i=0;i<dts.length;i++)if(dts.eq(i).data("info").id==data.doctorId){curDt=dts.eq(i);break}if(curDt){dts=curDt.parent().children("dd").find("dt");for(var i=0;i<dts.length;i++)if(dts.eq(i).data("info").id==info.id)return list_wrapper.html(""),parentId=null,modal.toast.warn("不能选择自己的下级！"),void(scope.hasSuper=!1)}var target=$(profitContacts.getTargets());if(0===target.length)return parentId=null,void list_wrapper.html("");var span=(target.data("info"),$('<span class="label-btn btn-info"></span>')),i=$('<i class="fa fa-times"></i>');parentId=info.id,list_wrapper.html(""),list_wrapper.html(span.html(info.name).append(i)),i.click(function(){profitContacts.setCheck(info.id),list_wrapper.html(""),parentId=null,scope.hasSuper=!1}),scope.hasSuper=!0}Group.handle(data.groupId,function(group){group&&AppFactory&&AppFactory.group.isServiceGroup(group.id).then(function(_data){_data?scope.isServiceGroup=!0:scope.isServiceGroup=!1})});var profits,list_wrapper=$("#cnt_list_department"),profits_tips=$("#profits_tips"),parentId=null;profits=scope.isServiceGroup?["formData.appointmentParentProfit","formData.appointmentGroupProfit","formData.chargeItemParentProfit","formData.chargeItemGroupProfit","formData.textParentProfit","formData.textGroupProfit","formData.phoneParentProfit","formData.phoneGroupProfit","formData.carePlanParentProfit","formData.carePlanGroupProfit"]:["formData.clinicParentProfit","formData.clinicGroupProfit","formData.textParentProfit","formData.textGroupProfit","formData.phoneParentProfit","formData.phoneGroupProfit","formData.carePlanParentProfit","formData.carePlanGroupProfit","formData.consultationParentProfit","formData.consultationGroupProfit"];var watch_profit;monitor(),scope.formData.appointmentGroupProfit=data.appointmentGroupProfit,scope.formData.appointmentParentProfit=data.appointmentParentProfit,scope.formData.chargeItemGroupProfit=data.chargeItemGroupProfit,scope.formData.chargeItemParentProfit=data.chargeItemParentProfit,scope.formData.textGroupProfit=data.textGroupProfit,scope.formData.textParentProfit=data.textParentProfit,scope.formData.phoneGroupProfit=data.phoneGroupProfit,scope.formData.phoneParentProfit=data.phoneParentProfit,scope.formData.carePlanGroupProfit=data.carePlanGroupProfit,scope.formData.carePlanParentProfit=data.carePlanParentProfit,scope.formData.clinicGroupProfit=data.clinicGroupProfit,scope.formData.clinicParentProfit=data.clinicParentProfit,scope.formData.consultationGroupProfit=data.consultationGroupProfit,scope.formData.consultationParentProfit=data.consultationParentProfit,dataProfit.appointmentGroupProfit=scope.formData.appointmentGroupProfit,dataProfit.appointmentParentProfit=scope.formData.appointmentParentProfit,dataProfit.chargeItemGroupProfit=scope.formData.chargeItemGroupProfit,dataProfit.chargeItemParentProfit=scope.formData.chargeItemParentProfit,dataProfit.textGroupProfit=scope.formData.textGroupProfit,dataProfit.textParentProfit=scope.formData.textParentProfit,dataProfit.phoneGroupProfit=scope.formData.phoneGroupProfit,dataProfit.phoneParentProfit=scope.formData.phoneParentProfit,dataProfit.carePlanGroupProfit=scope.formData.carePlanGroupProfit,dataProfit.carePlanParentProfit=scope.formData.carePlanParentProfit,dataProfit.clinicGroupProfit=scope.formData.clinicGroupProfit,dataProfit.clinicParentProfit=scope.formData.clinicParentProfit,dataProfit.consultationGroupProfit=scope.formData.consultationGroupProfit,dataProfit.consultationParentProfit=scope.formData.consultationParentProfit,dataProfit.parentId=data.parentId,scope.viewData.name=data.name,profitContacts||(list_wrapper.html(""),profitContacts=new Tree("cnt_list_relationship",{hasCheck:!0,multiple:!1,self:!0,arrType:[1,0,0],data:{url:app.url.yiliao.getProfitTree,param:{access_token:app.url.access_token,groupId:data.groupId}},excluded:{key:{name:"id",value:data.doctorId},scope:"all",type:"disabled",icon:"fa fa-user-md text-muted"},async:!1,icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check",root:"fa fa-hospital-o tomato",branch:"fa fa-user-md tomato",leaf:"fa fa-user-md tomato"},info:{name:"name",id:"id",pid:"parentId",description:"description"},datakey:{id:"id",name:"name",sub:"children"},events:{click:check},callback:function(){for(var dts=profitContacts.tree.find("dt"),curDt=null,i=0;i<dts.length;i++)if(dts.eq(i).data("info").id==data.parentId){curDt=dts.eq(i);break}curDt&&curDt.trigger("click")}})),scope.saveProfit=function(){if(scope.formData.appointmentGroupProfit>100||scope.formData.appointmentParentProfit>100||scope.formData.chargeItemGroupProfit>100||scope.formData.chargeItemParentProfit>100||scope.formData.textGroupProfit>100||scope.formData.textParentProfit>100||scope.formData.phoneGroupProfit>100||scope.formData.phoneParentProfit>100||scope.formData.carePlanGroupProfit>100||scope.formData.carePlanParentProfit>100||scope.formData.clinicGroupProfit>100||scope.formData.clinicParentProfit>100||scope.formData.consultationGroupProfit>100||scope.formData.consultationParentProfit>100)return modal.toast.warn("抽成比例不能大于100"),!1;var param={access_token:app.url.access_token,groupId:data.groupId,parentId:parentId,id:scope.targetDoctorId};return $http({url:app.url.yiliao.updateProfitRelation,method:"post",data:param}).then(function(resp){1===resp.data.resultCode?modal.toast.success("抽成关系设置成功！"):modal.toast.warn("抽成关系设置失败！ ("+resp.data.resultMsg+")")},function(x){console.error(x.statusText)}),dataProfit.appointmentGroupProfit==scope.formData.appointmentGroupProfit&&dataProfit.appointmentParentProfit==scope.formData.appointmentParentProfit&&dataProfit.chargeItemGroupProfit==scope.formData.chargeItemGroupProfit&&dataProfit.chargeItemParentProfit==scope.formData.chargeItemParentProfit&&dataProfit.textGroupProfit==scope.formData.textGroupProfit&&dataProfit.textParentProfit==scope.formData.textParentProfit&&dataProfit.phoneGroupProfit==scope.formData.phoneGroupProfit&&dataProfit.phoneParentProfit==scope.formData.phoneParentProfit&&dataProfit.carePlanGroupProfit==scope.formData.carePlanGroupProfit&&dataProfit.carePlanParentProfit==scope.formData.carePlanParentProfit&&dataProfit.clinicGroupProfit==scope.formData.clinicGroupProfit&&dataProfit.clinicParentProfit==scope.formData.clinicParentProfit&&dataProfit.consultationGroupProfit==scope.formData.consultationGroupProfit&&dataProfit.consultationParentProfit==scope.formData.consultationParentProfit||(param={access_token:app.url.access_token,groupId:data.groupId,id:scope.targetDoctorId,appointmentGroupProfit:scope.formData.appointmentGroupProfit,appointmentParentProfit:scope.formData.appointmentParentProfit,chargeItemGroupProfit:scope.formData.chargeItemGroupProfit,chargeItemParentProfit:scope.formData.chargeItemParentProfit,textGroupProfit:scope.formData.textGroupProfit,textParentProfit:scope.formData.textParentProfit,phoneGroupProfit:scope.formData.phoneGroupProfit,phoneParentProfit:scope.formData.phoneParentProfit,carePlanGroupProfit:scope.formData.carePlanGroupProfit,carePlanParentProfit:scope.formData.carePlanParentProfit,clinicGroupProfit:scope.formData.clinicGroupProfit,clinicParentProfit:scope.formData.clinicParentProfit,consultationGroupProfit:scope.formData.consultationGroupProfit,consultationParentProfit:scope.formData.consultationParentProfit},$http({url:app.url.yiliao.updateProfit,method:"post",data:param}).then(function(resp){1===resp.data.resultCode?modal.toast.success("抽成比例保存成功！"):modal.toast.warn("抽成比例修改失败！ ("+resp.data.resultMsg+")")},function(x){console.error(x.statusText)})),!0}},scope.tabs.apportion=function(){function check(info){var target=$(apportionContacts.getTargets());if(0===target.length)return void list_wrapper.html("");list_arr=[];var span=$('<span class="label-btn btn-info"></span>'),i=$('<i class="fa fa-times"></i>');scope.formData.id=info.id,list_arr.push(info.id),list_wrapper.html(""),list_wrapper.html(span.html(info.name).append(i)),i.click(function(){apportionContacts.setCheck(info.id),list_wrapper.html(""),scope.formData.id=null,list_arr=[]}),scope.tabs.tabApportion.dptId=info.id}var list_wrapper=$("#cnt_list_wrapper"),list_arr=[];data.doctorId&&(scope.viewData.headPicFile=data.headPic,scope.tabs.tabApportion.dptId=0,dataApportion.dptId=0,apportionContacts||(list_wrapper.html(""),apportionContacts=new Tree("cnt_list_apportion",{hasCheck:!0,multiple:!1,self:!0,arrType:[1,1,1,0],data:{url:app.url.yiliao.getAllData,param:{access_token:app.url.access_token,groupId:data.groupId}},async:!1,icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check/fa fa-square",root:"fa fa-hospital-o dcolor",branch:"fa fa-h-square dcolor",leaf:"fa fa-h-square dcolor"},datakey:{id:"id",name:"name",sub:"subList"},info:{name:"name",id:"id",pid:"parentId",description:"description"},events:{click:check},callback:function(){for(var dts=apportionContacts.tree.find("dt"),curDt=null,i=0;i<dts.length;i++)if(dts.eq(i).data("info").id==data.departmentId){curDt=dts.eq(i);break}curDt&&curDt.trigger("click")}})),scope.saveApportion=function(){if(dataApportion.dptId!==scope.tabs.tabApportion.dptId){if(0===list_arr.length)return modal.toast.warn("请选择组织！"),!1;$http({url:app.url.yiliao.saveDoctor,method:"post",data:{access_token:app.url.access_token,departmentIds:list_arr.length>0?list_arr:0,doctorId:data.doctorId,groupId:data.groupId}}).then(function(resp){1===resp.data.resultCode?modal.toast.success("组织分配成功！"):modal.toast.warn("分配失败！")},function(x){console.error(x.statusText)})}return!0})},scope.tabs.otherInfo=function(){return scope.viewData.inviteCode=window.location.protocol+"//"+window.location.host+"/health/web/appInvite/joinToGroup.html?groupId="+data.groupId+"&doctorId="+data.doctorId,scope.isLoading=!1,scope.info?void(scope.isLoading=!1):(scope.isLoading=!0,void $http({url:app.url.yiliao.getUserDetail,data:{userId:data.doctorId,access_token:app.url.access_token},method:"post"}).then(function(dt){dt=dt.data.data,dt&&dt.length>0?scope.info=dt:scope.info=!1,scope.isLoading=!1}))},scope.copyText=function(e){utils.copyToClipboard(scope.viewData.inviteCode)},scope.save=function(){var allDone=!0;if(scope.saveDoctorInfo&&(scope.saveDoctorInfo()||(allDone=!1)),scope.saveProfit&&(scope.saveProfit()||(allDone=!1)),scope.saveApportion&&(scope.saveApportion()||(allDone=!1)),allDone){var href=window.location.hash.substring(2).replace(/\//g,".");if($stateParams.hasOwnProperty("id")){var idx=href.lastIndexOf("."),id=$stateParams.id;href=href.substring(0,idx),$state.go(href,{id:id+"/"+(new Date).getTime()},{reload:!0});var numEle=$("#doctor_asked").html("0");_getData(app.url.yiliao.searchDoctor,{status:"J"},numEle)}}scope.cancel()},scope.cancel=function(){scope.imgs=null,scope.$root.winVisable=!1,firstVisit=!0,timer=setInterval(watch,200),el.addClass("hide"),html.css("overflow","auto")}},post:function(){console.log("---------------->")}}}]),app.directive("popWin",["uiLoad","JQ_CONFIG","$document","$http","Doctor","$state","modal",function(uiLoad,JQ_CONFIG,$document,$http,Doctor,$state,modal){return{restrict:"E",templateUrl:"src/tpl/directives/pop_win.html",link:function(scope,el,attr){function watch(){scope.$root?scope.$root.quitStatus&&(clearInterval(timer),init()):clearInterval(timer)}function init(){data=Doctor.getData(),scope.viewData.headPicFile=data.headPic,scope.viewData.name=data.name,scope.viewData.info=data.info}var data={};scope.viewData={},scope.showInfo=!0,scope.showWarn=!1,scope.$root.quitStatus=!1;var timer=setInterval(watch,200);scope.doQuit=function(){$http({url:app.url.yiliao.dimission,method:"post",data:{access_token:app.url.access_token,groupId:data.groupId,doctorId:data.doctorId}}).then(function(resp){1===resp.data.resultCode?(modal.toast.success("解除成功！"),$state.reload(function(){scope.toCurPage&&scope.toCurPage()})):(scope.showInfo=!1,scope.showWarn=!0,scope.viewData.warn_text=resp.data.resultMsg||"操作失败！",console.warn((resp.data.resultMsg||"操作失败！")+" (代码："+resp.data.resultCode+")"),modal.toast.warn((resp.data.resultMsg||"操作失败！")+" (代码："+resp.data.resultCode+")"))},function(x){console.error(x.statusText)})},scope.exit=function(){scope.imgs=null,scope.$root.quitStatus=!1,timer=setInterval(watch,200),el.addClass("hide")}}}}]);