!function(window,undefined){"use strict";var isCommonjs="undefined"!=typeof module&&module.exports,keyboardAllowed="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element,DataBox=function(id,settings){return this.settings=settings,this.targets=[],this.fixdata=[],this.targetsId=[],this.tempId=[],this.tags=[],this.tagsId=[],this.unionId=[],this.hasSub=!1,this.isTrigger=!0,this.dataKey=this.deepClone(this.settings.datakey),this.init(id,this.settings),this};DataBox.prototype={init:function(id,set){function combineData(dt){that.deepCloneWithKey(that.treeObj.getSourceData(),dt)}function btnSearch(){var _key=$.trim($("#keys_ipt").val()),sourceData=that.treeObj.getSourceData();if(tempKey=_key,_key||"0"==_key){set.loadDisabled=!0;var dataSource=that.treeObj.getSourceData();if(set.search.searchDepth&&that.treeObj.setLeafDepth(leafDepth-set.search.searchDepth[0]),set.async){var _param=set.search.param;set.search.keyName&&(_param[set.search.keyName]=_key),$.ajax({dataType:"json",url:set.search.url,method:"post",data:_param,success:function(resp){if(1===resp.resultCode&&resp.data){var dts=eval("resp."+set.search.dataKey.dataSet);if(dts.length>0)for(var _dt=[],i=0;i<dts.length;i++){var union=eval("dts["+i+"]."+set.search.dataKey.union);union||(union=set.extra[0].id),union?(_dt[i]={},_dt[i].name=eval("dts["+i+"]."+set.search.dataKey.name),_dt[i].id=eval("dts["+i+"]."+set.search.dataKey.id),_dt[i].union=union):(_dt[i]={},_dt[i].name=eval("dts["+i+"]."+set.search.dataKey.name),_dt[i].id=eval("dts["+i+"]."+set.search.dataKey.id))}if(that.settings.search.unwind=!0,_dt&&_dt.length>0){if(union&&!set.search.unLayered)var _data=that.deepCloneWithKey(that.treeObj.getSourceData(),_dt);else var _data=_dt;that.treeObj.setTree(_data)}else that.treeObj.setTree(null)}else that.treeObj.setTree(null)},error:function(resp){console.error(resp.resultMsg)}})}else{that.treeObj.setLeafDepth(leafDepth);var dts=that.queryByKey(dataSource,_key,!1,null,["name"],set.search.searchDepth||null);if(dts.length>0)for(var _dt=[],i=0;i<dts.length;i++){var union=eval("dts["+i+"]."+set.search.dataKey.union);if(union||(union=set.extra[0].id),!union)return;_dt[i]={},_dt[i].name=eval("dts["+i+"]."+set.search.dataKey.name),_dt[i].id=eval("dts["+i+"]."+set.search.dataKey.id),_dt[i].union=union}if(that.settings.search.unwind=!0,_dt&&_dt.length>0){var _data=that.deepCloneWithKey(that.treeObj.getSourceData(),_dt);that.treeObj.setTree(_data)}else that.treeObj.setTree(null)}}else that.settings.search.unwind=!1,that.treeObj.setLeafDepth(leafDepth),that.treeObj.setTree(sourceData)}function handlerUp(){}function handlerDown(){}function click(info){var tempsAdd=that.treeObj.getTempsAdd(),tempsIdAdd=that.treeObj.getTempsIdAdd(),lenAdd=tempsIdAdd.length,tempsSub=that.treeObj.getTempsSub(),tempsIdSub=that.treeObj.getTempsIdSub(),lenSub=tempsIdSub.length;if(that.hasSub=!1,$(this).next&&$(this).next().length>0&&(that.hasSub=!0),!set.multiple)return void(that.targets=tempsAdd);for(var i=0;i<lenAdd;i++){var _idx=that.tempId.indexOf(tempsIdAdd[i]);_idx===-1&&(that.targetsId.push(tempsIdAdd[i]),that.tempId.push(tempsIdAdd[i]),set.unionSelect&&that.hasSub||that.insertTag(tempsAdd[i],!0))}for(var i=0;i<lenSub;i++){var _idx=that.tempId.indexOf(tempsIdSub[i]);_idx!==-1&&(that.targetsId.splice(_idx,1),that.tempId.splice(_idx,1),set.unionSelect&&that.hasSub||that.insertTag(tempsSub[i],!1))}if(set.unionSelect&&that.hasSub){var _idx=that.unionId.indexOf(info.id);_idx===-1?(that.insertTag($(this),!0),that.unionId.push($(this).data("info").id)):(that.insertTag($(this),!1),that.unionId.splice(_idx,1))}that.setNumber()}function mouseEnter(info){var _this=$(this);if(_this.next().length>0){that.treeObj.tree.find(".back-line");iMove=$('<i class="pos-delete fa fa-arrow-right"></i>'),$(this).append(iMove),iMove.click(function(e){var evt=e||window.event;if(evt.stopPropagation(),that.settings.async){var _param={};_param.access_token=app.url.access_token;for(var key in that.settings.async.data)_param[key]=that.settings.async.data[key];for(var key in that.settings.async.dataKey)_param[key]=_this.data("info")[that.settings.async.dataKey[key]];$.ajax({dataType:"json",url:that.settings.async.url,method:"post",data:_param,success:function(resp){1===resp.resultCode&&resp.data?(_this.isLeaf=!0,e.data.pNode.data("subs",resp.data),_this.insertNodes(e.data.pNode,resp.data)):1030102===resp.resultCode&&(window.location.href="#/access/signin"),loading.remove(),setCurLine()},error:function(resp){console.error(resp.resultMsg)}})}else{var dts=[];dts=_this.next().find("dt"),dts.each(function(){$(this).next("dd").length>0||that.targets.indexOf($(this).data("info"))!==-1||(that.targets.push($(this).data("info")),that.insertTag($(this).data("info")))})}})}}function mouseLeave(id){iMove.remove()}var that=this;if(set.fixdata&&set.fixdata.length>0)for(var len=set.fixdata.length,i=0;i<len;i++)this.fixdata.push(set.fixdata[i]),this.targetsId.push(set.fixdata[i].id);this.targets=this.fixdata;for(var targets=this.fixdata,l=targets.length,i=0;i<l;i++)this.tempId.push(targets[i].id);if(set.events||(set.events={},set.events.click=click,set.unionSelect),set.events.callback=function(treeObj){function _getData(url,param,pNode){var dt={access_token:app.url.access_token,groupId:groupId};$.extend(dt,param),$http({url:url,method:"post",data:dt}).then(function(resp){if(1===resp.data.resultCode&&resp.data.data){var _dt=resp.data.data;that.treeObj.insertNodes(pNode,_dt),that.treeObj.initCheckStatus()}else console.warn("获取未分配数据失败！")},function(x){console.error(x.statusText)})}if(treeObj){that.treeObj=treeObj;var dts=that.treeObj.getTree().find("dt"),len=dts.length,ln=that.targetsId.length,dt=$();if(set.hasCheck&&set.selectView)for(var i=0;i<ln;i++)for(var j=0;j<len;j++)dt=dts.eq(j),dt.data("info").id===that.targetsId[i]&&dt.trigger("click");for(var n=1;n--;){var dl=$('<dl class="cnt-list-warp"></dl>'),dt=$("<dt></dt>"),iIcon=($("<dd></dd>"),$('<i class="fa fa-caret-right"></i>'),$('<i class="fa-fw"></i>')),span=$("<span></span>");1===n&&(iIcon.addClass("fa fa-bookmark"),span.html("未分配")),dt.append(iIcon).append(span),dl.append(dt),that.treeObj.treeWrapper.append(dl),dt.data("info",{id:"idx_"+n});var cur_div,tTop=that.treeObj.treeWrapper.offset().top+1;dt.bind("click",function(e){var evt=e||window.event;evt.stopPropagation(),0===that.treeObj.treeWrapper.find(".cur-back-line").length?(cur_div=$('<div class="cur-back-line"></div>'),that.treeObj.treeWrapper.append(cur_div)):cur_div=that.treeObj.treeWrapper.find(".cur-back-line"),that.treeObj.treeWrapper.find(".cur-line").removeClass("cur-line"),$(this).addClass("cur-line"),tTop=that.treeObj.treeWrapper.offset().top+1,cur_div.css("top",$(this).offset().top-tTop),_getData(app.url.yiliao.getUndistributed,{},dl)});var div;dt.hover(function(){tTop=that.treeObj.treeWrapper.offset().top+1,div=$('<div class="back-line"></div>'),div.css("top",$(this).offset().top-tTop),that.treeObj.treeWrapper.append(div)},function(){div.remove()})}}},!window.Tree)return void alert('The "Tree" companent is not loaded!');var mask=$('<div class="mask"></div>'),templete='<div class="dialog-heading font-bold text-center">'+(set.titles?set.titles.main:"选择数据")+'</div><div class="dialog-body '+(set.search||set.selectView?"select-view":"")+'"><div class="'+(set.search||set.selectView?"search-ipt":"")+'">'+(set.search?'<div class="search-form '+(set.selectView?"dialog-bar":"")+'"><input id="keys_ipt" autocomplete="off" placeholder='+(set.titles?set.titles.searchKey:"关键字")+' class="form-control"/><i id="btn_search" class="fa icon-magnifier"></i></div>':"")+(set.selectView?'<div class="data-num">'+(set.titles?set.titles.label:"已选择个数")+':<span id="data_num">20</span></div>':"")+"</div>"+(set.selectView?'<div class="box-r"><div id="data_box" class="data-box"></div></div>':"")+'<div class="box-l"><div id="data_res"><div class="loading"><i class="glyphicon glyphicon-repeat"></i></div></div></div></div><div class="dialog-opr-bar clear"><div class="col-md-offset-2 col-md-4" id="opr_ok"></div><div class="col-md-4" id="opr_cancal"></div></div>',container=$("<div></div>");container.addClass("dialog-container animating fade-in-down").html(templete),$("body").append(mask).append(container),container.css("margin-left",-(container.width()/2)),that.treeObj=new Tree(id,set,this.fixdata);var oprOk=$("#opr_ok"),oprCancal=$("#opr_cancal"),btn_ok=$('<button type="button" class="w100 btn btn-success">确 定</button>'),btn_cancel=$('<button type="button" class="w100 btn btn-default">取 消</button>'),btn_search=$("#btn_search"),keys_ipt=$("#keys_ipt"),leafDepth=set.leafDepth,timer=0,tempKey="",isSearching=!1;this.data_num=$("#data_num").html(this.targets.length),oprOk.append(btn_ok),oprCancal.append(btn_cancel),keys_ipt.focus(function(){timer=setInterval(function(){var _key=$.trim(keys_ipt.val());tempKey===_key||_key||"0"==_key?tempKey!==_key&&_key&&(isSearching=!0,btn_search.removeClass("icon-magnifier").addClass("fa-times-circle"),btnSearch()):(set.loadDisabled=!1,that.settings.search.unwind=!1,that.treeObj.setLeafDepth(leafDepth),that.treeObj.setTree(that.treeObj.getSourceData()),tempKey=_key,isSearching=!1,btn_search.removeClass("fa-times-circle").addClass("icon-magnifier"))},100)}),keys_ipt.blur(function(){clearInterval(timer)}),btn_search.click(function(){set.loadDisabled=!1,isSearching=!1,tempKey="",keys_ipt.val(""),isSearching=!1,btn_search.removeClass("fa-times-circle").addClass("icon-magnifier"),btnSearch()}),that.keyHandler(keys_ipt,{key13:btnSearch,key38:handlerUp,key40:handlerDown}),btn_ok.click(function(e){var evt=e||window.event;evt.stopPropagation(),set.response.call(null,that.targets),mask.remove(),container.remove()}),oprCancal.click(function(e){var evt=e||window.event;evt.stopPropagation(),mask.remove(),container.remove()}),this.fixdata.length>0&&this.insertTag(this.fixdata,!0);var iMove},setNumber:function(){this.data_num.html($("#data_box").children("span").length)},keyHandler:function(dom,handleObj){dom=dom||window.document,$(dom).bind("keydown",function(e){var evt=e||window.event,keyCode=evt.keyCode;switch(keyCode){case 13:handleObj["key"+keyCode]();break;case 37:handleObj["key"+keyCode]();break;case 38:handleObj["key"+keyCode]();break;case 39:break;case 40:handleObj["key"+keyCode]()}})},insertTag:function(dt,isNeed){function makeTag(_dt,theme){var span=$('<span class="label-btn '+theme+'"></span>'),iEle=$('<i class="fa fa-times"></i>');_dt.name=_dt.name||"&nbsp;&nbsp;",span.html(_dt.name),span.append(iEle),dataBox.append(span),iEle.on("click",_dt,removeTag),iEle.data("id",_dt.id),that.tags.push(iEle),that.tagsId.push(_dt.id)}function removeTag(e){var evt=e||window.event,_dts=that.treeObj.tree.find("dt"),_len=_dts.length,_idx=-1;if(evt.stopPropagation(),that.isTrigger)for(var j=0;j<_len;j++)_dts.eq(j).data("info").id==e.data.id&&_dts.eq(j).trigger("click");_idx=that.tempId.indexOf(e.data.id),_idx!==-1&&that.tempId.splice(_idx,1),_idx=that.tagsId.indexOf(e.data.id),_idx!==-1&&(that.tags.splice(_idx,1),that.tagsId.splice(_idx,1)),_idx=-1,$(this).parent().remove(),that.removeTargets(e.data),that.isTrigger=!0,that.setNumber()}var that=this,dataBox=$("#data_box"),hasSubs=!1;if(dt&&dt.next&&dt.next().length>0&&(hasSubs=!0,dt=dt.data("info")),that.settings.unionSelect&&hasSubs&&isNeed)makeTag(dt,"btn-primary");else if(isNeed)if(dt.length>0)for(var i=0;i<dt.length;i++)makeTag(dt[i],"btn-info");else makeTag(dt,"btn-info");else for(var i=0;i<that.tags.length;i++)that.tags[i].data("id")==dt.id&&(that.isTrigger=!1,that.tags[i].trigger("click"))},removeTargets:function(target){var len=target.length,idx=-1;if(len)for(var i=0;i<len;i++)idx=this.targetsId.indexOf(target[i].id),idx!==-1&&(this.targets.splice(idx,1),this.targetsId.splice(idx,1));else idx=this.targetsId.indexOf(target.id),idx!==-1&&(this.targets.splice(idx,1),this.targetsId.splice(idx,1))},queryByKey:function(data,key,only,exclude,types,depth){function getArrVal(dt){if(dt.constructor===Array){if(!(dt.length>0))return;for(var len=dt.length,i=0;i<len;i++)if(dt[i].constructor===Object)getArrVal(dt[i]);else{if(depth&&depth.indexOf(dep)==-1)break;if((dt[i]+"").search(new RegExp(key,"ig"))!==-1){if(only)return void(value=dt[i]);value.push(dt[i])}}}else if(dt.constructor===Object){if(types)for(var len=types.length,i=0;i<len;i++){var type=types[i].split(".");if(1===type.length)var _dt=dt[type[0]];else if(2===type.length){if(dt[type[0]])var _dt=dt[type[0]][type[1]]}else if(dt[type[0]]&&dt[type[0]][type[1]])var _dt=dt[type[0]][type[1]][type[2]];if(_dt||"0"==_dt)if(_dt.constructor===Array)_dt.length>0&&(dep++,getArrVal(_dt),dep--);else{if(depth&&depth.indexOf(dep)==-1)break;if((_dt+"").search(new RegExp(key,"ig"))!==-1){if(only)return void(value=dt);value.push(dt)}}}var isExcluded=!1;for(var k in dt){if(exclude&&exclude.length>0)for(var i=0;i<exclude.length;i++)if(k===exclude[i]){isExcluded=!0;break}if(!isExcluded)if(dt[k].constructor===Array)dt[k].length>0&&(dep++,getArrVal(dt[k]),dep--);else if(dt[k].constructor===Object)getArrVal(dt[k]);else if(!types){if(depth&&depth.indexOf(dep)==-1)break;if((dt[k]+"").search(new RegExp(key,"ig"))!==-1){if(only)return void(value=dt);value.push(dt)}}}}else{if(depth&&depth.indexOf(dep)==-1)return;if((dt+"").search(new RegExp(key,"ig"))!==-1){if(only)return void(value=dt);value.push(dt)}}}var value=[],dep=0;return data?(getArrVal(data),value):null},deepCloneWithKey:function(obj,dt){function clone(obj){var isExist=!1,property={};if(obj.constructor===Object){for(var _obj={},len=dt.length,i=0;i<len;i++)dt[i].union===obj.id&&(isExist=!0);for(var k in obj){if(!obj[k]||obj[k].constructor!==Object&&obj[k].constructor!==Array)isExist&&(_obj[k]=obj[k]);else{var tempData=clone(obj[k]);$.isEmptyObject(tempData)||(_obj[k]=tempData)}property[k]=obj[k]}for(var i=0;i<len;i++)if(dt[i].union===obj.id){var sub=that.settings.datakey.sub;_obj[sub]?_obj[sub].push(dt[i]):(_obj[sub]=[],_obj[sub].push(dt[i]))}}else if(obj.constructor===Array)for(var _obj=[],len=obj.length,i=0;i<len;i++)if(!obj[i]||obj[i].constructor!==Array&&obj[i].constructor!==Object)_obj.push(obj[i]);else{var tempData=clone(obj[i]);$.isEmptyObject(tempData)||_obj.push(clone(obj[i]))}else var _obj=obj;if(!$.isEmptyObject(_obj)){for(var k in property)_obj.id=property.id,_obj.name=property.name;return _obj}}if(!obj||"object"!=typeof obj||!dt)return obj;var that=this;this.settings.datakey=this.dataKey;var _obj=clone(obj);return _obj},deepClone:function(obj){function clone(obj){if(obj.constructor===Object){var _obj={};for(var k in obj)!obj[k]||obj[k].constructor!==Object&&obj[k].constructor!==Array?_obj[k]=obj[k]:_obj[k]=clone(obj[k])}else if(obj.constructor===Array)for(var _obj=[],len=obj.length,i=0;i<len;i++)!obj[i]||obj[i].constructor!==Array&&obj[i].constructor!==Object?_obj.push(obj[i]):_obj.push(clone(obj[i]));else var _obj=obj;return _obj}return obj&&"object"==typeof obj?clone(obj):obj}},isCommonjs?module.exports=DataBox:window.DataBox=DataBox}(window);