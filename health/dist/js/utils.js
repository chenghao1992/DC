"use strict";app.factory("utils",["$rootScope","$http","$compile",function($rootScope,$http,$compile){return HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(callback,type,quality){for(var binStr=atob(this.toDataURL(type,quality).split(",")[1]),len=binStr.length,arr=new Uint8Array(len),i=0;i<len;i++)arr[i]=binStr.charCodeAt(i);callback(new Blob([arr],{type:type||"image/png"}))}}),{getData:function(u,d,m,h){var args=arguments;$http({url:u,data:"function"!=typeof d?d||{}:{},method:"function"!=typeof m?m||"POST":"POST",headers:"function"!=typeof h?h||{}:{}}).then(function(dt){if(dt.data.dataList&&0!==dt.data.dataList.length||1==dt.data.code)for(var i=0;i<args.length;i++)"function"==typeof args[i]&&args[i].call(null,dt.data.dataList);else console.warn(dt.statusText)},function(x){console.error(x.statusText)})},getDataByKey:function(data,key,val){for(var len=data.length,i=0;i<len;i++)if(data[i][key]===val)return data[i]},getDataByVal:function(data,key,val){function getArrVal(dt){if(dt.constructor===Array&&dt.length>0)for(var len=dt.length,i=0;i<len;i++)getArrVal(dt[i]);else{for(var k in dt)dt[k].constructor===Array&&dt[k].length>0&&getArrVal(dt[k]);dt[key]===val&&value.push(dt)}}var value=[];return data?(getArrVal(data),value):null},localData:function(key,val){if(!window.localStorage)return!1;if(val||"0"==val)return localStorage.setItem(key,val),!0;if(null!==val){var dt=localStorage.getItem(key);return dt?dt:null}localStorage.removeItem(key)},queryByKey:function(data,key,only,exclude,types,depth){function getArrVal(dt){if(dt.constructor===Array){if(!(dt.length>0))return;for(var len=dt.length,i=0;i<len&&(dt[i]||"0"==dt[i]||""==dt[i]);i++)if(dt[i].constructor===Object)getArrVal(dt[i]);else{if(depth&&depth.indexOf(dep)==-1)break;if((dt[i]+"").search(new RegExp(exp_str,"ig"))!==-1){if(only)return void(value=dt[i]);value.push(dt[i])}}}else if(dt.constructor===Object){if(types)for(var len=types.length,i=0;i<len;i++){var type=types[i].split(".");if(1===type.length)var _dt=dt[type[0]];else if(2===type.length){if(dt[type[0]])var _dt=dt[type[0]][type[1]]}else if(dt[type[0]]&&dt[type[0]][type[1]])var _dt=dt[type[0]][type[1]][type[2]];if(_dt||"0"==_dt)if(_dt.constructor===Array)_dt.length>0&&(dep++,getArrVal(_dt),dep--);else{if(depth&&depth.indexOf(dep)==-1)break;if((_dt+"").search(new RegExp(exp_str,"ig"))!==-1){if(only)return void(value=dt);value.push(dt)}}}var isExcluded=!1;for(var k in dt){if(!dt[k]&&"0"!=dt[k]&&""!=dt[k])break;if(exclude&&exclude.length>0)for(var i=0;i<exclude.length;i++)if(k===exclude[i]){isExcluded=!0;break}if(!isExcluded)if(dt[k].constructor===Array)dt[k].length>0&&(dep++,getArrVal(dt[k]),dep--);else if(dt[k].constructor===Object)getArrVal(dt[k]);else if(!types){if(depth&&depth.indexOf(dep)==-1)break;if((dt[k]+"").search(new RegExp(exp_str,"ig"))!==-1){if(only)return void(value=dt);value.push(dt)}}}}else{if(depth&&depth.indexOf(dep)==-1)return;if((dt+"").search(new RegExp(exp_str,"ig"))!==-1){if(only)return void(value=dt);value.push(dt)}}}var value=[],dep=0,exp_str="",keys=(key+"").replace(/\\+/,"\\\\").split(/\s+/g),lng=keys.length;if(!data)return null;for(var i=0;i<lng;i++)exp_str+=i!=lng-1?keys[i]+".*":keys[i];return getArrVal(data),value},serialize:function(dt){function toSerializedString(obj,name,idx){if(obj.constructor===Object)for(var key in obj)obj[key]&&obj[key].constructor!==Object&&obj[key].constructor!==Array?str+="&"+((name||"0"==name?name:"")+(idx||"0"==idx?"["+idx+"].":"")+key+"="+obj[key]):obj[key]&&obj[key].constructor===Object?toSerializedString(obj[key]):obj[key]||null!==obj[key]?toSerializedString(obj[key],key):str+="&"+((key||"0"==key?key:"")+"="+obj[key]);else{if(obj.constructor!==Array)return dt;for(var len=obj.length,i=0;i<len;i++)obj[i]&&obj[i].constructor!==Object&&obj[i].constructor!==Array?str+="&"+((name?name:"")+"["+i+"]="+obj[i]):obj[i]&&obj[i].constructor===Object?toSerializedString(obj[i],name?name:"",i):toSerializedString(obj[i])}}var str="";return toSerializedString(dt),str.slice(1)},extendHash:function(dt,keys,val){if(dt||(dt={}),dt.constructor===Array&&dt.length>0)for(var len=dt.length,i=0;i<len;i++)for(var l=keys.length,n=0;n<l;n++)dt[i][keys[n]]||(dt[i][keys[n]]="");else for(var len=keys.length,i=0;i<len;i++)dt[keys[i]]||"0"==dt[keys[i]]||"null"==dt[keys[i]]||(dt[keys[i]]=val&&val[i]?val[i]:[])},dateFormat:function(date,format){format=format||"yyyy-MM-dd hh:mm:ss";var _date;if(date=date.constructor===Date?date:"Invalid Date"!=(_date=new Date(date))?_date:"string"==typeof date?new Date(date.replace(/-/g,"/")):"Invalid Date","Invalid Date"===date)return"";var segments={"y+":date.getFullYear(),"M+":date.getMonth()+1,"d+":date.getDate(),"h+":date.getHours(),"m+":date.getMinutes(),"s+":date.getSeconds(),"S+":date.getMilliseconds()};for(var k in segments){var exp=new RegExp(k),len=(segments[k]+"").length;if(exp.exec(format)){var segLen=exp.exec(format)[0].length;len<segLen&&(segments[k]="0"+segments[k],len=segments[k].length),format=format.replace(exp,(segments[k]+"").substring(len-segLen))}}return format},keyHandler:function(dom,handleObj){dom=dom||window.document,$(dom).bind("keydown",function(e){var evt=e||window.event,keyCode=evt.keyCode,fun=handleObj["key"+keyCode];switch(keyCode){case 13:evt.preventDefault(),fun&&fun(evt);break;case 37:fun&&fun(evt);break;case 38:fun&&fun(evt);break;case 39:fun&&fun(evt);break;case 40:fun&&fun(evt)}})},deepClone:function(obj){function clone(obj){if(obj.constructor===Object){var _obj={};for(var k in obj)!obj[k]||obj[k].constructor!==Object&&obj[k].constructor!==Array?_obj[k]=obj[k]:_obj[k]=clone(obj[k])}else if(obj.constructor===Array)for(var _obj=[],len=obj.length,i=0;i<len;i++)!obj[i]||obj[i].constructor!==Array&&obj[i].constructor!==Object?_obj.push(obj[i]):_obj.push(clone(obj[i]));else var _obj=obj;return _obj}return obj&&"object"==typeof obj?clone(obj):obj},unique:function(obj,idxs){if(!obj||obj.constructor!==Array)return obj;for(var dt={},arr=[],len=obj.length,i=0;i<len;i++)idxs&&idxs.constructor===Array&&dt["key_"+obj[i]]===obj[i]&&idxs.push(i),dt["key_"+obj[i]]=obj[i];for(var k in dt)arr.push(dt[k]);return arr},getBinLength:function(str){if(!str||!str.length)return 0;for(var idx,l=str.length,lng=0,i=0;i<l;i++)idx=str.charCodeAt(i),idx>=19968&&idx<=40869?lng+=2:lng++;return lng},searchSuggest:function(ipt,item,source,fun){function insertSelectItems(dt,key){var len=dt.length;ulEle.html("");for(var i=0;i<len;i++){var str=dt[i][item.name];if(key)for(var keys=key.split(/\s+/g),lng=keys.length,j=0;j<lng;j++)str=str.replace(new RegExp(keys[j],"ig"),"<span>"+keys[j]+"</span>");var li=$('<li data-id="'+dt[i][item.id]+'" data-name="'+dt[i][item.name]+'">'+str+"</li>");ulEle.append(li),li.off().click(function(e){isFocus=!1,fun&&fun({id:$(this).data("id"),name:$(this).data("name")}),ipt.val($(this).data("name")),ulEle.addClass("none")})}cur_item=ulEle.children().first().addClass("cur-item")}function mUp(evt){var prev_item=cur_item.prev(),lis=ulEle.children(),ulHeight=ulEle.height(),sclTop=ulEle.scrollTop();evt.preventDefault(),prev_item.length>0&&(cur_item.removeClass("cur-item"),cur_item=prev_item.addClass("cur-item")),idx=lis.index(cur_item),30*idx<ulHeight*(n-1)&&sclTop>30*idx&&(sclHeight-=ulHeight,ulEle.scrollTop(sclHeight),n--)}function mDown(evt){var next_item=cur_item.next(),lis=ulEle.children(),ulHeight=ulEle.height();evt.preventDefault(),next_item.length>0&&(cur_item.removeClass("cur-item"),cur_item=next_item.addClass("cur-item")),idx=lis.index(cur_item),30*idx>=ulHeight*n&&(sclHeight+=ulHeight,ulEle.scrollTop(sclHeight),n++)}function confirm(){idx=0,n=1,sclHeight=0,isFocus=!1,fun&&fun({id:cur_item.data("id"),name:cur_item.data("name")}),ipt.val(cur_item.data("name")),ipt.trigger("blur")}var ulEle=$("<ul></ul>").addClass("bank-name-list none"),isFocus=!1,idx=0,n=1,sclHeight=0,cur_item=$(),dt=null;"object"==typeof source&&(dt=source),ulEle.insertAfter(ipt),this.keyHandler(ipt,{key13:confirm,key38:mUp,key40:mDown});var timer,tempKey,sourceData=[];ipt.on("focus",function(){timer=setInterval(function(){var _key=$.trim(ipt.val());if(/\S/.test(_key)){var len=0;if(tempKey===_key)ulEle.removeClass("none");else{var data;"object"==typeof source?(data=this.queryByKey(dt,_key,!1,!1,[item.name]),sourceData=data,len=data.length,len>0&&ulEle.removeClass("none"),insertSelectItems(data,_key)):source(_key,function(dt){data=dt,sourceData=data,len=data.length,len>0&&ulEle.removeClass("none"),insertSelectItems(data,_key)})}tempKey=_key}else{var len=sourceData.length;tempKey===_key?len>0&&ulEle.removeClass("none"):(len>0&&ulEle.removeClass("none"),"object"==typeof source?insertSelectItems(sourceData,_key):source(_key,function(dt){var data=dt;sourceData=dt,len=data.length,len>0&&ulEle.removeClass("none"),insertSelectItems(data,_key)})),tempKey=_key}},60)}),ipt.on("blur",function(){clearInterval(timer),isFocus||setTimeout(function(){ulEle.addClass("none")},100)}),ulEle.on("mousedown",function(){isFocus=!0}),ulEle.on("mouseup",function(){isFocus=!1})},setCookie:function(name,value){var argv=arguments,argc=arguments.length,expires=argc>2?argv[2]:null;if(null!=expires){var LargeExpDate=new Date;LargeExpDate.setTime(LargeExpDate.getTime()+1e3*expires*3600*24)}document.cookie=name+"="+escape(value)+(null==expires?"":"; expires="+LargeExpDate.toGMTString())},getCookie:function(Name){var search=Name+"=";if(document.cookie.length>0){var offset=document.cookie.indexOf(search);if(offset!=-1){offset+=search.length;var end=document.cookie.indexOf(";",offset);return end==-1&&(end=document.cookie.length),unescape(document.cookie.substring(offset,end))}return""}},deleteCookie:function(name){var expdate=new Date;expdate.setTime(expdate.getTime()-864e5),this.setCookie(name,"",expdate)},fileCompressToImg:function(source_file_obj,quality,callback){var reader=new FileReader;reader.onload=function(e){var imgObj=new Image;imgObj.src=e.target.result,imgObj.onload=function(){var cvs=document.createElement("canvas");cvs.width=imgObj.naturalWidth,cvs.height=imgObj.naturalHeight;cvs.getContext("2d").drawImage(imgObj,0,0);console.log("image quality is"+quality);var newImageData=cvs.toDataURL("image/jpeg",quality),result_image_obj=new Image;result_image_obj.src=newImageData,callback(result_image_obj)}},reader.readAsDataURL(source_file_obj)},fileCompressToBlob:function(source_file_obj,quality,max_size,callback){var that=this,reader=new FileReader;source_file_obj.size<max_size||quality<.1?reader.onload=function(e){var imgObj=new Image;imgObj.src=e.target.result,imgObj.onload=function(){var cvs=document.createElement("canvas");cvs.width=imgObj.naturalWidth,cvs.height=imgObj.naturalHeight;cvs.getContext("2d").drawImage(imgObj,0,0);cvs.toBlob(function(blob){console.log("quality is:"+quality),console.log("blob size is"+blob.size),callback(blob)},"image/jpeg",quality)}}:(quality=(quality-.1).toFixed(2),reader.onload=function(e){var imgObj=new Image;imgObj.src=e.target.result,imgObj.onload=function(){var cvs=document.createElement("canvas");cvs.width=imgObj.naturalWidth,cvs.height=imgObj.naturalHeight;cvs.getContext("2d").drawImage(imgObj,0,0);cvs.toBlob(function(blob){console.log("quality is:"+quality),console.log("blob size is"+blob.size),blob.size<max_size?callback(blob):(console.log(that),that.fileCompressToBlob(source_file_obj,quality,max_size,callback))},"image/jpeg",quality)}}),reader.readAsDataURL(source_file_obj)}}}]),Date.prototype.format=function(format){format||(format="yyyy-MM-dd");var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(format)&&(format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var k in o)new RegExp("("+k+")").test(format)&&(format=format.replace(RegExp.$1,1==RegExp.$1.length?o[k]:("00"+o[k]).substr((""+o[k]).length)));return format};