"use strict";angular.module("app").controller("AppCtrl",["$rootScope","$scope","$translate","$localStorage","$window","$http","$state","$cookieStore","utils","Group","modal",function($rootScope,$scope,$translate,$localStorage,$window,$http,$state,$cookieStore,utils,Group,modal){function isSmartDevice($window){var ua=$window.navigator.userAgent||$window.navigator.vendor||$window.opera;return/iPhone|iPod|iPad|Silk|Android|BlackBerry|Opera Mini|IEMobile/.test(ua)}var isIE=!!navigator.userAgent.match(/MSIE/i);isIE&&angular.element($window.document.body).addClass("ie"),isSmartDevice($window)&&angular.element($window.document.body).addClass("smart"),app.state=$state,$scope.app={name:"玄关健康平台",version:"1.0.0",color:{primary:"#7266ba",info:"#23b7e5",success:"#27c24c",warning:"#fad733",danger:"#f05050",light:"#e8eff0",dark:"#3a3f51",black:"#1c2b36"},settings:{themeID:8,navbarHeaderColor:"bg-black",navbarCollapseColor:"bg-white-only",asideColor:"bg-black",headerFixed:!0,asideFixed:!1,asideFolded:!1,asideDock:!1,container:!1}},$rootScope.rootGroup={id:localStorage.getItem("curGroupId"),name:localStorage.getItem("curGroupName"),enterpriseName:localStorage.getItem("curGroupEnterpriseName")},$rootScope.rootEnterprise=null,$rootScope.enterprise_userName=null,angular.isDefined($localStorage.settings)?$scope.app.settings=$localStorage.settings:$localStorage.settings=$scope.app.settings,$scope.$watch("app.settings",function(){$scope.app.settings.asideDock&&$scope.app.settings.asideFixed&&($scope.app.settings.headerFixed=!0),$localStorage.settings=$scope.app.settings},!0),$scope.lang={isopen:!1},$scope.langs={zh_CN:"中文（简体）"},$scope.userType={type_1:"患者",type_2:"医助",type_3:"医生",type_4:"客服"},$scope.datas={user_id:utils.localData("user_id"),user_name:utils.localData("user_name")||" ",user_type:utils.localData("user_type")||" ",user_headPicFile:utils.localData("headPicFile")||null,groupPicFile:utils.localData("groupPicFile")+""!="null"?utils.localData("groupPicFile")+"?"+(new Date).getTime():null},$scope.groupList=[],$scope.selectLang=$scope.langs[$translate.proposedLanguage()]||"中文（简体）",$scope.setLang=function(langKey,$event){$scope.selectLang=$scope.langs[langKey],$translate.use(langKey),$scope.lang.isopen=!$scope.lang.isopen},$scope.selectLang=$scope.langs.zh_CN,$translate.use("zh_CN"),$scope.app.ui={};$scope.app.ui.init=function(){$http.get("src/api/nav_items").then(function(resp){resp.data.datalist&&($scope.app.ui.items=resp.data.datalist)})};$scope.logout=function(){$http.get(app.url.logout+"?"+$.param({access_token:app.url.access_token})).then(function(response){"OK"===response.statusText?($cookieStore.remove("username"),$cookieStore.remove("enterprisename"),utils.localData("headPicFile",null),utils.localData("groupPicFile",null),utils.localData("curGroupId",null),utils.localData("curGroupName",null),utils.localData("curGroupEnterpriseName",null),utils.localData("company",null),$rootScope.rootGroup.enterpriseName=null,$rootScope.rootGroup.name=null,$rootScope.curDepartmentId=null,$scope.datas.groupPicFile=null,$rootScope.rootGroup.id=null,$rootScope.rootGroup.name=null,$rootScope.rootGroup.enterpriseName=null,$rootScope.rootEnterprise=null,$rootScope.enterprise_userName=null,$rootScope.isCompany?$state.go("access.enterprise_signin",{reload:!0}):$state.go("access.signin",{reload:!0})):console.log("Logout: "+response.statusText)},function(x){console.log("Logout: "+x.statusText)})},$rootScope.verifyByGuser=function(gid,doctorId){$scope.ajaxInfo=null,$http.post(app.url.yiliao.verifyByGuser,{access_token:localStorage.getItem("access_token"),doctorId:doctorId,groupId:gid}).success(function(resp){if(1!=resp.resultCode)return void($rootScope.loginError=resp.resultMsg);if($scope.user={},$scope.group={},!resp.data.group)return $scope.un_reg=!0,$scope.un_check=!1,$scope.step_apply=!1,$scope.step_check=!1,$scope.step_active=!1,$scope.step_status=!0,$scope.user.isInGroup=!1,$scope.user.isAdmin=!1,$rootScope.isSysAdmin=!1,Group.init(null),void $state.go("app.invite_list",null,{reload:!0});if("4"==resp.data.userStatus)return void modal.toast.warn('您的账号<span class="text-danger-dker">未通过审核</span>，只能登录身份为<span class="text-success-dker">管理员</span>的集团',7e3);var dt={id:resp.data.group.id,name:resp.data.group.name,creatorName:resp.data.group.creatorName,logo:resp.data.group.logoUrl,active:resp.data.group.active,applyStatus:resp.data.group.applyStatus,certStatus:resp.data.group.certStatus,creator:resp.data.group.creator,createDate:resp.data.group.creatorDate,introduction:resp.data.group.introduction,updator:resp.data.group.updator,updateDate:resp.data.group.updatorDate,cureNum:resp.data.group.cureNum,companyId:resp.data.group.companyId,groupCert:resp.data.group.groupCert,config:resp.data.group.config,groupUser:resp.data.groupUser,userStatus:resp.data.userStatus,skip:resp.data.group.skip};Group.init(dt),resp.data.groupUser&&resp.data.groupUser.rootAdmin&&"root"===resp.data.groupUser.rootAdmin&&Group.set("user.admin","root"),$scope.datas.user_headPicFile&&Group.set("user.headPic",$scope.datas.user_headPicFile),$scope.has_more_group&&Group.set("user.hasMoreGroup",!0),Group.handle(dt.id,function(group){switch(resp.data.group&&(utils.localData("curGroupId",group.id),utils.localData("curGroupName",group.name),utils.localData("group_creator",group.creator),$rootScope.rootGroup.name=localStorage.getItem("curGroupName"),group.company?(utils.localData("curGroupEnterpriseName",group.company.name),$rootScope.rootGroup.enterpriseName=localStorage.getItem("curGroupEnterpriseName")):$rootScope.rootGroup.enterpriseName=null),$rootScope.roleX=!0,utils.localData("roleX","true"),group.user.status){case"1":$state.go("app.invite_list",null,{reload:!0});break;case"2":group.status.active||"active"===group.status.active?$state.go("app.invite_list",null,{reload:!0}):"P"!==group.status.applyStatus&&"NR"!==group.status.applyStatus&&$scope.user.isAdmin?$state.go("app.group_create",null,{reload:!0}):$state.go("app.invite_list",null,{reload:!0});break;case"3":group.status.active&&"active"!==group.status.active?"P"===group.status.applyStatus?$state.go("app.contacts",null,{reload:!0}):"NR"===group.status.applyStatus?$state.go("app.invite_list",null,{reload:!0}):$state.go("app.group_create",null,{reload:!0}):"S"===group.isBlocked?$state.go("app.groupSettings",null,{reload:!0}):$state.go("app.contacts",null,{reload:!0})}})}).error(function(data){utils.localData("user_name",null),utils.localData("user_type",null),utils.localData("user_id",null),$scope.ajaxInfo=data.resultMsg})},$scope.switch_user=function(){$rootScope.roleX?($rootScope.roleX=!1,utils.localData("roleX","false"),$state.go("app.invite_list",null,{reload:!0})):($rootScope.roleX=!0,utils.localData("roleX","true"),$rootScope.un_check?$state.go("app.invite_list",null,{reload:!0}):$state.go("app.contacts",null,{reload:!0}))},$scope.createGroup=function(){utils.localData("user_id");utils.localData("applyStatus","NR"),$state.go("app.group_create")},window.onfocus=function(){app.url.access_token!==utils.localData("access_token")&&window.location.reload()}}]),angular.module("app").controller("GuoupSearch",["$rootScope","$scope","$http","$state","utils",function($rootScope,$scope,$http,$state,utils){var keyIpt=$("#key_ipt"),timer=0,tmpKey="not empty!!!!!!!!!!";keyIpt.focus(function(){var curLine=$(".cur-line"),curBkLine=$(".cur-back-line");timer=setInterval(function(){var val=$.trim(keyIpt.val());tmpKey!==val&&/\S+/.test(val)?(0===curBkLine.length&&(curLine=$(".cur-line"),curBkLine=$(".cur-back-line")),curLine.removeClass("cur-line"),curBkLine.removeClass("cur-back-line"),$rootScope.keyword=tmpKey=val,$rootScope.isSearch=!0,utils.localData("tmpKey",tmpKey),$state.go("app.contacts.list",{id:tmpKey},{reload:!1})):val||"0"==val||(curLine.addClass("cur-line"),curBkLine.addClass("cur-back-line"),tmpKey="not empty!!!!!!!!!!",$rootScope.isSearch=!1,$state.go("app.contacts.list",{id:$rootScope.curDepartmentId},{reload:!1}),$("#"+utils.localData("curLiId")).removeClass("nav-cur-item").parent().parent().parent().removeClass("active"),$("#id_0").addClass("nav-cur-item").parent().parent().parent().addClass("active"),utils.localData("curLiId","id_0"))},100)}),keyIpt.blur(function(){clearInterval(timer)})}]),angular.module("app").controller("GroupSwitch",["$rootScope","$scope","$http","$state","utils",function($rootScope,$scope,$http,$state,utils){var groupId=($("#key_ipt"),""),curGroupId=utils.localData("curGroupId"),userId=utils.localData("user_id"),groupList=utils.localData("groupList");groupList&&(groupList=window.eval(groupList),$scope.groupList=groupList||$rootScope.groupList),$scope.changed=function(e){e||window.event;curGroupId=utils.localData("curGroupId"),groupId=$(this)[0].group.id,$scope["switch"](),$rootScope.curDepartmentId=null},$scope["switch"]=function(){if(groupId!=curGroupId&&(groupId&&userId||groupId&&"0"==userId||"0"==groupId&&userId)){for(var listStr="[",i=0;i<groupList.length;i++)listStr+='{name:"'+groupList[i].name+'",id:"'+groupList[i].id+'",orgType:"'+(groupList[i].orgType||"")+'"',listStr+=groupList[i].id===curGroupId?",isCurGroup:false}":groupList[i].id===groupId?",isCurGroup:true}":",isCurGroup:false}",i<groupList.length-1&&(listStr+=",");listStr+="]",utils.localData("groupList",listStr),$scope.verifyByGuser(groupId,userId)}}}]);