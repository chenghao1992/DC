"use strict";!function(){function funDynamicSendMsgCtrl($scope,$http,$state,toaster,$stateParams,$modal){var curGroupId=localStorage.getItem("curGroupId"),curPid=$stateParams.id;localStorage.setItem("curPid",curPid),$scope.isSend=!1;var um=null;$scope.token=app.url.access_token,$scope.$on("$destroy",function(){um.destroy()}),$scope.addGroupDynamicForWeb=function(){var html=um.getContent();return $scope.title?$scope.fontImgUrl?html?void $http.post(app.url.dynamic.addGroupDynamicForWeb,{access_token:app.url.access_token,title:$scope.title||"",groupId:curGroupId||"",contentUrl:$scope.fontImgUrl||"",content:html||""}).success(function(data){1==data.resultCode?($scope.isSend=!0,toaster.pop("success","","发送成功,3秒钟后返回历史消息列表"),setTimeout(function(){$state.go("app.dynamic.edit.msgHistory",{},{reload:!0})},3e3)):toaster.pop("error",null,data.resultMsg)}).error(function(data){toaster.pop("error",null,data.resultMsg)}):void toaster.pop("info",null,"请填写正文"):void toaster.pop("info",null,"请上传题图"):void toaster.pop("info",null,"请填写标题")},$scope.selectFile=function(){$scope.upload()},$scope.token=app.url.access_token,$scope.uploaderAdded=function(up,files){$scope.uploadPercent=0},$scope.uploaderSuccess=function(up,file,info){$scope.fontImgUrl=file.url,$scope.copy_small=file.url+"?imageView2/3/w/200/h/200",$scope.uploadPercent=100,toaster.pop("success",null,"封面修改成功！")},$scope.uploaderError=function(up,err,errTip){toaster.pop("error",null,"题图大于2M，请重新上传"),"-600"==err.code?toaster.pop("error",null,"题图大于2M，请重新上传"):toaster.pop("error",null,errTip)},$scope.fileUploadProcess=function(up,file){$scope.uploadPercent=100==file.percent?99:file.percent},function(){$http({url:serverApiRoot+"vpanfile/getUploadToken",method:"post",data:{access_token:app.url.access_token,bucket:"resource"}}).then(function(response){var rep=response.data;rep&&1==rep.resultCode&&rep.data&&rep.data.token&&rep.data.domain?um=UM.getEditor("myEditor",{initialFrameWidth:"100%",initialFrameHeight:300,qiniuToken:rep.data.token,qiniuDomain:rep.data.domain}):console.error(rep)})}(),$scope.toPreview=function(){if(!$scope.title)return void toaster.pop("warn","","请填写标题");if(!$scope.fontImgUrl)return void toaster.pop("warn","","请上传题图");var html=um.getContent();if(!html)return void toaster.pop("info",null,"请填写正文");var articlePreview=(um.getContentTxt().slice(0,100),{title:$scope.title,fontImgUrl:$scope.fontImgUrl,content:html});$modal.open({templateUrl:"previewModalContent.html",controller:"previewModalInstanceCtrl",windowClass:"docPreModal",resolve:{article:function(){return articlePreview}}})}}angular.module("app").controller("dynamicSendMsgCtrl",funDynamicSendMsgCtrl),funDynamicSendMsgCtrl.$inject=["$scope","$http","$state","toaster","$stateParams","$modal"]}(),app.controller("previewModalInstanceCtrl",function($scope,$modalInstance,article,$sce){$scope.article=article,$scope.article.content=$sce.trustAsHtml($scope.article.content),$scope.cancel=function(){$modalInstance.dismiss("cancel")}});