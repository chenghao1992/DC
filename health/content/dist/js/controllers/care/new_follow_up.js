"use strict";app.controller("NewFollowUpCtrl",function($rootScope,$scope,$state,$http,$stateParams,$compile,utils,$modal,toaster){function getDisease(){var modalInstance=$modal.open({animation:!0,templateUrl:"NewFollowUp_DiseaseSelected.html",controller:"NewFollowUp_DiseaseSelected",size:"md"});modalInstance.result.then(function(disease){$scope.lists.diseaseLable=disease.diseaseLable,$scope.lists.diseaseLableName=disease.diseaseLableName})}function isRepeat(array,item){if(0===array.length)return!1;for(var i=array.length-1;i>=0;i--)if(array[i].itemId==item.itemId&&array[i].type==item.type)return!0;return!1}if($stateParams.planId)$http.post(app.url.care.findFollowUpTemplate,{access_token:app.url.access_token,groupId:app.url.groupId(),tmplateId:$stateParams.planId}).then(function(rpn){console.log(rpn.data),1===rpn.data.resultCode?$scope.lists=rpn.data.data:toaster.pop("error",null,rpn.data.resultMsg)});else{var defaultData={name:"",diseaseLable:"",diseaseLableName:"",description:"",groupId:app.url.groupId(),followUpDays:[{dayNum:1,followUpDayDetails:[]}]};$scope.lists=defaultData}$scope.addDay=function(){return $scope.lists.followUpDays[$scope.lists.followUpDays.length-1].dayNum||0==$scope.lists.followUpDays[$scope.lists.followUpDays.length-1].dayNum?$scope.lists.followUpDays[$scope.lists.followUpDays.length-1].name?void $scope.lists.followUpDays.push({followUpDayDetails:[]}):void toaster.pop("error",null,"请填写每日的日程主题"):toaster.pop("error",null,"请选择时间")},$scope.removeFollowUpDay=function(index){$scope.lists.followUpDays.splice(index,1)},$scope.save=function(){if($stateParams.planId)var sucessMsg="修改成功";else var sucessMsg="添加成功";if(""==$scope.lists.name)return toaster.pop("error",null,"请输入随访计划名称");if(""==$scope.lists.diseaseLable)return toaster.pop("error",null,"请选择随访标签");if(!$scope.lists.followUpDays[$scope.lists.followUpDays.length-1].dayNum&&0!=$scope.lists.followUpDays[$scope.lists.followUpDays.length-1].dayNum)return toaster.pop("error",null,"请选择时间间隔");if(!$scope.lists.followUpDays[$scope.lists.followUpDays.length-1].name)return toaster.pop("error",null,"请填写每日的日程主题");if(""==$scope.lists.description)return toaster.pop("error",null,"请输入随访计划简介");var json=JSON.stringify($scope.lists);console.log($scope.lists),$http.post(app.url.care.addFollowUpTemplate,{access_token:app.url.access_token,data:json}).then(function(rpn){1===rpn.data.resultCode?(toaster.pop("error",null,sucessMsg),$state.go("app.follow_up_table")):toaster.pop("error",null,rpn.data.resultMsg)})},$scope.chooseDisease=function(){return $stateParams.planId?toaster.pop("error",null,"不能更改病种"):void getDisease()},$scope.textEditor=function(index){var modalInstance=$modal.open({animation:!0,templateUrl:"NewFollowUp_TextDialog.html",controller:"NewFollowUp_TextDialogCtrl",size:"md"});modalInstance.result.then(function(text){var result={followUpDayDetails:{itemId:text,type:7,name:text}};$scope.lists.followUpDays[index].followUpDayDetails.push(result.followUpDayDetails)})},$scope.timeEditor=function(index,timePoint,prevTime){var modalInstance=$modal.open({animation:!0,templateUrl:"NewFollowUp_TimeDialog.html",controller:"NewFollowUp_TimeDialogCtrl",size:"md",resolve:{data:function(){var data={timePoint:timePoint,prevTime:prevTime};return data}}});modalInstance.result.then(function(timePoint){$scope.lists.followUpDays[index].dayNum=timePoint})},$scope.addList=function(type,index){var modalInstance=$modal.open({animation:!0,templateUrl:"NewFollowUp_AddList.html",controller:"NewFollowUp_AddListCtrl",size:"lg",resolve:{data:function(){var data={type:type};return data}}});modalInstance.result.then(function(result){if(isRepeat($scope.lists.followUpDays[index].followUpDayDetails,result.followUpDayDetails)){if(3==type)var msg="该生活量表已添加";else if(5==type)var msg="该调查表已添加";return toaster.pop("error",null,msg)}$scope.lists.followUpDays[index].followUpDayDetails.push(result.followUpDayDetails)})},$scope.removeList=function(index,item){var itemIndex=$scope.lists.followUpDays[index].followUpDayDetails.indexOf(item);$scope.lists.followUpDays[index].followUpDayDetails.splice(itemIndex,1)},$scope.addFromPlatform=function(index){var modalInstance=$modal.open({templateUrl:"docModalContent.html",controller:"NewFollowUp_docModalInstanceCtrl",windowClass:"docModal doc"});modalInstance.result.then(function(result){return isRepeat($scope.lists.followUpDays[index].followUpDayDetails,result.followUpDayDetails)?toaster.pop("error",null,"该文章已经添加"):void $scope.lists.followUpDays[index].followUpDayDetails.push(result.followUpDayDetails)})}}),app.controller("NewFollowUp_TextDialogCtrl",function($scope,$modalInstance,toaster){$scope.confirm=function(){return $scope.text?void $modalInstance.close($scope.text):toaster.pop("error",null,"请输入提醒内容")},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),app.controller("NewFollowUp_TimeDialogCtrl",function($scope,$modalInstance,toaster,data){$scope.timePoint=data.timePoint,$scope.prevTime=data.prevTime,$scope.timePoint||($scope.timePoint=$scope.prevTime+1),$scope.confirm=function(){$modalInstance.close($scope.timePoint)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),app.controller("NewFollowUp_DiseaseSelected",function($rootScope,$scope,$modalInstance,$http,utils,toaster){function setTree(argument){function select(info){console.log(info),disease.diseaseLable=info.id,disease.diseaseLableName=info.name}new Tree("sch_cnt_list",{hasCheck:!1,allCheck:!1,multiple:!1,allHaveArr:!1,self:!0,search:!1,arrType:[0,0],data:{url:app.url.yiliao.getTypeByParent,param:{access_token:app.url.access_token,parentId:null}},datakey:{id:"id",name:"name",sub:"children"},info:{name:"name",id:"id",pid:"department",leaf:"leaf"},events:{click:select},callback:function(){}})}var disease={diseaseLableName:"",diseaseLable:""};$scope.add=function(){$modalInstance.close(disease)},setTimeout(setTree,0),$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),app.controller("NewFollowUp_AddListCtrl",function($rootScope,$scope,$modalInstance,$state,$http,toaster,data){function setTree(argument){function setTable(info){function dataTable(data){datable&&datable.fnClearTable(),datable=$("#listDatable").dataTable({language:app.lang.datatables.translation,ordering:!1,searching:!1,bDestroy:!0,lengthMenu:[10,15,20,30,40,50,100],bLengthChange:!1,data:data,columns:[{data:null,title:"编号",createdCell:function(nTd,sData,oData,iRow,iCol){var startnum=this.api().page()*this.api().page.info().length;$(nTd).html(iRow+1+startnum)}},{data:"ghnrContent"},{data:null,defaultContent:"<button class='btn btn-primary text-xs btn-xs'>添加</button>"}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","button",function(){addFollow(aData)})}})}function addFollow(data){var result={followUpDayDetails:{itemId:data.ghnrId,type:type,name:data.ghnrContent}};$modalInstance.close(result)}$scope.diseaseNameSelected=info.name,info.name&&$http.post(app.yiliao+"pack/care/queryCareTemplateItem",{access_token:app.url.access_token,categoryId:info.id,type:type}).then(function(rpn){1===rpn.data.resultCode?dataTable(rpn.data.data):toaster.pop("error",null,rpn.data.resultMsg)})}var contacts=new Tree("sch_list",{hasCheck:!1,allCheck:!1,multiple:!1,allHaveArr:!1,self:!0,search:!1,arrType:[0,0],data:{url:app.yiliao+"group/stat/getDiseaseTypeTree",param:{access_token:app.url.access_token,groupId:app.url.groupId(),tmpType:type}},datakey:{id:"id",name:"name",sub:"children"},info:{name:"name",id:"id",pid:"department",leaf:"leaf"},events:{click:setTable},callback:function(){var dts=contacts.tree.find("dt");setTable(dts.eq(0).data().info)}}),datable=null;setTable({})}var type=data.type;3===type?$scope.viewName="添加生活量表":5===type&&($scope.viewName="添加调查表"),setTimeout(setTree,0),$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),app.controller("NewFollowUp_docModalInstanceCtrl",function($scope,$modalInstance,toaster,$http,utils){function clone(myObj){var newObj={};if(newObj.label=myObj.name+"("+myObj.count+")",newObj.id=myObj.diseaseId,void 0!=myObj.children){newObj.children=[];for(var i in myObj.children)newObj.children[i]=clone(myObj.children[i])}return newObj}function initPlatDocTable(){var index=1,length=5,start=0,size=5,setTable=function(){platArticleTable=$("#doc_list").DataTable({language:app.lang.datatables.translation,searching:!1,sScrollX:"100%",sScrollXInner:"110%",destroy:!0,lengthChange:!0,ordering:!0,draw:index,pageLength:length,lengthMenu:[5,10,20,50],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:allDocUrl,fnServerData:function(sSource,aoData,fnCallback){$.ajax({type:"post",url:sSource,dataType:"json",data:allDocParam,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else console.log(resp.resultMsg)}})},columns:[{data:"author",render:function(set,status,dt){var keywordsStr="";dt.tag&&dt.tag.length>0?(keywordsStr+="关键字：",dt.tag.forEach(function(item,index,array){item&&(keywordsStr+=item.name+"；")})):keywordsStr+="&nbsp;";var groupNameStr=dt.groupName?"@"+dt.groupName+" ":"",doctorTitle=dt.doctor?dt.doctor.title:"",doctorHos=dt.doctor?"|"+dt.doctor.hospital:"",authorName=dt.authorName?dt.authorName:"",photoPath="src/img/nophoto.jpg";return dt.copyPath&&""!=dt.copyPath&&(photoPath=dt.copyPath),"<img src="+photoPath+' alt="..." style="width:60px;height:60px;margin-right:10px;float:left;border-radius:0;"><span class="clear"><span>'+dt.title+'</span><small class="text-muted clear text-ellipsis">'+keywordsStr.substring(0,30)+'</small><small class="text-muted clear text-ellipsis">作者：'+authorName+groupNameStr+" "+doctorTitle+doctorHos+"</small></span>"},orderable:!1},{data:"useNum",orderable:!1,render:function(set,status,dt){return void 0==dt.useNum?0:dt.useNum}},{data:"visitCount",orderable:!1,render:function(set,status,dt){return void 0==dt.visitCount?0:dt.visitCount}},{render:function(set,status,dt){return utils.dateFormat(dt.lastUpdateTime,"yyyy-MM-dd")}},{render:function(set,status,dt){return"<button class='btn btn-primary text-xs btn-xs'>添加</button>"},orderable:!1}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","button",function(event){var result={followUpDayDetails:{itemId:aData.id,type:6,name:aData.title}};$modalInstance.close(result)})}}),platArticleTable.off("page.dt").on("page.dt",function(e,settings){index=platArticleTable.page.info().page+1,start=length*(index-1),allDocParam.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=1,start=0,allDocParam.pageIndex=1,allDocParam.pageSize=len})};setTable()}var platArticleTable,curGroupId=app.url.groupId();$scope.isCollapsed=!1,$scope.open=!1,$scope.showMore=!1;var currentTreeId;$scope.keywords=[],$scope.isTreeLoad=!1,$scope.mainKeyword=null;var preBranch,tree={};$scope.my_tree=tree={};var allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5};$scope.my_data=[];var getTreeData=function(){$http.post(app.url.document.findDiseaseTreeForArticle,{access_token:app.url.access_token,createType:1}).success(function(data,status,headers,config){if(1==data.resultCode){var source={count:data.data.total,name:"全部文档",diseaseId:null};source.children=data.data.tree;var result=clone(source),eArray=new Array;eArray[0]=result,$scope.my_data=eArray,$scope.isTreeLoad=!0}else console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})};getTreeData(),$scope.my_tree_handler=function(branch){currentTreeId=branch.id,$scope.isTop=!1,0==branch.children.length?$http.post(app.url.document.getDisease,{parentId:branch.id}).success(function(data,status,headers,config){1==data.resultCode?($scope.keywords=data.data,$scope.keywords.length>0&&$scope.keywords.unshift({name:"不限",id:null})):alert(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)}):$scope.keywords=[],allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5,diseaseId:branch.id},initPlatDocTable()},$scope.mainKWLength=0,$scope.$watch("mainKeyword",function(newValue,oldValue){newValue!=oldValue&&($scope.mainKeyword?$scope.mainKWLength=$scope.mainKeyword.length:$scope.mainKWLength=0)}),$scope.$watch("keywords",function(newValue,oldValue){setTimeout(function(){var kw_c_height=$("#p_kw_content").height();kw_c_height<70?$scope.showMore=!1:$scope.showMore=!0,$scope.$apply("showMore")},0)}),$scope.sortByKeyword=function(keyword){"不限"==keyword.name?(allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5,diseaseId:currentTreeId}):(allDocUrl=app.url.document.findArticleByTag,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5,tags:keyword.id}),initPlatDocTable()},$scope.clearMainKW=function(){$scope.my_tree.select_branch(preBranch),$scope.mainKeyword=null},$scope.pressEnter=function($event){13==$event.keyCode&&$scope.findDocByKeyWord()},$scope.findDocByKeyWord=function(){preBranch=$scope.my_tree.get_selected_branch(),$scope.my_tree.select_branch(),$scope.keywords=[],null==$scope.mainKeyword||0==$scope.mainKeyword.length?(allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5}):(allDocUrl=app.url.document.findArticleByKeyWord,allDocParam={title:$scope.mainKeyword,access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:5}),initPlatDocTable()},setTimeout(function(){initPlatDocTable()},200),$scope.cancel=function(){$modalInstance.dismiss("cancel")}});