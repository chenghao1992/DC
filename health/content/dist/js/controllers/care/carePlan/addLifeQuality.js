!function(){function AddLifeQualityFtory($http,$modal){function openModel(lifeQualityData,callBack){lifeQualityData||(lifeQualityData={});var modalInstance=$modal.open({animation:!0,templateUrl:function(){var isChack=window.location.href.indexOf("/check/");return isChack!=-1?"../src/tpl/care/carePlan/addLifeQuality/addLifeQuality.html":"src/tpl/care/carePlan/addLifeQuality/addLifeQuality.html"}(),controller:"AddLifeQualityCtrl",size:"lg",resolve:{lifeQualityData:function(){return lifeQualityData}}});modalInstance.result.then(function(lifeQualityData){callBack&&callBack(lifeQualityData)})}function copyLifeQuality(repeatAskData,callBack){repeatAskData||(repeatAskData={});var modalInstance=$modal.open({animation:!0,templateUrl:function(){var isChack=window.location.href.indexOf("/check/");return isChack!=-1?"../src/tpl/care/carePlan/addLifeQuality/repeatAsk.html":"src/tpl/care/carePlan/addLifeQuality/repeatAsk.html"}(),controller:"CopyLifeQualityCtrl",size:"lg",resolve:{repeatAskData:function(){return repeatAskData}}});modalInstance.result.then(function(repeatAskData){callBack&&callBack(repeatAskData)})}return{open:openModel,copyLifeQuality:copyLifeQuality}}function AddLifeQualityCtrl($scope,$http,$modal,$modalInstance,toaster,lifeQualityData){function submitLifeQualityData(data){var param={access_token:app.url.access_token,sendTime:$scope.lifeQualityData.sendTime,carePlanId:$scope.lifeQualityData.carePlanId,schedulePlanId:$scope.lifeQualityData.schedulePlanId,dateSeq:$scope.lifeQualityData.dateSeq,jsonData:JSON.stringify({lifeScaleId:data.lifeScaleId})};$scope.lifeQualityData.id&&(param.id=$scope.lifeQualityData.id),$http.post(app.urlRoot+"designer/saveLifeScaleItem",param).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"添加成功"),$modalInstance.close(rpn.data)):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"获取计划数据出错"),console.error(rpn))})}function setTree(){var contacts=new Tree("lifeQualityLibraryTree",{hasCheck:!1,allCheck:!1,multiple:!1,allHaveArr:!1,self:!0,search:!1,arrType:[1,0],data:{url:app.yiliao+"group/stat/getNewDiseaseTypeTree",param:{access_token:app.url.access_token,groupId:app.url.groupId(),tmpType:1,includePlatform:1}},datakey:{id:"id",name:"name",sub:"children"},info:{name:"name",id:"id",pid:"department",leaf:"leaf"},root:{selectable:!0,name:"全部",id:null},events:{click:treeClick},callback:function(){var dts=contacts.tree.find("dt");dts&&dts.eq(0)&&dts.eq(0).data()&&dts.eq(0).data().info&&treeClick(dts.eq(0).data().info)}})}function treeClick(info){$scope.diseaseName=info.name,setTable(info.id)}function setTable(diseaseTypeId,pageIndex,pageSize){$http.post(app.yiliao+"designer/findLifeScaleIncludePlatform",{access_token:app.url.access_token,groupId:app.url.groupId(),diseaseTypeId:diseaseTypeId||$scope.diseaseTypeId||"",pageIndex:pageIndex-1||$scope.pageIndex-1||0,pageSize:pageSize||$scope.pageSize||10}).then(function(rpn){rpn=rpn.data,1===rpn.resultCode?($scope.surveyList=rpn.data.pageData,$scope.page_count=rpn.data.total):rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"接口出错")})}$scope.lifeQualityCheck=function(lifeScaleId,version){var modalInstance=$modal.open({animation:!0,templateUrl:"lifeQualityCheck.html",controller:"ModallifeQualityCheckCtrl",size:"lg",resolve:{lifeid:function(){return lifeScaleId},version:function(){return version}}});modalInstance.result.then(function(selectedItem){},function(){})},$scope.selectItem={},lifeQualityData&&($scope.selectItem=lifeQualityData.lifeScaleItem,$scope.lifeQualityData=lifeQualityData),$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.ok=function(){return $scope.selectItem?void submitLifeQualityData($scope.selectItem):toaster.pop("error",null,"请选择生活量表")},$scope.selectLifeQuality=function(item){$scope.selectItem={lifeScaleId:item.lifeScaleId}},setTimeout(setTree,0),$scope.diseaseTypeId="",$scope.diseaseName="",$scope.pageIndex=1,$scope.pageSize=10,$scope.setTable=setTable,$scope.pageChanged=function(){setTable()}}function CopyLifeQualityCtrl($scope,$http,$modal,$modalInstance,toaster,repeatAskData){function funSetDefault(){$scope.repeatAskOption={repeats:[{repeatSeq:1,dateSeq:1,sendTime:function(){var splitArry=repeatAskData.sendTime.split(":");return"00"===splitArry[1]?(result=splitArry[0]+":30",result):(result=splitArry[0]-0+1+":00",result)}()}]}}console.log(repeatAskData),$scope.thisExecuteTimeOfRepeatList=[],$scope.thisExecuteTime=repeatAskData.thisExecuteTime;for(var j=1;j<=repeatAskData.thisExecuteTime;j++)$scope.thisExecuteTimeOfRepeatList.push(j);$scope.repeatAskData=repeatAskData,$scope.repeatAskOption={},$scope.isEnd=!0,function(){$http.post(app.urlRoot+"designer/getRepeats",{access_token:app.url.access_token,careItemId:repeatAskData.careItem.id}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?rpn.data&&rpn.data.length>0?$scope.repeatAskOption.repeats=rpn.data:funSetDefault():rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"获取出错"),console.error(rpn))})}(),$scope.removeItem=function(item,arry){var index=arry.indexOf(item);arry.splice(index,1)},$scope.addReaptOption=function(filtersJson){var filters=JSON.parse(filtersJson);$scope.repeatAskOption.repeats.push({repeatSeq:1,dateSeq:function(){if($scope.repeatAskOption.repeats&&$scope.repeatAskOption.repeats.length>0){var dateSeq=$scope.repeatAskOption.repeats[$scope.repeatAskOption.repeats.length-1].dateSeq;return dateSeq}return 1}(),sendTime:function(){function nextTime(_splitArry){return _splitArry="00"===_splitArry[1]?[_splitArry[0],"30"]:[_splitArry[0]-0+1+"","00"]}if($scope.repeatAskOption.repeats&&$scope.repeatAskOption.repeats.length>0){var prevTime=$scope.repeatAskOption.repeats[$scope.repeatAskOption.repeats.length-1].sendTime,splitArry=prevTime.split(":"),result=null;for(splitArry=nextTime(splitArry),i=0;i<filters.length;i++)splitArry[0]+":"+splitArry[1]==filters[i]&&(splitArry=nextTime(filters[i].split(":")));return result=splitArry[0]+":"+splitArry[1]}return"09:00"}()})},$scope.timeFilterArry=function(exception,dateSeq){var _repeats=angular.copy($scope.repeatAskOption.repeats),_resultArry=[];1==dateSeq&&(_resultArry=[repeatAskData.sendTime]);for(var i=0;i<_repeats.length;i++)exception!=_repeats[i].sendTime&&dateSeq==_repeats[i].dateSeq&&_resultArry.push(_repeats[i].sendTime);return JSON.stringify(_resultArry)},$scope.optionChange=function(option,arry){var index=arry.indexOf(option.levelName);option.level=index+1},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.ok=function(){var json={repeats:$scope.repeatAskOption.repeats};$http.post(app.urlRoot+"designer/saveRepeats",{access_token:app.url.access_token,careItemId:repeatAskData.careItem.id,jsonData:JSON.stringify(json)}).then(function(rpn){rpn=rpn.data,rpn&&1==rpn.resultCode?(toaster.pop("success",null,"保存成功"),$modalInstance.close(rpn.data)):rpn&&rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):(toaster.pop("error",null,"保存出错"),console.error(rpn))})}}angular.module("app").factory("AddLifeQualityFtory",AddLifeQualityFtory),AddLifeQualityFtory.$inject=["$http","$modal"],angular.module("app").controller("AddLifeQualityCtrl",AddLifeQualityCtrl),angular.module("app").controller("CopyLifeQualityCtrl",CopyLifeQualityCtrl)}(),app.controller("ModallifeQualityCheckCtrl",function($scope,$stateParams,lifeid,version,$http,$modalInstance){$scope.groupDomId=app.url.groupId(),lifeid&&version&&$http.post(app.yiliao+"designer/findLifeScaleByOne",{access_token:app.url.access_token,lifeScaleId:lifeid,version:version}).then(function(rpn){rpn=rpn.data,1===rpn.resultCode?$scope.lifeQualityData=rpn.data:rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"接口出错")}),$scope.cancel=function(){$modalInstance.dismiss("cancel")}});