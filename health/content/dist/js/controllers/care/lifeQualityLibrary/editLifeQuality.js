"use strict";app.controller("editQuestionsOfLifeCtrl",function($scope,$state,$http,toaster,$stateParams,editableThemes,editableOptions,ChooseDepartmentFactory,Lightbox){function checkData(_checkData_){if(!_checkData_.diseaseTypeId)return toaster.pop("error",null,"请选择科室"),!1;if(!_checkData_.title)return toaster.pop("error",null,"请填写生活量表标题"),!1;if(!_checkData_.desc)return toaster.pop("error",null,"请填写生活量表简介"),!1;if(!_checkData_.questions||_checkData_.questions.length<1)return toaster.pop("error",null,"请添加题目"),!1;for(var i=0;i<_checkData_.questions.length;i++){if(!_checkData_.questions[i].name)return toaster.pop("error",null,"请填写Q"+(i+1)+"题目"),!1;for(var j=0;j<_checkData_.questions[i].options.length;j++){if(!_checkData_.questions[i].options[j].name)return toaster.pop("error",null,"请填写Q"+(i+1)+"的第"+(j+1)+"选项名称"),!1;if(""===_checkData_.questions[i].options[j].score)return toaster.pop("error",null,"请填写Q"+(i+1)+"的第"+(j+1)+"选项分数"),!1;if(_checkData_.questions[i].options[j].score<0)return toaster.pop("error",null,"选项分数不能为少于0"),!1}}for(var piontRange=$scope.getPiontRange(),piontSteo=piontRange.max-piontRange.min,record=0,k=0;k<_checkData_.scores.length;k++){if(!_checkData_.scores[k].showInfo)return toaster.pop("error",null,"请填写答案设置的信息"),!1;if(""===_checkData_.scores[k].leftScore||""===_checkData_.scores[k].rigthScore||_checkData_.scores[k].leftScore>_checkData_.scores[k].rigthScore||_checkData_.scores[k].leftScore<piontRange.min||_checkData_.scores[k].rigthScore>piontRange.max)return toaster.pop("error",null,"请正确填写答案设置的得分区域"),!1;record+=_checkData_.scores[k].rigthScore-_checkData_.scores[k].leftScore}return _checkData_.scores.length>1&&piontSteo!=record+(_checkData_.scores.length-1)?(toaster.pop("error",null,"请正确填写答案设置的得分区域"),!1):1===_checkData_.scores.length&&piontSteo!=record?(toaster.pop("error",null,"请正确填写答案设置的得分区域"),!1):_checkData_.groupId?!($scope.getPiontRange().max>=1e4)||(console.log($scope.getPiontRange.max),toaster.pop("error",null,"最大分数不能超过9999"),!1):(toaster.pop("error",null,"集团ID不能为空"),!1)}editableThemes.bs3.inputClass="input-xs",editableThemes.bs3.buttonsClass="btn-xs",editableOptions.theme="bs3",$scope.titleImgs=[],$scope.token=app.url.access_token,function(){$http({url:serverApiRoot+"vpanfile/getUploadToken",method:"post",data:{access_token:app.url.access_token,bucket:"resource"}}).then(function(response){var rep=response.data;rep&&1==rep.resultCode&&rep.data&&rep.data.token&&rep.data.domain||console.error(rep)})}(),$scope.openLightboxModal=function(targetItem,index){Lightbox.openModal(targetItem,index)},$scope.openSingleLightboxModal=function(index,item){Lightbox.openModal(item,0)},$scope.fileUploadProcess=function(up,file){"isUploadTotalPic"==$scope.selectPicItem?$scope.uploadTotalPicsPercent=0:"isHeadTitlePic"!=$scope.selectPicItem?$scope.selectPicItem.uploadPenct=100==file.percent?99:file.percent:$scope.itemTitle.uploadPenct=100==file.percent?99:file.percent},$scope.qiniuFilters={mime_types:[{title:"Image files",extensions:"jpg,gif,png"}]},$scope.selectFile=function(e,t){"uploadTotalPics"==e?($scope.selectPicItem="isUploadTotalPic",$scope.isUploadTotalImages=t):"isHeadTitlePic"!=e?($scope.selectPicItem=e,e.uploadPenct=0,e.picUrls||(e.picUrls=[])):(t.picUrls||(t.picUrls=[]),t.uploadPenct=0,$scope.selectPicItem="isHeadTitlePic",$scope.itemTitle=t),$scope.upload()},$scope.removeItemImg=function(e,index){e.splice(index,1),e.uploadPenct=0},$scope.removeOptionImg=function(item){item.picUrls.splice(0,1),item.uploadPenct=0},$scope.token=app.url.access_token,$scope.uploaderAdded=function(up,files){$scope.totalUploadFilesNum=files.length},$scope.uploaderSuccess=function(up,file,info){function getImageInfo(callback){$http.get(file.url+"?imageInfo").then(function(rpn){rpn?(imageInfo=rpn.data,callback()):console.log("something happened unexpected")})}function setPicInfo(){"isUploadTotalPic"==$scope.selectPicItem?($scope.isEditNew=!1,$scope.isEditNew?($scope.lifeQualityData.questions[$scope.isUploadTotalImages].options=[],$scope.lifeQualityData.questions[$scope.isUploadTotalImages].options.push({name:"请点击输入选项名称",score:0,picUrls:[file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key]}),$scope.isEditNew=!1):$scope.lifeQualityData.questions[$scope.isUploadTotalImages].options.push({name:"请点击输入选项名称",score:0,picUrls:[file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key]})):"isHeadTitlePic"!=$scope.selectPicItem?($scope.selectPicItem.picUrls[0]=file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key,$scope.selectPicItem.uploadPenct=100):($scope.itemTitle.picUrls.push(file.url+"?xgWidth="+imageInfo.width+"&xgHeight="+imageInfo.height+"&xgFormat="+imageInfo.format+"&xgKey="+info.key),$scope.itemTitle.uploadPenct=100),$scope.copy_small=file.url+"?imageView2/3/w/200/h/200",toaster.pop("success",null,"题图上传成功！")}if($scope.totalUploadFilesNum--,$scope.itemTitle&&"isUploadTotalPic"!=$scope.selectPicItem&&"isHeadTitlePic"==$scope.selectPicItem&&$scope.itemTitle.picUrls.length>=8)return void toaster.pop("error",null,"最多上传8张题目图片");$scope.uploadTotalPicsPercent=0;var info=JSON.parse(info),imageInfo={};getImageInfo(setPicInfo)},$scope.uploaderError=function(up,err,errTip){toaster.pop("error",null,"题图大于2M，请重新上传"),"-600"==err.code?toaster.pop("error",null,"题图大于2M，请重新上传"):toaster.pop("error",null,errTip)},$stateParams.lifeScaleId&&$stateParams.version&&$http.post(app.yiliao+"designer/findLifeScaleByOne",{access_token:app.url.access_token,lifeScaleId:$stateParams.lifeScaleId,version:$stateParams.version}).then(function(rpn){rpn=rpn.data,1===rpn.resultCode?($scope.lifeQualityData=rpn.data,$scope.isDiseaseDisable=!0):rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"接口出错")}),$scope.lifeQualityData={groupId:app.url.groupId(),questions:[{name:"问题题目1",options:[{name:"请点击输入选项名称",score:0,picUrls:[]},{name:"请点击输入选项名称",score:0,picUrls:[]}],picUrls:[]}],scores:[{}]},$scope.chooseDepartment=function(){function callback(department){$scope.lifeQualityData.diseaseTypeId=department.departmentLable,$scope.lifeQualityData.diseaseName=department.departmentLableName}ChooseDepartmentFactory.open(callback)},$scope.addOption=function(qIndex){$scope.lifeQualityData.questions[qIndex].options.push({name:"请点击输入选项名称",score:0})},$scope.removeOption=function(qIndex,oIndex){$scope.lifeQualityData.questions[qIndex].options.splice(oIndex,1)},$scope.addQuestion=function(){$scope.lifeQualityData.questions.push({name:"问题题目"+($scope.lifeQualityData.questions.length+1),options:[{name:"请点击输入选项名称",score:0,picUrls:[]},{name:"请点击输入选项名称",score:0,picUrls:[]}],picUrls:[]})},$scope.copyQyestiong=function(qIndex,item){var name="问题题目"+qIndex+1,picUrls=[];item.name&&(name=item.name),item.picUrls&&(picUrls=item.picUrls);for(var _copyItem_={name:name,options:[],picUrls:picUrls},i=0;i<item.options.length;i++)_copyItem_.options[i]={name:item.options[i].name||"请点击输入选项名称",score:item.options[i].score||0,picUrls:item.options[i].picUrls||[]};$scope.lifeQualityData.questions.splice(qIndex+1,0,_copyItem_)},$scope.removeQuestion=function(qIndex){$scope.lifeQualityData.questions.splice(qIndex,1)},$scope.putUpQuestion=function(qIndex){var _copyItem_=$scope.lifeQualityData.questions[qIndex-1];$scope.lifeQualityData.questions[qIndex-1]=$scope.lifeQualityData.questions[qIndex],$scope.lifeQualityData.questions[qIndex]=_copyItem_},$scope.putDownQuestion=function(qIndex){var _copyItem_=$scope.lifeQualityData.questions[qIndex+1];$scope.lifeQualityData.questions[qIndex+1]=$scope.lifeQualityData.questions[qIndex],$scope.lifeQualityData.questions[qIndex]=_copyItem_},$scope.onlyNbr=function(nbr){return null===nbr||void 0===nbr||nbr<0?(toaster.pop("error",null,"请输入正确的分数"),0):nbr},$scope.getPiontRange=function(){var _min_=0,_max_=0,_arry_=[];angular.copy($scope.lifeQualityData.questions,_arry_);for(var i=0;i<_arry_.length;i++){var _options_=_arry_[i].options;_options_.sort(function(a,b){return a.score-b.score}),_min_+=_options_[0].score-0,_max_+=_options_[_options_.length-1].score-0}return{min:_min_,max:_max_}},$scope.addAnswerInfo=function(){$scope.lifeQualityData.scores.push({})},$scope.removeAnswerInfo=function(index){$scope.lifeQualityData.scores.splice(index,1)},$scope.saveEdit=function(){if($scope.totalUploadFilesNum>1)return void toaster.pop("waring",null,"图片正常上传，请稍后");var _checkData_=$scope.lifeQualityData;checkData(_checkData_)&&(_checkData_.questions.picUrls=$scope.titleImgs,_checkData_=JSON.stringify(_checkData_),$http.post(app.yiliao+"designer/lifeScale/save",{access_token:app.url.access_token,jsonData:_checkData_}).then(function(rpn){rpn=rpn.data,1===rpn.resultCode?(toaster.pop("success",null,"保存成功"),$state.go("app.care_plan.lifeQualityLibrary")):rpn.resultMsg?toaster.pop("error",null,rpn.resultMsg):toaster.pop("error",null,"接口出错")}))}});