app.controller("GroupArticleListCtrl",function($scope,$timeout,utils,$http,$modal,toaster,$location,$state,Group,AppFactory){"use strict";function clone(myObj){var newObj={};if(newObj.label=myObj.name+"("+myObj.count+")",newObj.id=myObj.diseaseId,void 0!=myObj.children){newObj.children=[];for(var i in myObj.children)newObj.children[i]=clone(myObj.children[i])}return newObj}function initDocTable(){var index=1,length=10,start=0,size=10,setTable=function(){articleTable=$("#article_list").DataTable({language:app.lang.datatables.translation,searching:!1,sScrollX:"100%",sScrollXInner:"110%",destroy:!0,lengthChange:!0,ordering:!1,draw:index,pageLength:length,lengthMenu:[5,10,20,50],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:allDocUrl,fnServerData:function(sSource,aoData,fnCallback){$.ajax({type:"post",url:sSource,dataType:"json",data:allDocParam,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else console.log(resp.resultMsg)}})},columns:[{data:"author",render:function(set,status,dt){var keywordsStr="";dt.tag&&dt.tag.length>0?(keywordsStr+="关键字：",dt.tag.forEach(function(item,index,array){item&&(keywordsStr+=item.name+"；")})):keywordsStr+="&nbsp;";var authorName=dt.authorName?dt.authorName:dt.author,photoPath=dt.copy_small?dt.copy_small:"src/img/nophoto.jpg";return"<img src="+photoPath+' alt="..." style="width:60px;height:60px;margin-right:10px;float:left;border-radius:0;"><span class="clear"><span>'+dt.title+'</span><small class="text-muted clear text-ellipsis">'+keywordsStr.substring(0,30)+'</small><small class="text-muted clear text-ellipsis">作者：'+authorName+"</small></span>"}},{data:"useNum",render:function(set,status,dt){return void 0==dt.useNum?0:dt.useNum}},{data:"visitCount",render:function(set,status,dt){return void 0==dt.visitCount?0:dt.visitCount}},{render:function(set,status,dt){return utils.dateFormat(dt.creatTime,"yyyy-MM-dd")}},{render:function(set,status,dt){return 2==dt.collect?'<label id="editArticle" class="operate">编辑</label> | <label id="copyUrl"  class="operate copyUrl" data-clipboard-text="'+dt.url+'">拷贝url</label>':1==dt.collect?dt.groupId.indexOf(curGroupId)>-1?'<label id="editArticle" class="operate">编辑</label> | <label id="copyUrl"  class="operate copyUrl" data-clipboard-text="'+dt.url+'">拷贝url</label>':'<label id="removeCollect" class="operate">取消收藏</label> | <label id="copyUrl"  class="operate copyUrl" data-clipboard-text="'+dt.url+'">拷贝url</label>':'<label id="copyUrl"  class="operate copyUrl" data-clipboard-text="'+dt.url+'">拷贝url</label>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#editArticle",function(event){editArticle(aData),event.stopPropagation()}),$(nRow).on("click","#removeCollect",function(event){removeCollect(aData,nRow),event.stopPropagation()}),$(nRow).on("click","",function(event){if("copyUrl"!=event.target.id){var url=$state.href("groupArticle",{id:aData.id});window.open(url,"_blank")}})}}),articleTable.off("page.dt").on("page.dt",function(e,settings){index=articleTable.page.info().page+1,start=length*(index-1),allDocParam.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=1,start=0,allDocParam.pageIndex=1,allDocParam.pageSize=len})};setTable()}var currentTreeId,curGroupId=localStorage.getItem("curGroupId");localStorage.getItem("user_id");$scope.showMore=!1;var articleTable;$scope.isCollapsed=!1,$scope.open=!1,$scope.isTreeLoaded=!1,$scope.mainKeyword=null;var preBranch;$scope.currentOrgInfo=Group.getCurrentOrgInfo(),$scope.currentOrgInfo&&AppFactory.group.isServiceGroup($scope.currentOrgInfo.id).then(function(_data){_data?$scope.isServiceGroup=!0:$scope.isServiceGroup=!1});var tree={};$scope.my_tree=tree={},$scope.mainKWLength=0,$scope.$watch("mainKeyword",function(newValue,oldValue){newValue!=oldValue&&($scope.mainKeyword?$scope.mainKWLength=$scope.mainKeyword.length:$scope.mainKWLength=0)});var allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:2,pageIndex:1,pageSize:10,createrId:curGroupId};$scope.clearMainKW=function(){$scope.my_tree.select_branch(preBranch),$scope.mainKeyword=null},$scope.my_data=[];var getTreeData=function(){$http.post(app.url.group.getCategoryList,{access_token:app.url.access_token,createType:2,groupId:curGroupId}).success(function(data,status,headers,config){if(1==data.resultCode){var source={count:data.data.total,name:"全部文档"};source.children=data.data.tree;var result=clone(source),eArray=new Array;eArray[0]=result,$scope.my_data=eArray,$scope.isTreeLoaded=!0}else console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})};getTreeData(),$scope.my_tree_handler=function(branch){currentTreeId=branch.id,3==branch.level?$http.post(app.url.document.getDisease,{parentId:branch.id}).success(function(data,status,headers,config){1==data.resultCode?($scope.keywords=data.data,$scope.keywords.length>0&&$scope.keywords.unshift({name:"不限",id:null})):alert(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)}):$scope.keywords=[],allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:2,pageIndex:1,pageSize:10,createrId:curGroupId,diseaseId:branch.id},initDocTable()},$scope.createArticle=function(){$state.go("app.document.group.create_article",null,{reload:!0})},$scope.sortByKeyword=function(keyword){"不限"==keyword.name?(allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:2,pageIndex:1,pageSize:10,createrId:curGroupId,diseaseId:currentTreeId}):(allDocUrl=app.url.document.findArticleByTag,allDocParam={access_token:app.url.access_token,createType:2,pageIndex:1,pageSize:10,createrId:curGroupId,tags:keyword.id}),initDocTable()},$scope.pressEnter=function($event){13==$event.keyCode&&$scope.findDocByKeyWord()},$scope.findDocByKeyWord=function(){preBranch=$scope.my_tree.get_selected_branch(),$scope.my_tree.select_branch(),$scope.keywords=[],null==$scope.mainKeyword||0==$scope.mainKeyword.length?(allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:2,pageIndex:1,pageSize:10,createrId:curGroupId}):(allDocUrl=app.url.knowledge.findKnowledgeListByKeys,allDocParam={title:$scope.mainKeyword,access_token:app.url.access_token,createType:2,createrId:curGroupId,pageIndex:1,pageSize:10}),initDocTable()},$scope.$watch("keywords",function(newValue,oldValue){setTimeout(function(){var kw_c_height=$("#g_kw_content").height();console.log(kw_c_height),kw_c_height<40?$scope.showMore=!1:$scope.showMore=!0,$scope.$apply("showMore")},0)}),$scope.addFromPlatform=function(){var modalInstance=$modal.open({templateUrl:"docModalContent.html",controller:"article_list_docModalInstanceCtrl",windowClass:"docModal doc",resolve:{items:function(){return $scope.items}}});modalInstance.result.then(function(selectedItem){allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:2,pageIndex:1,pageSize:10,createrId:curGroupId},initDocTable(),$scope.isTreeLoaded=!1,getTreeData()},function(){allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:2,pageIndex:1,pageSize:10,createrId:curGroupId},initDocTable(),$scope.isTreeLoaded=!1,getTreeData()})};var editArticle=function(aData){$state.go("app.document.group.edit_article",{id:aData.id},{reload:!0})},removeCollect=function(aData,nRow){$http.post(app.url.document.collectArticleRemove,{access_token:app.url.access_token,articleId:aData.id,createType:2,createrId:curGroupId}).success(function(data,status,headers,config){1==data.resultCode?(nRow.remove(),toaster.pop("success","","取消收藏成功")):console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})};initDocTable();var clipboard=new Clipboard(".copyUrl");clipboard.on("success",function(e){$timeout(function(){toaster.pop("success","","复制成功")}),e.clearSelection()}),clipboard.on("error",function(e){$timeout(function(){toaster.pop("error","","复制失败")}),e.clearSelection()}),window.reflashData=function(){initDocTable()},$scope.$on("$destroy",function(){clipboard.destroy()})}),app.controller("article_list_docModalInstanceCtrl",function($scope,$modalInstance,toaster,$http,utils,$timeout){function clone(myObj){var newObj={};if(newObj.label=myObj.name+"("+myObj.count+")",newObj.id=myObj.diseaseId,void 0!=myObj.children){newObj.children=[];for(var i in myObj.children)newObj.children[i]=clone(myObj.children[i])}return newObj}function initPlatDocTable(){var index=1,length=10,start=0,size=10,setTable=function(){platArticleTable=$("#doc_list").DataTable({language:app.lang.datatables.translation,searching:!1,sScrollX:"100%",sScrollXInner:"110%",destroy:!0,lengthChange:!0,ordering:!1,draw:index,pageLength:length,lengthMenu:[5,10,20,50],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:allDocUrl,fnServerData:function(sSource,aoData,fnCallback){$.ajax({type:"post",url:sSource,dataType:"json",data:allDocParam,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else console.log(resp.resultMsg)}})},columns:[{data:"author",render:function(set,status,dt){var keywordsStr="";dt.tag&&dt.tag.length>0?(keywordsStr+="关键字：",dt.tag.forEach(function(item,index,array){item&&(keywordsStr+=item.name+"；")})):keywordsStr+="&nbsp;";var authorName=dt.authorName?dt.authorName:dt.author,photoPath=dt.copy_small?dt.copy_small:"src/img/nophoto.jpg";return"<img src="+photoPath+' alt="..." style="width:60px;height:60px;margin-right:10px;float:left;border-radius:0;"><span class="clear"><span>'+dt.title+'</span><small class="text-muted clear text-ellipsis">'+keywordsStr.substring(0,30)+'</small><small class="text-muted clear text-ellipsis">作者：'+authorName+"</small></span>"},orderable:!1},{data:"useNum",orderable:!1,render:function(set,status,dt){return void 0==dt.useNum?0:dt.useNum}},{data:"visitCount",orderable:!1,render:function(set,status,dt){return void 0==dt.visitCount?0:dt.visitCount}},{render:function(set,status,dt){return utils.dateFormat(dt.creatTime,"yyyy-MM-dd")}},{render:function(set,status,dt){return 0==dt.collect?'<label id="collectArticle" class="operate">收藏</label>':1==dt.collect?dt.groupId.indexOf(curGroupId)>-1?"":'<label id="removeCollect" class="operate">取消收藏</label>':""},orderable:!1}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#collectArticle",function(event){collectArticle(aData),event.stopPropagation()}),$(nRow).on("click","#removeCollect",function(event){removeCollect(aData),event.stopPropagation()}),$(nRow).on("click","",function(){window.open(aData.url+"?"+Date.now())})}}),platArticleTable.off("page.dt").on("page.dt",function(e,settings){index=platArticleTable.page.info().page+1,start=length*(index-1),allDocParam.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=1,start=0,allDocParam.pageIndex=1,allDocParam.pageSize=len})};setTable()}var platArticleTable,curGroupId=localStorage.getItem("curGroupId");$scope.isCollapsed=!1,$scope.open=!1,$scope.showMore=!1;var currentTreeId;$scope.keywords=[],$scope.isTreeLoaded=!1,$scope.isDocLoaded=!1,$scope.mainKeyword=null;var preBranch,tree={};$scope.my_tree=tree={};var allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:10};$scope.my_data=[];var getTreeData=function(){$http.post(app.url.document.findDiseaseTreeForArticle,{access_token:app.url.access_token,createType:1}).success(function(data,status,headers,config){if(1==data.resultCode){var source={count:data.data.total,name:"全部文档",diseaseId:null};source.children=data.data.tree;var result=clone(source),eArray=new Array;eArray[0]=result,$scope.my_data=eArray,$scope.isTreeLoaded=!0}else console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})};getTreeData(),$scope.my_tree_handler=function(branch){currentTreeId=branch.id,$scope.isTop=!1,0==branch.children.length?$http.post(app.url.document.getDisease,{parentId:branch.id}).success(function(data,status,headers,config){1==data.resultCode?($scope.keywords=data.data,$scope.keywords.length>0&&$scope.keywords.unshift({name:"不限",id:null})):alert(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)}):$scope.keywords=[],allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:10,diseaseId:branch.id},initPlatDocTable()},$scope.mainKWLength=0,$scope.$watch("mainKeyword",function(newValue,oldValue){newValue!=oldValue&&($scope.mainKeyword?$scope.mainKWLength=$scope.mainKeyword.length:$scope.mainKWLength=0)}),$scope.$watch("keywords",function(newValue,oldValue){setTimeout(function(){var kw_c_height=$("#p_kw_content").height();console.log(kw_c_height),kw_c_height<40?$scope.showMore=!1:$scope.showMore=!0,$scope.$apply("showMore")},0)}),$scope.sortByKeyword=function(keyword){"不限"==keyword.name?(allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:10,diseaseId:currentTreeId}):(allDocUrl=app.url.document.findArticleByTag,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:10,tags:keyword.id}),initPlatDocTable()},$scope.clearMainKW=function(){$scope.my_tree.select_branch(preBranch),$scope.mainKeyword=null},$scope.pressEnter=function($event){13==$event.keyCode&&$scope.findDocByKeyWord()},$scope.findDocByKeyWord=function(){preBranch=$scope.my_tree.get_selected_branch(),$scope.my_tree.select_branch(),$scope.keywords=[],null==$scope.mainKeyword||0==$scope.mainKeyword.length?(allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:10}):(allDocUrl=app.url.document.findArticleByKeyWord,allDocParam={title:$scope.mainKeyword,access_token:app.url.access_token,createType:4,createrId:curGroupId,pageIndex:1,pageSize:10}),initPlatDocTable()};var collectArticle=function(aData){$http.post(app.url.document.collectArticle,{access_token:app.url.access_token,articleId:aData.id,createType:2,createrId:curGroupId}).success(function(data,status,headers,config){1==data.resultCode?"false"==data.data?toaster.pop("error","","收藏失败"):"true"==data.data&&(allDocParam.pageIndex=1,initPlatDocTable(),toaster.pop("success","","收藏成功")):console.log(data.resultMsg)}).error(function(data,status,headers,config){console.log(data.resultMsg)})},removeCollect=function(aData){$http.post(app.url.document.collectArticleRemove,{access_token:app.url.access_token,articleId:aData.id,createType:2,createrId:curGroupId}).success(function(data,status,headers,config){1==data.resultCode?(allDocParam.pageIndex=1,initPlatDocTable(),toaster.pop("success","","取消收藏成功")):console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})};setTimeout(function(){initPlatDocTable()},200),$scope.cancel=function(){$modalInstance.dismiss("cancel")}});