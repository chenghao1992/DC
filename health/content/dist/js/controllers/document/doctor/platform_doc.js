"use strict";app.controller("PlatCtrl",function($scope,$timeout,utils,$http,modal,toaster,$location,$state){function clone(myObj){var newObj={};if(newObj.label=myObj.name+"("+myObj.count+")",newObj.id=myObj.diseaseId,void 0!=myObj.children){newObj.children=[];for(var i in myObj.children)newObj.children[i]=clone(myObj.children[i])}return newObj}function initPlatDocTable(){var index=1,length=10,start=0,idx=0,size=10,num=0,setTable=function(){platArticleTable=$("#doc_list").DataTable({language:app.lang.datatables.translation,searching:!1,sScrollX:"100%",sScrollXInner:"110%",destroy:!0,lengthChange:!0,ordering:!1,draw:index,pageLength:length,lengthMenu:[5,10,20,50],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:allDocUrl,fnServerData:function(sSource,aoData,fnCallback){num=1,idx=index,$.ajax({type:"post",url:sSource,dataType:"json",data:allDocParam,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else console.log(resp.resultMsg)}})},columns:[{data:"author",render:function(set,status,dt){var keywordsStr="";dt.tag&&dt.tag.length>0?(keywordsStr+="关键字：",dt.tag.forEach(function(item,index,array){item&&(keywordsStr+=item.name+"；")})):keywordsStr+="&nbsp;";var authorName=dt.authorName?dt.authorName:dt.author,photoPath=dt.copy_small?dt.copy_small:"src/img/nophoto.jpg";return"<img src="+photoPath+' alt="..." style="width:60px;height:60px;margin-right:10px;float:left;border-radius:0;"><span class="clear"><span>'+dt.title+'</span><small class="text-muted clear text-ellipsis">'+keywordsStr.substring(0,30)+'</small><small class="text-muted clear text-ellipsis">作者：'+authorName+"</small></span>"}},{data:"useNum",render:function(set,status,dt){return void 0==dt.useNum?0:dt.useNum}},{data:"visitCount",render:function(set,status,dt){return void 0==dt.visitCount?0:dt.visitCount}},{render:function(set,status,dt){return utils.dateFormat(dt.creatTime,"yyyy-MM-dd")}},{render:function(set,status,dt){return 0==dt.collect?'<label id="collectArticle" class="operate">收藏</label>':1==dt.collect?'<label id="removeCollect" class="operate">取消收藏</label>':""}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#collectArticle",function(event){collectArticle(aData),event.stopPropagation()}),$(nRow).on("click","#removeCollect",function(event){removeCollect(aData.id),event.stopPropagation()}),$(nRow).on("click","",function(event){var url=$state.href("doctorArticle",{id:aData.id,createType:5});window.open(url,"_blank")})}}),platArticleTable.off("page.dt").on("page.dt",function(e,settings){index=platArticleTable.page.info().page+1,start=length*(index-1),allDocParam.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=1,start=0,allDocParam.pageIndex=1,allDocParam.pageSize=len})};setTable()}var platArticleTable,userId=localStorage.getItem("user_id");$scope.isCollapsed=!1,$scope.open=!1,$scope.showMore=!1;var currentTreeId;$scope.keywords=[],$scope.isTreeLoad=!1,$scope.mainKeyword=null;var preBranch,tree={};$scope.my_tree=tree={};var allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:5,pageIndex:1,pageSize:10};$scope.my_data=[];var getTreeData=function(){$http.post(app.url.document.findDiseaseTreeForArticle,{access_token:app.url.access_token,createType:1}).success(function(data,status,headers,config){if(1==data.resultCode){var source={count:data.data.total,name:"全部文档"};source.children=data.data.tree;var result=clone(source),eArray=new Array;eArray[0]=result,$scope.my_data=eArray,$scope.isTreeLoad=!0}else console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})};getTreeData(),$scope.my_tree_handler=function(branch){currentTreeId=branch.id,3==branch.level?$http.post(app.url.document.getDisease,{parentId:branch.id}).success(function(data,status,headers,config){1==data.resultCode?($scope.keywords=data.data,$scope.keywords.length>0&&$scope.keywords.unshift({name:"不限",id:null})):alert(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)}):$scope.keywords=[],allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:5,pageIndex:1,pageSize:10,diseaseId:branch.id},initPlatDocTable()},$scope.mainKWLength=0,$scope.$watch("mainKeyword",function(newValue,oldValue){newValue!=oldValue&&($scope.mainKeyword?$scope.mainKWLength=$scope.mainKeyword.length:$scope.mainKWLength=0)}),$scope.$watch("keywords",function(newValue,oldValue){setTimeout(function(){var kw_c_height=$("#kw_content").height();kw_c_height<40?$scope.showMore=!1:$scope.showMore=!0,$scope.$apply("showMore")},0)}),$scope.clearMainKW=function(){$scope.my_tree.select_branch(preBranch),$scope.mainKeyword=null},$scope.sortByKeyword=function(keyword){"不限"==keyword.name?(allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:5,pageIndex:1,pageSize:10,diseaseId:currentTreeId}):(allDocUrl=app.url.document.findArticleByTag,allDocParam={access_token:app.url.access_token,createType:5,pageIndex:1,pageSize:10,tags:keyword.id}),initPlatDocTable()},$scope.pressEnter=function($event){13==$event.keyCode&&$scope.findDocByKeyWord()},$scope.findDocByKeyWord=function(){preBranch=$scope.my_tree.get_selected_branch(),$scope.my_tree.select_branch(),$scope.keywords=[],null==$scope.mainKeyword||0==$scope.mainKeyword.length?(allDocUrl=app.url.document.getArticleByDisease,allDocParam={access_token:app.url.access_token,createType:5,pageIndex:1,pageSize:10}):(allDocUrl=app.url.document.findArticleByKeyWord,allDocParam={title:$scope.mainKeyword,access_token:app.url.access_token,createType:5,pageIndex:1,pageSize:10}),initPlatDocTable()};var collectArticle=function(aData){$http.post(app.url.document.collectArticle,{access_token:app.url.access_token,articleId:aData.id,createType:3,createrId:userId}).success(function(data,status,headers,config){1==data.resultCode?"false"==data.data?toaster.pop("error","","收藏失败"):"true"==data.data&&(allDocParam.pageIndex=1,initPlatDocTable(),toaster.pop("success","","收藏成功")):console.log(data.resultMsg)}).error(function(data,status,headers,config){console.log(data.resultMsg)})},removeCollect=function(id){$http.post(app.url.document.collectArticleRemove,{access_token:app.url.access_token,articleId:id,createType:3}).success(function(data,status,headers,config){1==data.resultCode?(allDocParam.pageIndex=1,initPlatDocTable(),toaster.pop("success","","取消收藏成功")):console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})};initPlatDocTable(),$scope.cancel=function(){$modalInstance.dismiss("cancel")},window.reflashData=function(){initPlatDocTable()}});