app.controller("EditCtrl",function($scope,$timeout,utils,$http,$modal,Upload,toaster,$state,$stateParams,Group,AppFactory){function initEdit(){$stateParams.id&&(isEdit=!0,$http.post(app.url.document.getArticleById,{access_token:app.url.access_token,articleId:$stateParams.id}).success(function(data,status,headers,config){1==data.resultCode?(console.log(data),$scope.formData={author:data.data.author,summary:data.data.description,title:data.data.title,keywords:data.data.tag,selectedType:data.data.disease},$scope.fontImgUrl=data.data.copyPath,$scope.copy_small=data.data.copy_small,$scope.formData.isShow=1==data.data.isShow,$scope.formData.isShare=1==data.data.isShare,100==data.data.description.length&&($scope.formData.summary=data.data.description.substring(0,94)+"......"),articleId=data.data.id,um.setContent(data.data.content)):console.log(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)}))}function diseaseSelected(dt){console.log(dt),$scope.formData.selectedType=dt[0],$scope.$apply($scope.formData.selectedType)}function tagsSelected(dt){$scope.formData.keywords=dt,$scope.$apply($scope.formData.keywords)}var userName=localStorage.getItem("user_name"),access_token=localStorage.getItem("access_token");$scope.titleLength=0,$scope.summaryLength=0,$scope.formData={},$scope.formData.keywords=[],$scope.formData.isShow=!0,$scope.formData.isShare=!0,$scope.fontImg=null,$scope.fontImgUrl=null,$scope.copy_small=null,$scope.isSaved=!1,localStorage.removeItem("articlePreview");var um=null,isEdit=!1,articleId=null;$scope.currentOrgInfo=Group.getCurrentOrgInfo(),$scope.currentOrgInfo&&AppFactory.group.isServiceGroup($scope.currentOrgInfo.id).then(function(_data){_data?$scope.isServiceGroup=!0:($scope.isServiceGroup=!1,$scope.formData.isShare=!1)}),$http({url:serverApiRoot+"vpanfile/getUploadToken",method:"post",data:{access_token:access_token,bucket:"resource"}}).then(function(response){var rep=response.data;rep&&1==rep.resultCode&&rep.data&&rep.data.token&&rep.data.domain?(um=UM.getEditor("myEditor",{initialFrameWidth:"100%",initialFrameHeight:300,qiniuToken:rep.data.token,qiniuDomain:rep.data.domain}),initEdit()):console.error(rep)}),$scope.$on("$destroy",function(){um.destroy()}),$scope.$watch("formData.title",function(newValue,oldValue){newValue!=oldValue&&($scope.formData.title?$scope.titleLength=$scope.formData.title.length:$scope.titleLength=0)}),$scope.$watch("formData.summary",function(newValue,oldValue){newValue!=oldValue&&($scope.formData.summary?$scope.summaryLength=$scope.formData.summary.length:$scope.summaryLength=0)}),$scope.chooseType=function(){new DataBox("data_res",{hasCheck:!1,allCheck:!1,leafCheck:!0,multiple:!1,allHaveArr:!1,self:!1,cover:!1,leafDepth:2,selectView:!1,search:{dataKey:{name:"name",id:"id",union:"parentId",dataSet:"data"},unwind:!1},arrType:[0,0],data:{url:app.url.document.getDiseaseTree},titles:{main:"选择病种",searchKey:"搜索病种...",label:"已选择病种数"},fixdata:[],icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check/fa fa-square",root:"fa fa-hospital-o cfblue",branch:"fa fa-h-square cfblue",leaf:"fa fa-stethoscope dcolor",head:"headPicFileName"},response:diseaseSelected,datakey:{id:"id",name:"name",sub:"children"},info:{name:"name",id:"id",leaf:"leaf",pid:"parentId"}})},$scope.chooseDisease=function(){new DataBox("data_res",{hasCheck:!0,allCheck:!0,leafCheck:!0,multiple:!0,allHaveArr:!1,self:!1,cover:!1,leafDepth:3,selectView:!0,search:{searchDepth:[2],dataKey:{name:"name",id:"id",union:"parentId",dataSet:"data"},unwind:!1},arrType:[0,0],data:{url:app.url.document.getDiseaseTree},titles:{main:"选择标签",searchKey:"搜索标签...",label:"已选择标签数"},icons:{arrow:"fa fa-caret-right/fa fa-caret-down",check:"fa fa-check/fa fa-square",root:"fa fa-hospital-o cfblue",branch:"fa fa-h-square cfblue",leaf:"fa fa-stethoscope dcolor",head:"headPicFileName"},fixdata:$scope.formData.keywords,response:tagsSelected,datakey:{id:"id",name:"name",sub:"children"},info:{name:"name",id:"id",leaf:"leaf"}})},$scope.removeItem=function(item){var index=$scope.formData.keywords.indexOf(item);$scope.formData.keywords.splice(index,1),console.log($scope.formData.keywords)},$scope.qiniuFilters={mime_types:[{title:"Image files",extensions:"jpg,gif,png"}]},$scope.selectFile=function(){$scope.upload()},$scope.token=app.url.access_token,$scope.uploaderAdded=function(up,files){$scope.uploadPercent=0,console.log(up,files)},$scope.uploaderSuccess=function(up,file,info){$scope.fontImgUrl=file.url,$scope.copy_small=file.url+"?imageView2/3/w/200/h/200",$scope.uploadPercent=100,toaster.pop("success",null,"封面修改成功！")},$scope.uploaderError=function(up,err,errTip){err.code==-600?toaster.pop("error",null,"文件过大"):toaster.pop("error",null,errTip)},$scope.fileUploadProcess=function(up,file){$scope.uploadPercent=100==file.percent?99:file.percent},$scope.saveDoc=function(){var tagsId=[];if(!$scope.formData.title)return void toaster.pop("warn","","请填写标题");if(!$scope.fontImgUrl)return void toaster.pop("warn","","请上传题图");null!=$scope.formData.keywords&&$scope.formData.keywords.length>0&&$scope.formData.keywords.forEach(function(item,index,array){tagsId.push(item.id)});var html=um.getContent(),firstParagraph=um.getContentTxt().slice(0,100),isShow=0==$scope.formData.isShow?0:1,isShare=0==$scope.formData.isShare?0:1;$scope.isSaved=!0,1==isEdit?$http.post(app.url.document.updateArticle,{access_token:app.url.access_token,articleId:articleId,title:$scope.formData.title,diseaseId:$scope.formData.selectedType?$scope.formData.selectedType.id:null,isShow:isShow,isShare:isShare,tags:tagsId,copyPath:$scope.fontImgUrl,copy_small:$scope.copy_small,description:$scope.formData.summary?$scope.formData.summary:firstParagraph,content:html}).success(function(data,status,headers,config){1==data.resultCode?$state.includes("app.document.doctor.edit_article")?(toaster.pop("success","","保存成功,3秒钟后返回文章列表"),setTimeout(function(){$state.go("app.document.doctor.doctor_doc",{},{reload:!0})},3e3)):$state.includes("doctor_edit_article")&&(window.opener.reflashData(),toaster.pop("success","","保存成功,3秒钟后返回"),setTimeout(function(){$state.go("doctorArticle",{id:$stateParams.id,createType:$stateParams.createType},{reload:!0})},3e3)):($scope.isSaved=!1,toaster.pop("error","",data.resultMsg))}).error(function(data,status,headers,config){$scope.isSaved=!1,toaster.pop("error","",data.resultMsg)}):$http.post(app.url.document.addArticle,{access_token:app.url.access_token,title:$scope.formData.title,diseaseId:$scope.formData.selectedType?$scope.formData.selectedType.id:null,isShow:isShow,createType:3,copyPath:$scope.fontImgUrl,copy_small:$scope.copy_small,isShare:isShare,tags:tagsId,description:$scope.formData.summary?$scope.formData.summary:firstParagraph,content:html}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success","","保存成功,3秒钟后返回文章列表"),setTimeout(function(){$state.go("app.document.doctor.doctor_doc",{},{reload:!0})},3e3)):($scope.isSaved=!1,toaster.pop("error","",data.resultMsg))}).error(function(data,status,headers,config){$scope.isSaved=!1,toaster.pop("error","",data.resultMsg)})},$scope.toPreview=function(){if(!$scope.formData.title)return void toaster.pop("warn","","请填写标题");if(!$scope.fontImgUrl)return void toaster.pop("warn","","请上传题图");var isShow=0==$scope.formData.isShow?0:1,html=um.getContent(),firstParagraph=um.getContentTxt().slice(0,100),articlePreview={authorName:userName,title:$scope.formData.title,keywords:$scope.formData.keywords,isShow:isShow,copyPath:$scope.fontImgUrl,summary:$scope.formData.summary?$scope.formData.summary:firstParagraph,content:html,date:Date.now()};$modal.open({templateUrl:"previewModalContent.html",controller:"previewModalInstanceCtrl",windowClass:"docPreModal",resolve:{article:function(){return articlePreview}}})}}),app.controller("previewModalInstanceCtrl",function($scope,$modalInstance,article,$sce){$scope.article=article,$scope.article.content=$sce.trustAsHtml($scope.article.content),$scope.cancel=function(){$modalInstance.dismiss("cancel")}});