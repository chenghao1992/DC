app.controller("DocSendMsgCtrl",function($scope,$timeout,utils,$http,$modal,Upload,toaster,$state,$stateParams){var userName=localStorage.getItem("user_name"),access_token=localStorage.getItem("access_token");$scope.titleLength=0,$scope.formData={},$scope.formData.patients=[],$scope.fontImg=null,$scope.fontImgUrl=null,$scope.copy_small=null,$scope.isSaved=!1;var um=null;$http({url:serverApiRoot+"vpanfile/getUploadToken",method:"post",data:{access_token:access_token,bucket:"resource"}}).then(function(response){var rep=response.data;rep&&1==rep.resultCode&&rep.data&&rep.data.token&&rep.data.domain?um=UM.getEditor("myEditor",{initialFrameWidth:"100%",initialFrameHeight:300,qiniuToken:rep.data.token,qiniuDomain:rep.data.domain}):console.error(rep)}),$scope.$on("$destroy",function(){um.destroy()}),$scope.$watch("formData.title",function(newValue,oldValue){newValue!=oldValue&&($scope.formData.title?$scope.titleLength=$scope.formData.title.length:$scope.titleLength=0)}),$scope.qiniuFilters={mime_types:[{title:"Image files",extensions:"jpg,gif,png"}]},$scope.selectFile=function(){$scope.upload()},$scope.token=app.url.access_token,$scope.uploaderAdded=function(up,files){$scope.uploadPercent=0,console.log(up,files)},$scope.uploaderSuccess=function(up,file,info){$scope.fontImgUrl=file.url,$scope.copy_small=file.url+"?imageView2/3/w/200/h/200",$scope.uploadPercent=100,toaster.pop("success",null,"封面修改成功！")},$scope.uploaderError=function(up,err,errTip){err.code==-600?toaster.pop("error",null,"文件过大"):toaster.pop("error",null,errTip)},$scope.fileUploadProcess=function(up,file){$scope.uploadPercent=100==file.percent?99:file.percent},$scope.sendMsg=function(){var tagsId=[];if(!$scope.formData.title)return void toaster.pop("warn","","请填写标题");if(!$scope.fontImgUrl)return void toaster.pop("warn","","请上传题图");var html=um.getContent();if(html.length<=0)return void toaster.pop("warn","","请填写正文");null!=$scope.formData.patients&&$scope.formData.patients.length>0&&$scope.formData.patients.forEach(function(item,index,array){tagsId.push(item.id)}),$scope.isSaved=!0;var mptList=[{title:$scope.formData.title,pic:$scope.fontImgUrl,content:html}],sendMsgParam={access_token:app.url.access_token,pubId:$stateParams.id,userId:localStorage.getItem("user_id"),toAll:!0,sendType:2,model:2,toNews:!0,mpt:mptList};$http({method:"POST",url:app.url.pubMsg.sendMsg,data:JSON.stringify(sendMsgParam),headers:{"access-token":app.url.access_token,"Content-Type":"application/json"}}).success(function(data,status,headers,config){1==data.resultCode?(toaster.pop("success","","发送成功,3秒钟后返回历史消息列表"),setTimeout(function(){$state.go("app.public_msg.doctor.msg_manage.msg_history",{},{reload:!0})},3e3)):($scope.isSaved=!1,toaster.pop("error","",data.resultMsg))}).error(function(data,status,headers,config){$scope.isSaved=!1,toaster.pop("error","","内部接口异常")})},$scope.preview=function(){if(!$scope.formData.title)return void toaster.pop("warn","","请填写标题");if(!$scope.fontImgUrl)return void toaster.pop("warn","","请上传题图");var html=um.getContent();if(html.length<=0)return void toaster.pop("warn","","请填写正文");var msg={title:$scope.formData.title,fontImgUrl:$scope.fontImgUrl,content:html,time:utils.dateFormat(new Date,"yyyy-MM-dd"),author:userName};$modal.open({templateUrl:"previewModalContent.html",controller:"previewModalInstanceCtrl",windowClass:"docPreModal",resolve:{msg:function(){return msg}}})}}),app.controller("previewModalInstanceCtrl",function($scope,$modalInstance,msg,$sce){$scope.msg=msg,$scope.msg.content=$sce.trustAsHtml($scope.msg.content),$scope.cancel=function(){$modalInstance.dismiss("cancel")}});