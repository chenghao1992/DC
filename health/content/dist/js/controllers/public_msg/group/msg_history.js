app.controller("MsgHistoryCtrl",function($scope,$timeout,utils,$http,$modal,toaster,$location,$state,$stateParams){function initMsgHistory(){var index=1,length=10,start=0,size=10,setTable=function(){docArticleTable=$("#msg_history").DataTable({language:app.lang.datatables.translation,searching:!1,destroy:!0,lengthChange:!0,ordering:!1,draw:1,pageLength:length,lengthMenu:[5,10,20,50],autoWidth:!1,displayStart:start,bServerSide:!0,sAjaxSource:app.url.pubMsg.getMsgPageList,fnServerData:function(sSource,aoData,fnCallback){$.ajax({type:"post",url:sSource,dataType:"json",data:params,success:function(resp){if(1==resp.resultCode){var data={};data.recordsTotal=resp.data.total,data.recordsFiltered=resp.data.total,data.length=resp.data.pageSize,data.data=resp.data.pageData,size=aoData[4].value,fnCallback(data)}else console.log(resp.resultMsg)}})},columns:[{render:function(set,status,dt){return dt.sendTime?utils.dateFormat(dt.sendTime,"yyyy-MM-dd hh:mm"):(console.log("少了参数sendTime"),"")}},{render:function(set,status,dt){return dt.mpt?'<span class="text-left"><p class="m-b-sm text-md">'+dt.mpt[0].title+'</p><p class="text-muted">'+dt.mpt[0].digest+"</p></span>":(console.log("少了参数mpt"),"")}},{render:function(set,status,dt){return dt.author?dt.author:""}},{render:function(set,status,dt){return'<button class="btn btn-danger btn-xs" id="delMsgHistory">删除</button>'}}],createdRow:function(nRow,aData,iDataIndex){$(nRow).on("click","#delMsgHistory",function(event){delMsgHistory(aData.id),event.stopPropagation()})}}),docArticleTable.off("page.dt").on("page.dt",function(e,settings){console.log("分页分页分页"),index=docArticleTable.page.info().page+1,start=length*(index-1),params.pageIndex=index}).on("length.dt",function(e,settings,len){length=len,index=1,start=0,params.pageIndex=1,params.pageSize=len})};setTable()}var docArticleTable,params={access_token:app.url.access_token,pid:$stateParams.id,pageIndex:1,pageSize:10},delMsgHistory=function(msgId){var modalInstance=$modal.open({templateUrl:"delModalContent.html",controller:"delModalInstanceCtrl",size:"sm"});modalInstance.result.then(function(status){"ok"==status&&$http.post(app.url.pubMsg.delMsgHistory,{access_token:app.url.access_token,id:msgId}).success(function(data,status,headers,config){1==data.resultCode?(params.pageIndex=1,params.pageSize=10,initMsgHistory()):alert(data.resultMsg)}).error(function(data,status,headers,config){alert(data.resultMsg)})},function(){})};initMsgHistory()}),app.controller("delModalInstanceCtrl",function($scope,$modalInstance,toaster,$http,utils){$scope.ok=function(){$modalInstance.close("ok")},$scope.cancel=function(){$modalInstance.dismiss("cancel")}});