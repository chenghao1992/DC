"use strict";app.controller("groupSettingsCtrl",["$rootScope","$scope","$modal","$log","$http","$state","$stateParams","utils","toaster",function($rootScope,$scope,$modal,$log,$http,$state,$stateParams,utils,toaster){function getGroupInfo(id){$http.post(app.url.yiliao.getGroupInfo,{access_token:app.url.access_token,id:id}).success(function(data){if(1===data.resultCode){var group=data.data;$scope.groupName=name||group.name,$scope.groupInfo=group.introduction,group.config&&($scope.amemberInvite=String(group.config.memberInvite),$scope.parentProfit=group.config.parentProfit,$scope.groupProfit=group.config.groupProfit)}else toaster.pop("error",null,data.resultMsg)}).error(function(data){toaster.pop("error",null,data.resultMsg)})}$scope.financialState=!0,$scope.amemberInvite="false";var companyId,regOrUpdate,groupId=localStorage.getItem("curGroupId");if(localStorage.getItem("company")){var company=JSON.parse(localStorage.getItem("company"));companyId=company.id,utils.localData("user_id",null)}else localStorage.getItem("user_id")&&(companyId="",$rootScope.rootGroup.enterpriseName,utils.localData("enterprise_id",null));groupId?(getGroupInfo(groupId),regOrUpdate="update"):regOrUpdate="reg",$scope.submitBt=function(){return"reg"==regOrUpdate?$scope.regGroup():"update"==regOrUpdate?$scope.updateGroup(groupId):void 0},$scope.regGroup=function(){$http.post(app.url.yiliao.regGroup,{access_token:app.url.access_token,companyId:companyId,name:$scope.groupName,introduction:$scope.groupInfo,"config.memberInvite":$scope.amemberInvite,"config.parentProfit":$scope.parentProfit,"config.groupProfit":$scope.groupProfit}).success(function(data){1===data.resultCode?(utils.localData("curGroupId",data.data.id),utils.localData("curGroupName",data.data.name),$rootScope.rootGroup.name=localStorage.getItem("curGroupName"),$state.go("app.groupLogo")):toaster.pop("error",null,data.resultMsg)}).error(function(data){toaster.pop("error",null,data.resultMsg)})},$scope.updateGroup=function(groupId){$http.post(app.url.yiliao.updateGroup,{access_token:app.url.access_token,id:groupId,name:$scope.groupName,introduction:$scope.groupInfo,"config.memberInvite":$scope.amemberInvite,"config.parentProfit":$scope.parentProfit,"config.groupProfit":$scope.groupProfit}).success(function(data){1===data.resultCode?(console.log(data),utils.localData("curGroupName",data.data.name),$rootScope.rootGroup.name=localStorage.getItem("curGroupName"),toaster.pop("success",null,"修改成功！")):toaster.pop("error",null,data.resultMsg)}).error(function(data){$scope.authError=data.resultMsg})}}]),app.controller("groupLogoSettingsCtrl",["$scope","$modal","$log","$http","Upload","$stateParams","$state","toaster","utils",function($scope,$modal,$log,$http,Upload,$stateParams,$state,toaster,utils){function goUpload(files,fileName,certType){if(null!=files){angular.isArray(files)||(files=[files]);for(var i=0;i<files.length;i++)$scope.errorMsg=null,function(f,fileName,certType){upload(f,fileName,certType)}(files[i],fileName,certType)}}function upload(file,fileName,certType){return"noPic"===creatorId?toaster.pop("error",null,"未找到原头像！"):(file.upload=Upload.upload({url:app.url.upload.upLoadImg,file:file,fileName:fileName,fields:{userId:creatorId,access_token:app.url.access_token,certType:certType,fileName:fileName}}),file.upload.progress(function(evt){file.progress=Math.min(100,parseInt(100*evt.loaded/evt.total))}),file.upload.success(function(response){response.data.oUrl?($scope.datas.groupPicFile=response.data.oUrl+"?"+(new Date).getTime(),utils.localData("groupPicFile",response.data.oUrl)):($scope.datas.groupPicFile="src/img/logoDefault.jpg?"+(new Date).getTime(),utils.localData("groupPicFile",null)),console.log(creatorId),console.log(certType),console.log(fileName),console.log(response),file.result="修改成功！",toaster.pop("success",null,"头像修改成功！")}),void file.upload.error(function(response){console.log(response),$scope.authError="修改失败！",toaster.pop("error",null,"修改失败！")}))}var groupId=localStorage.getItem("curGroupId");groupId&&($scope.logoUpdate=!0);var creatorId="noPic";!function(){$http.post(app.url.yiliao.getGroupInfo,{access_token:app.url.access_token,id:groupId}).success(function(data){if(1===data.resultCode){creatorId=data.data.creator;var imgUrl=app.url.upload.getCertPath+"?access_token="+app.url.access_token+"&userId="+creatorId+"&certType="+groupId;console.log(imgUrl),function(imgUrl){$http.get(imgUrl).success(function(data){1===data.resultCode?$scope.groupLogoUrl=data.data[0]+"?"+Math.random():($scope.authError=data.resultMsg,$scope.groupLogoUrl="#")}).error(function(data){$scope.authError=data.resultMsg})}(imgUrl)}else console.log(data.resultMsg)}).error(function(data){console.log(data.resultMsg)})}(),$scope.$watch("groupLogo",function(files){goUpload(files,"groupLogo",groupId)})}]);