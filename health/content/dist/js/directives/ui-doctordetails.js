app.directive("doctorDetails",["uiLoad","JQ_CONFIG","$document","$http","Doctor","$state","$stateParams",function(uiLoad,JQ_CONFIG,$document,$http,Doctor,$state,$stateParams){return{restrict:"E",templateUrl:"src/tpl/directives/doctor_details.html",link:function(scope,el,attr){function watch(){if(scope.$root){if(scope.$root.winVisable){clearInterval(timer),html.css("overflow","hidden");var tab_first=el.find(".tab-container li").first();tab_first.hasClass("active")?scope.tabs.show():tab_first.children("a").trigger("click")}}else clearInterval(timer)}scope.$root.winVisable=!1;var timer=setInterval(watch,200);scope.tabs={},scope.viewData={},scope.imgs=!1,scope.isNormal=!1,scope.isQuit=!0,scope.apportion=function(id){$state.go("app.contacts.list.apportion")},scope.quit=function(id){$state.go("app.contacts.list.quit")};var data={},html=$("html");scope.tabs.show=function(){function createSchedule(dt){var times=[[],[],[]];if(dt){var dates=dt,m=0,n=0;if(dates)for(var i=0;i<dates.length;i++)if(m=1*dates[i].period,n=1*dates[i].week,dates[i].startTime&&dates[i].endTime){var start=dates[i].startTime.substr(0,2)+":"+dates[i].startTime.substr(2,2),end=dates[i].endTime.substr(0,2)+":"+dates[i].endTime.substr(2,2);times[m-1][n%7]=start+"-"+end}}for(var days=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],table=$("<table></table>"),thead=$("<thead></thead>"),tbody=$("<tbody></tbody>"),i=0;i<4;i++){for(var tr=$("<tr></tr>"),j=0;j<7;j++){var td=$("<td></td>");0===i?td.html(days[j]):times[i-1]&&times[i-1][j]?td.html(times[i-1][j]):td.html("&nbsp;"),tr.append(td)}0===i?thead.append(tr):tbody.append(tr)}table.append(thead).append(tbody),$("#duty_schedule").html("").append(table)}data=Doctor.getData(),Doctor.getAsyncData(function(data){if(data){scope.viewData.headPicFile=data.headPic,scope.viewData.name=data.name,scope.viewData.info=data.info,scope.viewData.contactWay=data.contactWay,scope.viewData.introduction=data.introduction,scope.viewData.skill=data.skill,scope.viewData.relation=data.relation,scope.viewData.remarks=data.remarks,"I"===data.status?(scope.isNormal=!1,scope.isQuit=!0):"C"===data.status?(scope.isNormal=!0,deptId&&(scope.isQuit=!1)):"S"===data.status?(scope.isNormal=!1,scope.isQuit=!0):deptId?(scope.isNormal=!0,scope.isQuit=!1):(scope.isNormal=!1,scope.isQuit=!0);var deptId=data.departmentId;deptId?$http({url:app.url.yiliao.getSchedule,method:"post",data:{access_token:app.url.access_token,doctorId:data.doctorId}}).then(function(resp){if(1===resp.data.resultCode&&resp.data.data.online){var dt=resp.data.data.online;createSchedule(dt)}else createSchedule(null)},function(x){console.error(x.statusText)}):createSchedule(null)}})},scope.tabs.select=function(){return scope.imgs?void(scope.isLoading=!1):(scope.isLoading=!0,void $http.get(app.url.upload.getCertPath+"?"+$.param({userId:data.doctorId,access_token:app.url.access_token})).then(function(dt){dt=dt.data.data,dt&&dt.length>0?scope.imgs=dt:scope.imgs=!1,scope.isLoading=!1}))},scope.tabs.otherInfo=function(){return scope.viewData.inviteCode="http://112.74.208.140/appInvite/joinToGroup.html?groupId="+data.groupId+"&doctorId="+data.doctorId,scope.isLoading=!1,scope.info?void(scope.isLoading=!1):(scope.isLoading=!0,void $http({url:app.url.yiliao.getUserDetail,data:{userId:data.doctorId,access_token:app.url.access_token},method:"post"}).then(function(dt){dt=dt.data.data,dt&&dt.length>0?scope.info=dt:scope.info=!1,scope.isLoading=!1}))},scope.save=function(){$http({url:app.url.yiliao.updateDoctor,method:"post",data:{access_token:app.url.access_token,id:data.groupDoctorId,contactWay:scope.viewData.contactWay||"--",remarks:scope.viewData.remarks||"--"}}).then(function(resp){if(1===resp.data.resultCode){scope.cancel();var href=window.location.hash.substring(2).replace(/\//g,".");if($stateParams){var idx=href.lastIndexOf(".");href=href.substring(0,idx),$state.go(href,{id:(new Date).getTime()},{reload:!1})}}},function(x){console.error(x.statusText)})},scope.cancel=function(){scope.imgs=null,scope.$root.winVisable=!1,timer=setInterval(watch,200),el.addClass("hide"),html.css("overflow","auto")}},post:function(){console.log("---------------->")}}}]).controller("RelationshipEdit",function($scope,$http){});